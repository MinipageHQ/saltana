/*! For license information please see vendors~proGallery_HlsPlayer.e7caa125.iframe.bundle.js.LICENSE.txt */
(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{1868:function(module,exports,__webpack_require__){"undefined"!=typeof window&&function webpackUniversalModuleDefinition(root,factory){module.exports=factory()}(0,(function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module.default}:function getModuleExports(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="/dist/",__webpack_require__(__webpack_require__.s="./src/hls.ts")}({"./node_modules/eventemitter3/index.js":function(module,exports,__webpack_require__){"use strict";var has=Object.prototype.hasOwnProperty,prefix="~";function Events(){}function EE(fn,context,once){this.fn=fn,this.context=context,this.once=once||!1}function addListener(emitter,event,fn,context,once){if("function"!=typeof fn)throw new TypeError("The listener must be a function");var listener=new EE(fn,context||emitter,once),evt=prefix?prefix+event:event;return emitter._events[evt]?emitter._events[evt].fn?emitter._events[evt]=[emitter._events[evt],listener]:emitter._events[evt].push(listener):(emitter._events[evt]=listener,emitter._eventsCount++),emitter}function clearEvent(emitter,evt){0==--emitter._eventsCount?emitter._events=new Events:delete emitter._events[evt]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(prefix=!1)),EventEmitter.prototype.eventNames=function eventNames(){var events,name,names=[];if(0===this._eventsCount)return names;for(name in events=this._events)has.call(events,name)&&names.push(prefix?name.slice(1):name);return Object.getOwnPropertySymbols?names.concat(Object.getOwnPropertySymbols(events)):names},EventEmitter.prototype.listeners=function listeners(event){var evt=prefix?prefix+event:event,handlers=this._events[evt];if(!handlers)return[];if(handlers.fn)return[handlers.fn];for(var i=0,l=handlers.length,ee=new Array(l);i<l;i++)ee[i]=handlers[i].fn;return ee},EventEmitter.prototype.listenerCount=function listenerCount(event){var evt=prefix?prefix+event:event,listeners=this._events[evt];return listeners?listeners.fn?1:listeners.length:0},EventEmitter.prototype.emit=function emit(event,a1,a2,a3,a4,a5){var evt=prefix?prefix+event:event;if(!this._events[evt])return!1;var args,i,listeners=this._events[evt],len=arguments.length;if(listeners.fn){switch(listeners.once&&this.removeListener(event,listeners.fn,void 0,!0),len){case 1:return listeners.fn.call(listeners.context),!0;case 2:return listeners.fn.call(listeners.context,a1),!0;case 3:return listeners.fn.call(listeners.context,a1,a2),!0;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),!0;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),!0;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),!0}for(i=1,args=new Array(len-1);i<len;i++)args[i-1]=arguments[i];listeners.fn.apply(listeners.context,args)}else{var j,length=listeners.length;for(i=0;i<length;i++)switch(listeners[i].once&&this.removeListener(event,listeners[i].fn,void 0,!0),len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;case 4:listeners[i].fn.call(listeners[i].context,a1,a2,a3);break;default:if(!args)for(j=1,args=new Array(len-1);j<len;j++)args[j-1]=arguments[j];listeners[i].fn.apply(listeners[i].context,args)}}return!0},EventEmitter.prototype.on=function on(event,fn,context){return addListener(this,event,fn,context,!1)},EventEmitter.prototype.once=function once(event,fn,context){return addListener(this,event,fn,context,!0)},EventEmitter.prototype.removeListener=function removeListener(event,fn,context,once){var evt=prefix?prefix+event:event;if(!this._events[evt])return this;if(!fn)return clearEvent(this,evt),this;var listeners=this._events[evt];if(listeners.fn)listeners.fn!==fn||once&&!listeners.once||context&&listeners.context!==context||clearEvent(this,evt);else{for(var i=0,events=[],length=listeners.length;i<length;i++)(listeners[i].fn!==fn||once&&!listeners[i].once||context&&listeners[i].context!==context)&&events.push(listeners[i]);events.length?this._events[evt]=1===events.length?events[0]:events:clearEvent(this,evt)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(event){var evt;return event?(evt=prefix?prefix+event:event,this._events[evt]&&clearEvent(this,evt)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,module.exports=EventEmitter},"./node_modules/url-toolkit/src/url-toolkit.js":function(module,exports,__webpack_require__){var URL_REGEX,FIRST_SEGMENT_REGEX,SLASH_DOT_REGEX,SLASH_DOT_DOT_REGEX,URLToolkit;URL_REGEX=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/?#]*\/)*[^;?#]*)?(;[^?#]*)?(\?[^#]*)?(#.*)?$/,FIRST_SEGMENT_REGEX=/^([^\/?#]*)(.*)$/,SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g,SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,URLToolkit={buildAbsoluteURL:function(baseURL,relativeURL,opts){if(opts=opts||{},baseURL=baseURL.trim(),!(relativeURL=relativeURL.trim())){if(!opts.alwaysNormalize)return baseURL;var basePartsForNormalise=URLToolkit.parseURL(baseURL);if(!basePartsForNormalise)throw new Error("Error trying to parse base URL.");return basePartsForNormalise.path=URLToolkit.normalizePath(basePartsForNormalise.path),URLToolkit.buildURLFromParts(basePartsForNormalise)}var relativeParts=URLToolkit.parseURL(relativeURL);if(!relativeParts)throw new Error("Error trying to parse relative URL.");if(relativeParts.scheme)return opts.alwaysNormalize?(relativeParts.path=URLToolkit.normalizePath(relativeParts.path),URLToolkit.buildURLFromParts(relativeParts)):relativeURL;var baseParts=URLToolkit.parseURL(baseURL);if(!baseParts)throw new Error("Error trying to parse base URL.");if(!baseParts.netLoc&&baseParts.path&&"/"!==baseParts.path[0]){var pathParts=FIRST_SEGMENT_REGEX.exec(baseParts.path);baseParts.netLoc=pathParts[1],baseParts.path=pathParts[2]}baseParts.netLoc&&!baseParts.path&&(baseParts.path="/");var builtParts={scheme:baseParts.scheme,netLoc:relativeParts.netLoc,path:null,params:relativeParts.params,query:relativeParts.query,fragment:relativeParts.fragment};if(!relativeParts.netLoc&&(builtParts.netLoc=baseParts.netLoc,"/"!==relativeParts.path[0]))if(relativeParts.path){var baseURLPath=baseParts.path,newPath=baseURLPath.substring(0,baseURLPath.lastIndexOf("/")+1)+relativeParts.path;builtParts.path=URLToolkit.normalizePath(newPath)}else builtParts.path=baseParts.path,relativeParts.params||(builtParts.params=baseParts.params,relativeParts.query||(builtParts.query=baseParts.query));return null===builtParts.path&&(builtParts.path=opts.alwaysNormalize?URLToolkit.normalizePath(relativeParts.path):relativeParts.path),URLToolkit.buildURLFromParts(builtParts)},parseURL:function(url){var parts=URL_REGEX.exec(url);return parts?{scheme:parts[1]||"",netLoc:parts[2]||"",path:parts[3]||"",params:parts[4]||"",query:parts[5]||"",fragment:parts[6]||""}:null},normalizePath:function(path){for(path=path.split("").reverse().join("").replace(SLASH_DOT_REGEX,"");path.length!==(path=path.replace(SLASH_DOT_DOT_REGEX,"")).length;);return path.split("").reverse().join("")},buildURLFromParts:function(parts){return parts.scheme+parts.netLoc+parts.path+parts.params+parts.query+parts.fragment}},module.exports=URLToolkit},"./node_modules/webworkify-webpack/index.js":function(module,exports,__webpack_require__){function webpackBootstrapFunc(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.i=function(value){return value},__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{configurable:!1,enumerable:!0,get:getter})},__webpack_require__.r=function(exports){Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module.default}:function getModuleExports(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="/",__webpack_require__.oe=function(err){throw console.error(err),err};var f=__webpack_require__(__webpack_require__.s=ENTRY_MODULE);return f.default||f}function quoteRegExp(str){return(str+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function getModuleDependencies(sources,module,queueName){var retval={};retval[queueName]=[];var fnString=module.toString(),wrapperSignature=fnString.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!wrapperSignature)return retval;for(var match,webpackRequireName=wrapperSignature[1],re=new RegExp("(\\\\n|\\W)"+quoteRegExp(webpackRequireName)+"\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)","g");match=re.exec(fnString);)"dll-reference"!==match[3]&&retval[queueName].push(match[3]);for(re=new RegExp("\\("+quoteRegExp(webpackRequireName)+'\\("(dll-reference\\s([\\.|\\-|\\+|\\w|/|@]+))"\\)\\)\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)',"g");match=re.exec(fnString);)sources[match[2]]||(retval[queueName].push(match[1]),sources[match[2]]=__webpack_require__(match[1]).m),retval[match[2]]=retval[match[2]]||[],retval[match[2]].push(match[4]);for(var n,keys=Object.keys(retval),i=0;i<keys.length;i++)for(var j=0;j<retval[keys[i]].length;j++)n=retval[keys[i]][j],isNaN(1*n)||(retval[keys[i]][j]=1*retval[keys[i]][j]);return retval}function hasValuesInQueues(queues){return Object.keys(queues).reduce((function(hasValues,key){return hasValues||queues[key].length>0}),!1)}module.exports=function(moduleId,options){options=options||{};var sources={main:__webpack_require__.m},requiredModules=options.all?{main:Object.keys(sources.main)}:function getRequiredModules(sources,moduleId){for(var modulesQueue={main:[moduleId]},requiredModules={main:[]},seenModules={main:{}};hasValuesInQueues(modulesQueue);)for(var queues=Object.keys(modulesQueue),i=0;i<queues.length;i++){var queueName=queues[i],moduleToCheck=modulesQueue[queueName].pop();if(seenModules[queueName]=seenModules[queueName]||{},!seenModules[queueName][moduleToCheck]&&sources[queueName][moduleToCheck]){seenModules[queueName][moduleToCheck]=!0,requiredModules[queueName]=requiredModules[queueName]||[],requiredModules[queueName].push(moduleToCheck);for(var newModules=getModuleDependencies(sources,sources[queueName][moduleToCheck],queueName),newModulesKeys=Object.keys(newModules),j=0;j<newModulesKeys.length;j++)modulesQueue[newModulesKeys[j]]=modulesQueue[newModulesKeys[j]]||[],modulesQueue[newModulesKeys[j]]=modulesQueue[newModulesKeys[j]].concat(newModules[newModulesKeys[j]])}}return requiredModules}(sources,moduleId),src="";Object.keys(requiredModules).filter((function(m){return"main"!==m})).forEach((function(module){for(var entryModule=0;requiredModules[module][entryModule];)entryModule++;requiredModules[module].push(entryModule),sources[module][entryModule]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",src=src+"var "+module+" = ("+webpackBootstrapFunc.toString().replace("ENTRY_MODULE",JSON.stringify(entryModule))+")({"+requiredModules[module].map((function(id){return JSON.stringify(id)+": "+sources[module][id].toString()})).join(",")+"});\n"})),src=src+"new (("+webpackBootstrapFunc.toString().replace("ENTRY_MODULE",JSON.stringify(moduleId))+")({"+requiredModules.main.map((function(id){return JSON.stringify(id)+": "+sources.main[id].toString()})).join(",")+"}))(self);";var blob=new window.Blob([src],{type:"text/javascript"});if(options.bare)return blob;var workerUrl=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(blob),worker=new window.Worker(workerUrl);return worker.objectURL=workerUrl,worker}},"./src/crypt/decrypter.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var AESCrypto=function(){function AESCrypto(subtle,iv){this.subtle=subtle,this.aesIV=iv}return AESCrypto.prototype.decrypt=function decrypt(data,key){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},key,data)},AESCrypto}(),fast_aes_key=function(){function FastAESKey(subtle,key){this.subtle=subtle,this.key=key}return FastAESKey.prototype.expandKey=function expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},FastAESKey}();var aes_decryptor=function(){function AESDecryptor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}var _proto=AESDecryptor.prototype;return _proto.uint8ArrayToUint32Array_=function uint8ArrayToUint32Array_(arrayBuffer){for(var view=new DataView(arrayBuffer),newArray=new Uint32Array(4),i=0;i<4;i++)newArray[i]=view.getUint32(4*i);return newArray},_proto.initTable=function initTable(){var sBox=this.sBox,invSBox=this.invSBox,subMix=this.subMix,subMix0=subMix[0],subMix1=subMix[1],subMix2=subMix[2],subMix3=subMix[3],invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3],d=new Uint32Array(256),x=0,xi=0,i=0;for(i=0;i<256;i++)d[i]=i<128?i<<1:i<<1^283;for(i=0;i<256;i++){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,sBox[x]=sx,invSBox[sx]=x;var x2=d[x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;subMix0[x]=t<<24|t>>>8,subMix1[x]=t<<16|t>>>16,subMix2[x]=t<<8|t>>>24,subMix3[x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,invSubMix0[sx]=t<<24|t>>>8,invSubMix1[sx]=t<<16|t>>>16,invSubMix2[sx]=t<<8|t>>>24,invSubMix3[sx]=t,x?(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]]):x=xi=1}},_proto.expandKey=function expandKey(keyBuffer){for(var key=this.uint8ArrayToUint32Array_(keyBuffer),sameKey=!0,offset=0;offset<key.length&&sameKey;)sameKey=key[offset]===this.key[offset],offset++;if(!sameKey){this.key=key;var keySize=this.keySize=key.length;if(4!==keySize&&6!==keySize&&8!==keySize)throw new Error("Invalid aes key size="+keySize);var ksRow,invKsRow,prev,t,ksRows=this.ksRows=4*(keySize+6+1),keySchedule=this.keySchedule=new Uint32Array(ksRows),invKeySchedule=this.invKeySchedule=new Uint32Array(ksRows),sbox=this.sBox,rcon=this.rcon,invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3];for(ksRow=0;ksRow<ksRows;ksRow++)ksRow<keySize?prev=keySchedule[ksRow]=key[ksRow]:(t=prev,ksRow%keySize==0?(t=sbox[(t=t<<8|t>>>24)>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t],t^=rcon[ksRow/keySize|0]<<24):keySize>6&&ksRow%keySize==4&&(t=sbox[t>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t]),keySchedule[ksRow]=prev=(keySchedule[ksRow-keySize]^t)>>>0);for(invKsRow=0;invKsRow<ksRows;invKsRow++)ksRow=ksRows-invKsRow,t=3&invKsRow?keySchedule[ksRow]:keySchedule[ksRow-4],invKeySchedule[invKsRow]=invKsRow<4||ksRow<=4?t:invSubMix0[sbox[t>>>24]]^invSubMix1[sbox[t>>>16&255]]^invSubMix2[sbox[t>>>8&255]]^invSubMix3[sbox[255&t]],invKeySchedule[invKsRow]=invKeySchedule[invKsRow]>>>0}},_proto.networkToHostOrderSwap=function networkToHostOrderSwap(word){return word<<24|(65280&word)<<8|(16711680&word)>>8|word>>>24},_proto.decrypt=function decrypt(inputArrayBuffer,offset,aesIV,removePKCS7Padding){for(var t0,t1,t2,t3,s0,s1,s2,s3,inputWords0,inputWords1,inputWords2,inputWords3,ksRow,i,nRounds=this.keySize+6,invKeySchedule=this.invKeySchedule,invSBOX=this.invSBox,invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3],initVector=this.uint8ArrayToUint32Array_(aesIV),initVector0=initVector[0],initVector1=initVector[1],initVector2=initVector[2],initVector3=initVector[3],inputInt32=new Int32Array(inputArrayBuffer),outputInt32=new Int32Array(inputInt32.length),swapWord=this.networkToHostOrderSwap;offset<inputInt32.length;){for(inputWords0=swapWord(inputInt32[offset]),inputWords1=swapWord(inputInt32[offset+1]),inputWords2=swapWord(inputInt32[offset+2]),inputWords3=swapWord(inputInt32[offset+3]),s0=inputWords0^invKeySchedule[0],s1=inputWords3^invKeySchedule[1],s2=inputWords2^invKeySchedule[2],s3=inputWords1^invKeySchedule[3],ksRow=4,i=1;i<nRounds;i++)t0=invSubMix0[s0>>>24]^invSubMix1[s1>>16&255]^invSubMix2[s2>>8&255]^invSubMix3[255&s3]^invKeySchedule[ksRow],t1=invSubMix0[s1>>>24]^invSubMix1[s2>>16&255]^invSubMix2[s3>>8&255]^invSubMix3[255&s0]^invKeySchedule[ksRow+1],t2=invSubMix0[s2>>>24]^invSubMix1[s3>>16&255]^invSubMix2[s0>>8&255]^invSubMix3[255&s1]^invKeySchedule[ksRow+2],t3=invSubMix0[s3>>>24]^invSubMix1[s0>>16&255]^invSubMix2[s1>>8&255]^invSubMix3[255&s2]^invKeySchedule[ksRow+3],s0=t0,s1=t1,s2=t2,s3=t3,ksRow+=4;t0=invSBOX[s0>>>24]<<24^invSBOX[s1>>16&255]<<16^invSBOX[s2>>8&255]<<8^invSBOX[255&s3]^invKeySchedule[ksRow],t1=invSBOX[s1>>>24]<<24^invSBOX[s2>>16&255]<<16^invSBOX[s3>>8&255]<<8^invSBOX[255&s0]^invKeySchedule[ksRow+1],t2=invSBOX[s2>>>24]<<24^invSBOX[s3>>16&255]<<16^invSBOX[s0>>8&255]<<8^invSBOX[255&s1]^invKeySchedule[ksRow+2],t3=invSBOX[s3>>>24]<<24^invSBOX[s0>>16&255]<<16^invSBOX[s1>>8&255]<<8^invSBOX[255&s2]^invKeySchedule[ksRow+3],ksRow+=3,outputInt32[offset]=swapWord(t0^initVector0),outputInt32[offset+1]=swapWord(t3^initVector1),outputInt32[offset+2]=swapWord(t2^initVector2),outputInt32[offset+3]=swapWord(t1^initVector3),initVector0=inputWords0,initVector1=inputWords1,initVector2=inputWords2,initVector3=inputWords3,offset+=4}return removePKCS7Padding?function removePadding(buffer){var outputBytes=buffer.byteLength,paddingBytes=outputBytes&&new DataView(buffer).getUint8(outputBytes-1);return paddingBytes?buffer.slice(0,outputBytes-paddingBytes):buffer}(outputInt32.buffer):outputInt32.buffer},_proto.destroy=function destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0},AESDecryptor}(),errors=__webpack_require__("./src/errors.ts"),logger=__webpack_require__("./src/utils/logger.js"),events=__webpack_require__("./src/events.js"),get_self_scope=__webpack_require__("./src/utils/get-self-scope.js"),global=Object(get_self_scope.getSelfScope)(),decrypter_Decrypter=function(){function Decrypter(observer,config,_temp){var _ref$removePKCS7Paddi=(void 0===_temp?{}:_temp).removePKCS7Padding,removePKCS7Padding=void 0===_ref$removePKCS7Paddi||_ref$removePKCS7Paddi;if(this.logEnabled=!0,this.observer=observer,this.config=config,this.removePKCS7Padding=removePKCS7Padding,removePKCS7Padding)try{var browserCrypto=global.crypto;browserCrypto&&(this.subtle=browserCrypto.subtle||browserCrypto.webkitSubtle)}catch(e){}this.disableWebCrypto=!this.subtle}var _proto=Decrypter.prototype;return _proto.isSync=function isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES},_proto.decrypt=function decrypt(data,key,iv,callback){var _this=this;if(this.disableWebCrypto&&this.config.enableSoftwareAES){this.logEnabled&&(logger.logger.log("JS AES decrypt"),this.logEnabled=!1);var decryptor=this.decryptor;decryptor||(this.decryptor=decryptor=new aes_decryptor),decryptor.expandKey(key),callback(decryptor.decrypt(data,0,iv,this.removePKCS7Padding))}else{this.logEnabled&&(logger.logger.log("WebCrypto AES decrypt"),this.logEnabled=!1);var subtle=this.subtle;this.key!==key&&(this.key=key,this.fastAesKey=new fast_aes_key(subtle,key)),this.fastAesKey.expandKey().then((function(aesKey){new AESCrypto(subtle,iv).decrypt(data,aesKey).catch((function(err){_this.onWebCryptoError(err,data,key,iv,callback)})).then((function(result){callback(result)}))})).catch((function(err){_this.onWebCryptoError(err,data,key,iv,callback)}))}},_proto.onWebCryptoError=function onWebCryptoError(err,data,key,iv,callback){this.config.enableSoftwareAES?(logger.logger.log("WebCrypto Error, disable WebCrypto API"),this.disableWebCrypto=!0,this.logEnabled=!0,this.decrypt(data,key,iv,callback)):(logger.logger.error("decrypting error : "+err.message),this.observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.FRAG_DECRYPT_ERROR,fatal:!0,reason:err.message}))},_proto.destroy=function destroy(){var decryptor=this.decryptor;decryptor&&(decryptor.destroy(),this.decryptor=void 0)},Decrypter}();__webpack_exports__.default=decrypter_Decrypter},"./src/demux/demuxer-inline.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var events=__webpack_require__("./src/events.js"),errors=__webpack_require__("./src/errors.ts"),crypt_decrypter=__webpack_require__("./src/crypt/decrypter.js"),number=__webpack_require__("./src/polyfills/number.js"),logger=__webpack_require__("./src/utils/logger.js"),get_self_scope=__webpack_require__("./src/utils/get-self-scope.js");function isHeaderPattern(data,offset){return 255===data[offset]&&240==(246&data[offset+1])}function getHeaderLength(data,offset){return 1&data[offset+1]?7:9}function getFullFrameLength(data,offset){return(3&data[offset+3])<<11|data[offset+4]<<3|(224&data[offset+5])>>>5}function isHeader(data,offset){return!!(offset+1<data.length&&isHeaderPattern(data,offset))}function adts_probe(data,offset){if(isHeader(data,offset)){var headerLength=getHeaderLength(data,offset);if(offset+headerLength>=data.length)return!1;var frameLength=getFullFrameLength(data,offset);if(frameLength<=headerLength)return!1;var newOffset=offset+frameLength;if(newOffset===data.length||newOffset+1<data.length&&isHeaderPattern(data,newOffset))return!0}return!1}function initTrackConfig(track,observer,data,offset,audioCodec){if(!track.samplerate){var config=function getAudioConfig(observer,data,offset,audioCodec){var adtsObjectType,adtsSampleingIndex,adtsExtensionSampleingIndex,adtsChanelConfig,config,userAgent=navigator.userAgent.toLowerCase(),manifestCodec=audioCodec,adtsSampleingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];if(adtsObjectType=1+((192&data[offset+2])>>>6),!((adtsSampleingIndex=(60&data[offset+2])>>>2)>adtsSampleingRates.length-1))return adtsChanelConfig=(1&data[offset+2])<<2,adtsChanelConfig|=(192&data[offset+3])>>>6,logger.logger.log("manifest codec:"+audioCodec+",ADTS data:type:"+adtsObjectType+",sampleingIndex:"+adtsSampleingIndex+"["+adtsSampleingRates[adtsSampleingIndex]+"Hz],channelConfig:"+adtsChanelConfig),/firefox/i.test(userAgent)?adtsSampleingIndex>=6?(adtsObjectType=5,config=new Array(4),adtsExtensionSampleingIndex=adtsSampleingIndex-3):(adtsObjectType=2,config=new Array(2),adtsExtensionSampleingIndex=adtsSampleingIndex):-1!==userAgent.indexOf("android")?(adtsObjectType=2,config=new Array(2),adtsExtensionSampleingIndex=adtsSampleingIndex):(adtsObjectType=5,config=new Array(4),audioCodec&&(-1!==audioCodec.indexOf("mp4a.40.29")||-1!==audioCodec.indexOf("mp4a.40.5"))||!audioCodec&&adtsSampleingIndex>=6?adtsExtensionSampleingIndex=adtsSampleingIndex-3:((audioCodec&&-1!==audioCodec.indexOf("mp4a.40.2")&&(adtsSampleingIndex>=6&&1===adtsChanelConfig||/vivaldi/i.test(userAgent))||!audioCodec&&1===adtsChanelConfig)&&(adtsObjectType=2,config=new Array(2)),adtsExtensionSampleingIndex=adtsSampleingIndex)),config[0]=adtsObjectType<<3,config[0]|=(14&adtsSampleingIndex)>>1,config[1]|=(1&adtsSampleingIndex)<<7,config[1]|=adtsChanelConfig<<3,5===adtsObjectType&&(config[1]|=(14&adtsExtensionSampleingIndex)>>1,config[2]=(1&adtsExtensionSampleingIndex)<<7,config[2]|=8,config[3]=0),{config:config,samplerate:adtsSampleingRates[adtsSampleingIndex],channelCount:adtsChanelConfig,codec:"mp4a.40."+adtsObjectType,manifestCodec:manifestCodec};observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+adtsSampleingIndex})}(observer,data,offset,audioCodec);track.config=config.config,track.samplerate=config.samplerate,track.channelCount=config.channelCount,track.codec=config.codec,track.manifestCodec=config.manifestCodec,logger.logger.log("parsed codec:"+track.codec+",rate:"+config.samplerate+",nb channel:"+config.channelCount)}}function getFrameDuration(samplerate){return 9216e4/samplerate}function appendFrame(track,data,offset,pts,frameIndex){var header=function parseFrameHeader(data,offset,pts,frameIndex,frameDuration){var headerLength,frameLength,length=data.length;if(headerLength=getHeaderLength(data,offset),frameLength=getFullFrameLength(data,offset),(frameLength-=headerLength)>0&&offset+headerLength+frameLength<=length)return{headerLength:headerLength,frameLength:frameLength,stamp:pts+frameIndex*frameDuration}}(data,offset,pts,frameIndex,getFrameDuration(track.samplerate));if(header){var stamp=header.stamp,headerLength=header.headerLength,frameLength=header.frameLength,aacSample={unit:data.subarray(offset+headerLength,offset+headerLength+frameLength),pts:stamp,dts:stamp};return track.samples.push(aacSample),{sample:aacSample,length:frameLength+headerLength}}}var id3=__webpack_require__("./src/demux/id3.js"),aacdemuxer=function(){function AACDemuxer(observer,remuxer,config){this.observer=observer,this.config=config,this.remuxer=remuxer}var _proto=AACDemuxer.prototype;return _proto.resetInitSegment=function resetInitSegment(initSegment,audioCodec,videoCodec,duration){this._audioTrack={container:"audio/adts",type:"audio",id:0,sequenceNumber:0,isAAC:!0,samples:[],len:0,manifestCodec:audioCodec,duration:duration,inputTimeScale:9e4}},_proto.resetTimeStamp=function resetTimeStamp(){},AACDemuxer.probe=function probe(data){if(!data)return!1;for(var offset=(id3.default.getID3Data(data,0)||[]).length,length=data.length;offset<length;offset++)if(adts_probe(data,offset))return logger.logger.log("ADTS sync word found !"),!0;return!1},_proto.append=function append(data,timeOffset,contiguous,accurateTimeOffset){for(var track=this._audioTrack,id3Data=id3.default.getID3Data(data,0)||[],timestamp=id3.default.getTimeStamp(id3Data),pts=Object(number.isFiniteNumber)(timestamp)?90*timestamp:9e4*timeOffset,frameIndex=0,stamp=pts,length=data.length,offset=id3Data.length,id3Samples=[{pts:stamp,dts:stamp,data:id3Data}];offset<length-1;)if(isHeader(data,offset)&&offset+5<length){initTrackConfig(track,this.observer,data,offset,track.manifestCodec);var frame=appendFrame(track,data,offset,pts,frameIndex);if(!frame){logger.logger.log("Unable to parse AAC frame");break}offset+=frame.length,stamp=frame.sample.pts,frameIndex++}else id3.default.isHeader(data,offset)?(id3Data=id3.default.getID3Data(data,offset),id3Samples.push({pts:stamp,dts:stamp,data:id3Data}),offset+=id3Data.length):offset++;this.remuxer.remux(track,{samples:[]},{samples:id3Samples,inputTimeScale:9e4},{samples:[]},timeOffset,contiguous,accurateTimeOffset)},_proto.destroy=function destroy(){},AACDemuxer}(),mp4demuxer=__webpack_require__("./src/demux/mp4demuxer.js"),MpegAudio={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],appendFrame:function appendFrame(track,data,offset,pts,frameIndex){if(!(offset+24>data.length)){var header=this.parseHeader(data,offset);if(header&&offset+header.frameLength<=data.length){var stamp=pts+frameIndex*(9e4*header.samplesPerFrame/header.sampleRate),sample={unit:data.subarray(offset,offset+header.frameLength),pts:stamp,dts:stamp};return track.config=[],track.channelCount=header.channelCount,track.samplerate=header.sampleRate,track.samples.push(sample),{sample:sample,length:header.frameLength}}}},parseHeader:function parseHeader(data,offset){var headerB=data[offset+1]>>3&3,headerC=data[offset+1]>>1&3,headerE=data[offset+2]>>4&15,headerF=data[offset+2]>>2&3,headerG=data[offset+2]>>1&1;if(1!==headerB&&0!==headerE&&15!==headerE&&3!==headerF){var columnInBitrates=3===headerB?3-headerC:3===headerC?3:4,bitRate=1e3*MpegAudio.BitratesMap[14*columnInBitrates+headerE-1],columnInSampleRates=3===headerB?0:2===headerB?1:2,sampleRate=MpegAudio.SamplingRateMap[3*columnInSampleRates+headerF],channelCount=data[offset+3]>>6==3?1:2,sampleCoefficient=MpegAudio.SamplesCoefficients[headerB][headerC],bytesInSlot=MpegAudio.BytesInSlot[headerC],samplesPerFrame=8*sampleCoefficient*bytesInSlot;return{sampleRate:sampleRate,channelCount:channelCount,frameLength:parseInt(sampleCoefficient*bitRate/sampleRate+headerG,10)*bytesInSlot,samplesPerFrame:samplesPerFrame}}},isHeaderPattern:function isHeaderPattern(data,offset){return 255===data[offset]&&224==(224&data[offset+1])&&0!=(6&data[offset+1])},isHeader:function isHeader(data,offset){return!!(offset+1<data.length&&this.isHeaderPattern(data,offset))},probe:function probe(data,offset){if(offset+1<data.length&&this.isHeaderPattern(data,offset)){var header=this.parseHeader(data,offset),frameLength=4;header&&header.frameLength&&(frameLength=header.frameLength);var newOffset=offset+frameLength;if(newOffset===data.length||newOffset+1<data.length&&this.isHeaderPattern(data,newOffset))return!0}return!1}},mpegaudio=MpegAudio,exp_golomb=function(){function ExpGolomb(data){this.data=data,this.bytesAvailable=data.byteLength,this.word=0,this.bitsAvailable=0}var _proto=ExpGolomb.prototype;return _proto.loadWord=function loadWord(){var data=this.data,bytesAvailable=this.bytesAvailable,position=data.byteLength-bytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,bytesAvailable);if(0===availableBytes)throw new Error("no bytes available");workingBytes.set(data.subarray(position,position+availableBytes)),this.word=new DataView(workingBytes.buffer).getUint32(0),this.bitsAvailable=8*availableBytes,this.bytesAvailable-=availableBytes},_proto.skipBits=function skipBits(count){var skipBytes;this.bitsAvailable>count?(this.word<<=count,this.bitsAvailable-=count):(count-=this.bitsAvailable,count-=(skipBytes=count>>3)>>3,this.bytesAvailable-=skipBytes,this.loadWord(),this.word<<=count,this.bitsAvailable-=count)},_proto.readBits=function readBits(size){var bits=Math.min(this.bitsAvailable,size),valu=this.word>>>32-bits;return size>32&&logger.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=bits,this.bitsAvailable>0?this.word<<=bits:this.bytesAvailable>0&&this.loadWord(),(bits=size-bits)>0&&this.bitsAvailable?valu<<bits|this.readBits(bits):valu},_proto.skipLZ=function skipLZ(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<this.bitsAvailable;++leadingZeroCount)if(0!=(this.word&2147483648>>>leadingZeroCount))return this.word<<=leadingZeroCount,this.bitsAvailable-=leadingZeroCount,leadingZeroCount;return this.loadWord(),leadingZeroCount+this.skipLZ()},_proto.skipUEG=function skipUEG(){this.skipBits(1+this.skipLZ())},_proto.skipEG=function skipEG(){this.skipBits(1+this.skipLZ())},_proto.readUEG=function readUEG(){var clz=this.skipLZ();return this.readBits(clz+1)-1},_proto.readEG=function readEG(){var valu=this.readUEG();return 1&valu?1+valu>>>1:-1*(valu>>>1)},_proto.readBoolean=function readBoolean(){return 1===this.readBits(1)},_proto.readUByte=function readUByte(){return this.readBits(8)},_proto.readUShort=function readUShort(){return this.readBits(16)},_proto.readUInt=function readUInt(){return this.readBits(32)},_proto.skipScalingList=function skipScalingList(count){var j,lastScale=8,nextScale=8;for(j=0;j<count;j++)0!==nextScale&&(nextScale=(lastScale+this.readEG()+256)%256),lastScale=0===nextScale?lastScale:nextScale},_proto.readSPS=function readSPS(){var profileIdc,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount,i,frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,readUByte=this.readUByte.bind(this),readBits=this.readBits.bind(this),readUEG=this.readUEG.bind(this),readBoolean=this.readBoolean.bind(this),skipBits=this.skipBits.bind(this),skipEG=this.skipEG.bind(this),skipUEG=this.skipUEG.bind(this),skipScalingList=this.skipScalingList.bind(this);if(readUByte(),profileIdc=readUByte(),readBits(5),skipBits(3),readUByte(),skipUEG(),100===profileIdc||110===profileIdc||122===profileIdc||244===profileIdc||44===profileIdc||83===profileIdc||86===profileIdc||118===profileIdc||128===profileIdc){var chromaFormatIdc=readUEG();if(3===chromaFormatIdc&&skipBits(1),skipUEG(),skipUEG(),skipBits(1),readBoolean())for(scalingListCount=3!==chromaFormatIdc?8:12,i=0;i<scalingListCount;i++)readBoolean()&&skipScalingList(i<6?16:64)}skipUEG();var picOrderCntType=readUEG();if(0===picOrderCntType)readUEG();else if(1===picOrderCntType)for(skipBits(1),skipEG(),skipEG(),numRefFramesInPicOrderCntCycle=readUEG(),i=0;i<numRefFramesInPicOrderCntCycle;i++)skipEG();skipUEG(),skipBits(1),picWidthInMbsMinus1=readUEG(),picHeightInMapUnitsMinus1=readUEG(),0===(frameMbsOnlyFlag=readBits(1))&&skipBits(1),skipBits(1),readBoolean()&&(frameCropLeftOffset=readUEG(),frameCropRightOffset=readUEG(),frameCropTopOffset=readUEG(),frameCropBottomOffset=readUEG());var pixelRatio=[1,1];if(readBoolean()&&readBoolean())switch(readUByte()){case 1:pixelRatio=[1,1];break;case 2:pixelRatio=[12,11];break;case 3:pixelRatio=[10,11];break;case 4:pixelRatio=[16,11];break;case 5:pixelRatio=[40,33];break;case 6:pixelRatio=[24,11];break;case 7:pixelRatio=[20,11];break;case 8:pixelRatio=[32,11];break;case 9:pixelRatio=[80,33];break;case 10:pixelRatio=[18,11];break;case 11:pixelRatio=[15,11];break;case 12:pixelRatio=[64,33];break;case 13:pixelRatio=[160,99];break;case 14:pixelRatio=[4,3];break;case 15:pixelRatio=[3,2];break;case 16:pixelRatio=[2,1];break;case 255:pixelRatio=[readUByte()<<8|readUByte(),readUByte()<<8|readUByte()]}return{width:Math.ceil(16*(picWidthInMbsMinus1+1)-2*frameCropLeftOffset-2*frameCropRightOffset),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-(frameMbsOnlyFlag?2:4)*(frameCropTopOffset+frameCropBottomOffset),pixelRatio:pixelRatio}},_proto.readSliceType=function readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()},ExpGolomb}(),sample_aes=function(){function SampleAesDecrypter(observer,config,decryptdata,discardEPB){this.decryptdata=decryptdata,this.discardEPB=discardEPB,this.decrypter=new crypt_decrypter.default(observer,config,{removePKCS7Padding:!1})}var _proto=SampleAesDecrypter.prototype;return _proto.decryptBuffer=function decryptBuffer(encryptedData,callback){this.decrypter.decrypt(encryptedData,this.decryptdata.key.buffer,this.decryptdata.iv.buffer,callback)},_proto.decryptAacSample=function decryptAacSample(samples,sampleIndex,callback,sync){var curUnit=samples[sampleIndex].unit,encryptedData=curUnit.subarray(16,curUnit.length-curUnit.length%16),encryptedBuffer=encryptedData.buffer.slice(encryptedData.byteOffset,encryptedData.byteOffset+encryptedData.length),localthis=this;this.decryptBuffer(encryptedBuffer,(function(decryptedData){decryptedData=new Uint8Array(decryptedData),curUnit.set(decryptedData,16),sync||localthis.decryptAacSamples(samples,sampleIndex+1,callback)}))},_proto.decryptAacSamples=function decryptAacSamples(samples,sampleIndex,callback){for(;;sampleIndex++){if(sampleIndex>=samples.length)return void callback();if(!(samples[sampleIndex].unit.length<32)){var sync=this.decrypter.isSync();if(this.decryptAacSample(samples,sampleIndex,callback,sync),!sync)return}}},_proto.getAvcEncryptedData=function getAvcEncryptedData(decodedData){for(var encryptedDataLen=16*Math.floor((decodedData.length-48)/160)+16,encryptedData=new Int8Array(encryptedDataLen),outputPos=0,inputPos=32;inputPos<=decodedData.length-16;inputPos+=160,outputPos+=16)encryptedData.set(decodedData.subarray(inputPos,inputPos+16),outputPos);return encryptedData},_proto.getAvcDecryptedUnit=function getAvcDecryptedUnit(decodedData,decryptedData){decryptedData=new Uint8Array(decryptedData);for(var inputPos=0,outputPos=32;outputPos<=decodedData.length-16;outputPos+=160,inputPos+=16)decodedData.set(decryptedData.subarray(inputPos,inputPos+16),outputPos);return decodedData},_proto.decryptAvcSample=function decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit,sync){var decodedData=this.discardEPB(curUnit.data),encryptedData=this.getAvcEncryptedData(decodedData),localthis=this;this.decryptBuffer(encryptedData.buffer,(function(decryptedData){curUnit.data=localthis.getAvcDecryptedUnit(decodedData,decryptedData),sync||localthis.decryptAvcSamples(samples,sampleIndex,unitIndex+1,callback)}))},_proto.decryptAvcSamples=function decryptAvcSamples(samples,sampleIndex,unitIndex,callback){for(;;sampleIndex++,unitIndex=0){if(sampleIndex>=samples.length)return void callback();for(var curUnits=samples[sampleIndex].units;!(unitIndex>=curUnits.length);unitIndex++){var curUnit=curUnits[unitIndex];if(!(curUnit.data.length<=48||1!==curUnit.type&&5!==curUnit.type)){var sync=this.decrypter.isSync();if(this.decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit,sync),!sync)return}}}},SampleAesDecrypter}(),RemuxerTrackIdConfig={video:1,audio:2,id3:3,text:4},tsdemuxer=function(){function TSDemuxer(observer,remuxer,config,typeSupported){this.observer=observer,this.config=config,this.typeSupported=typeSupported,this.remuxer=remuxer,this.sampleAes=null,this.pmtUnknownTypes={}}var _proto=TSDemuxer.prototype;return _proto.setDecryptData=function setDecryptData(decryptdata){null!=decryptdata&&null!=decryptdata.key&&"SAMPLE-AES"===decryptdata.method?this.sampleAes=new sample_aes(this.observer,this.config,decryptdata,this.discardEPB):this.sampleAes=null},TSDemuxer.probe=function probe(data){var syncOffset=TSDemuxer._syncOffset(data);return!(syncOffset<0)&&(syncOffset&&logger.logger.warn("MPEG2-TS detected but first sync word found @ offset "+syncOffset+", junk ahead ?"),!0)},TSDemuxer._syncOffset=function _syncOffset(data){for(var scanwindow=Math.min(1e3,data.length-564),i=0;i<scanwindow;){if(71===data[i]&&71===data[i+188]&&71===data[i+376])return i;i++}return-1},TSDemuxer.createTrack=function createTrack(type,duration){return{container:"video"===type||"audio"===type?"video/mp2t":void 0,type:type,id:RemuxerTrackIdConfig[type],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:"video"===type?0:void 0,isAAC:"audio"===type||void 0,duration:"audio"===type?duration:void 0}},_proto.resetInitSegment=function resetInitSegment(initSegment,audioCodec,videoCodec,duration){this.pmtParsed=!1,this._pmtId=-1,this.pmtUnknownTypes={},this._avcTrack=TSDemuxer.createTrack("video",duration),this._audioTrack=TSDemuxer.createTrack("audio",duration),this._id3Track=TSDemuxer.createTrack("id3",duration),this._txtTrack=TSDemuxer.createTrack("text",duration),this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=audioCodec,this.videoCodec=videoCodec,this._duration=duration},_proto.resetTimeStamp=function resetTimeStamp(){},_proto.append=function append(data,timeOffset,contiguous,accurateTimeOffset){var start,stt,pid,offset,pes,len=data.length,unknownPIDs=!1;this.pmtUnknownTypes={},this.contiguous=contiguous;var pmtParsed=this.pmtParsed,avcTrack=this._avcTrack,audioTrack=this._audioTrack,id3Track=this._id3Track,avcId=avcTrack.pid,audioId=audioTrack.pid,id3Id=id3Track.pid,pmtId=this._pmtId,avcData=avcTrack.pesData,audioData=audioTrack.pesData,id3Data=id3Track.pesData,parsePAT=this._parsePAT,parsePMT=this._parsePMT.bind(this),parsePES=this._parsePES,parseAVCPES=this._parseAVCPES.bind(this),parseAACPES=this._parseAACPES.bind(this),parseMPEGPES=this._parseMPEGPES.bind(this),parseID3PES=this._parseID3PES.bind(this),syncOffset=TSDemuxer._syncOffset(data);for(len-=(len+syncOffset)%188,start=syncOffset;start<len;start+=188)if(71===data[start]){if(stt=!!(64&data[start+1]),pid=((31&data[start+1])<<8)+data[start+2],(48&data[start+3])>>4>1){if((offset=start+5+data[start+4])===start+188)continue}else offset=start+4;switch(pid){case avcId:stt&&(avcData&&(pes=parsePES(avcData))&&parseAVCPES(pes,!1),avcData={data:[],size:0}),avcData&&(avcData.data.push(data.subarray(offset,start+188)),avcData.size+=start+188-offset);break;case audioId:stt&&(audioData&&(pes=parsePES(audioData))&&(audioTrack.isAAC?parseAACPES(pes):parseMPEGPES(pes)),audioData={data:[],size:0}),audioData&&(audioData.data.push(data.subarray(offset,start+188)),audioData.size+=start+188-offset);break;case id3Id:stt&&(id3Data&&(pes=parsePES(id3Data))&&parseID3PES(pes),id3Data={data:[],size:0}),id3Data&&(id3Data.data.push(data.subarray(offset,start+188)),id3Data.size+=start+188-offset);break;case 0:stt&&(offset+=data[offset]+1),pmtId=this._pmtId=parsePAT(data,offset);break;case pmtId:stt&&(offset+=data[offset]+1);var parsedPIDs=parsePMT(data,offset,!0===this.typeSupported.mpeg||!0===this.typeSupported.mp3,null!=this.sampleAes);(avcId=parsedPIDs.avc)>0&&(avcTrack.pid=avcId),(audioId=parsedPIDs.audio)>0&&(audioTrack.pid=audioId,audioTrack.isAAC=parsedPIDs.isAAC),(id3Id=parsedPIDs.id3)>0&&(id3Track.pid=id3Id),unknownPIDs&&!pmtParsed&&(logger.logger.log("reparse from beginning"),unknownPIDs=!1,start=syncOffset-188),pmtParsed=this.pmtParsed=!0;break;case 17:case 8191:break;default:unknownPIDs=!0}}else this.observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});avcData&&(pes=parsePES(avcData))?(parseAVCPES(pes,!0),avcTrack.pesData=null):avcTrack.pesData=avcData,audioData&&(pes=parsePES(audioData))?(audioTrack.isAAC?parseAACPES(pes):parseMPEGPES(pes),audioTrack.pesData=null):(audioData&&audioData.size&&logger.logger.log("last AAC PES packet truncated,might overlap between fragments"),audioTrack.pesData=audioData),id3Data&&(pes=parsePES(id3Data))?(parseID3PES(pes),id3Track.pesData=null):id3Track.pesData=id3Data,null==this.sampleAes?this.remuxer.remux(audioTrack,avcTrack,id3Track,this._txtTrack,timeOffset,contiguous,accurateTimeOffset):this.decryptAndRemux(audioTrack,avcTrack,id3Track,this._txtTrack,timeOffset,contiguous,accurateTimeOffset)},_proto.decryptAndRemux=function decryptAndRemux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset){if(audioTrack.samples&&audioTrack.isAAC){var localthis=this;this.sampleAes.decryptAacSamples(audioTrack.samples,0,(function(){localthis.decryptAndRemuxAvc(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset)}))}else this.decryptAndRemuxAvc(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset)},_proto.decryptAndRemuxAvc=function decryptAndRemuxAvc(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset){if(videoTrack.samples){var localthis=this;this.sampleAes.decryptAvcSamples(videoTrack.samples,0,0,(function(){localthis.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset)}))}else this.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset)},_proto.destroy=function destroy(){this._initPTS=this._initDTS=void 0,this._duration=0},_proto._parsePAT=function _parsePAT(data,offset){return(31&data[offset+10])<<8|data[offset+11]},_proto._trackUnknownPmt=function _trackUnknownPmt(type,logLevel,message){var result=this.pmtUnknownTypes[type]||0;return 0===result&&(this.pmtUnknownTypes[type]=0,logLevel.call(logger.logger,message)),this.pmtUnknownTypes[type]++,result},_proto._parsePMT=function _parsePMT(data,offset,mpegSupported,isSampleAes){var tableEnd,pid,result={audio:-1,avc:-1,id3:-1,isAAC:!0};for(tableEnd=offset+3+((15&data[offset+1])<<8|data[offset+2])-4,offset+=12+((15&data[offset+10])<<8|data[offset+11]);offset<tableEnd;){switch(pid=(31&data[offset+1])<<8|data[offset+2],data[offset]){case 207:if(!isSampleAes){this._trackUnknownPmt(data[offset],logger.logger.warn,"ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===result.audio&&(result.audio=pid);break;case 21:-1===result.id3&&(result.id3=pid);break;case 219:if(!isSampleAes){this._trackUnknownPmt(data[offset],logger.logger.warn,"H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===result.avc&&(result.avc=pid);break;case 3:case 4:mpegSupported?-1===result.audio&&(result.audio=pid,result.isAAC=!1):this._trackUnknownPmt(data[offset],logger.logger.warn,"MPEG audio found, not supported in this browser");break;case 36:this._trackUnknownPmt(data[offset],logger.logger.warn,"Unsupported HEVC stream type found");break;default:this._trackUnknownPmt(data[offset],logger.logger.log,"Unknown stream type:"+data[offset])}offset+=5+((15&data[offset+3])<<8|data[offset+4])}return result},_proto._parsePES=function _parsePES(stream){var frag,pesFlags,pesLen,pesHdrLen,pesData,pesPts,pesDts,payloadStartOffset,i=0,data=stream.data;if(!stream||0===stream.size)return null;for(;data[0].length<19&&data.length>1;){var newData=new Uint8Array(data[0].length+data[1].length);newData.set(data[0]),newData.set(data[1],data[0].length),data[0]=newData,data.splice(1,1)}if(1===((frag=data[0])[0]<<16)+(frag[1]<<8)+frag[2]){if((pesLen=(frag[4]<<8)+frag[5])&&pesLen>stream.size-6)return null;if(192&(pesFlags=frag[7])&&(pesPts=536870912*(14&frag[9])+4194304*(255&frag[10])+16384*(254&frag[11])+128*(255&frag[12])+(254&frag[13])/2,64&pesFlags?pesPts-(pesDts=536870912*(14&frag[14])+4194304*(255&frag[15])+16384*(254&frag[16])+128*(255&frag[17])+(254&frag[18])/2)>54e5&&(logger.logger.warn(Math.round((pesPts-pesDts)/9e4)+"s delta between PTS and DTS, align them"),pesPts=pesDts):pesDts=pesPts),payloadStartOffset=(pesHdrLen=frag[8])+9,stream.size<=payloadStartOffset)return null;stream.size-=payloadStartOffset,pesData=new Uint8Array(stream.size);for(var j=0,dataLen=data.length;j<dataLen;j++){var len=(frag=data[j]).byteLength;if(payloadStartOffset){if(payloadStartOffset>len){payloadStartOffset-=len;continue}frag=frag.subarray(payloadStartOffset),len-=payloadStartOffset,payloadStartOffset=0}pesData.set(frag,i),i+=len}return pesLen&&(pesLen-=pesHdrLen+3),{data:pesData,pts:pesPts,dts:pesDts,len:pesLen}}return null},_proto.pushAccesUnit=function pushAccesUnit(avcSample,avcTrack){if(avcSample.units.length&&avcSample.frame){var samples=avcTrack.samples,nbSamples=samples.length;if(isNaN(avcSample.pts)){if(!nbSamples)return void avcTrack.dropped++;var lastSample=samples[nbSamples-1];avcSample.pts=lastSample.pts,avcSample.dts=lastSample.dts}!this.config.forceKeyFrameOnDiscontinuity||!0===avcSample.key||avcTrack.sps&&(nbSamples||this.contiguous)?(avcSample.id=nbSamples,samples.push(avcSample)):avcTrack.dropped++}avcSample.debug.length&&logger.logger.log(avcSample.pts+"/"+avcSample.dts+":"+avcSample.debug)},_proto._parseAVCPES=function _parseAVCPES(pes,last){var expGolombDecoder,push,i,_this=this,track=this._avcTrack,units=this._parseAVCNALu(pes.data),avcSample=this.avcSample,spsfound=!1,pushAccesUnit=this.pushAccesUnit.bind(this),createAVCSample=function createAVCSample(key,pts,dts,debug){return{key:key,pts:pts,dts:dts,units:[],debug:debug}};pes.data=null,avcSample&&units.length&&!track.audFound&&(pushAccesUnit(avcSample,track),avcSample=this.avcSample=createAVCSample(!1,pes.pts,pes.dts,"")),units.forEach((function(unit){switch(unit.type){case 1:push=!0,avcSample||(avcSample=_this.avcSample=createAVCSample(!0,pes.pts,pes.dts,"")),avcSample.frame=!0;var data=unit.data;if(spsfound&&data.length>4){var sliceType=new exp_golomb(data).readSliceType();2!==sliceType&&4!==sliceType&&7!==sliceType&&9!==sliceType||(avcSample.key=!0)}break;case 5:push=!0,avcSample||(avcSample=_this.avcSample=createAVCSample(!0,pes.pts,pes.dts,"")),avcSample.key=!0,avcSample.frame=!0;break;case 6:push=!0,(expGolombDecoder=new exp_golomb(_this.discardEPB(unit.data))).readUByte();for(var payloadType=0,payloadSize=0,endOfCaptions=!1,b=0;!endOfCaptions&&expGolombDecoder.bytesAvailable>1;){payloadType=0;do{payloadType+=b=expGolombDecoder.readUByte()}while(255===b);payloadSize=0;do{payloadSize+=b=expGolombDecoder.readUByte()}while(255===b);if(4===payloadType&&0!==expGolombDecoder.bytesAvailable){if(endOfCaptions=!0,181===expGolombDecoder.readUByte())if(49===expGolombDecoder.readUShort())if(1195456820===expGolombDecoder.readUInt())if(3===expGolombDecoder.readUByte()){var firstByte=expGolombDecoder.readUByte(),totalCCs=31&firstByte,byteArray=[firstByte,expGolombDecoder.readUByte()];for(i=0;i<totalCCs;i++)byteArray.push(expGolombDecoder.readUByte()),byteArray.push(expGolombDecoder.readUByte()),byteArray.push(expGolombDecoder.readUByte());_this._insertSampleInOrder(_this._txtTrack.samples,{type:3,pts:pes.pts,bytes:byteArray})}}else if(5===payloadType&&0!==expGolombDecoder.bytesAvailable){if(endOfCaptions=!0,payloadSize>16){var uuidStrArray=[];for(i=0;i<16;i++)uuidStrArray.push(expGolombDecoder.readUByte().toString(16)),3!==i&&5!==i&&7!==i&&9!==i||uuidStrArray.push("-");var length=payloadSize-16,userDataPayloadBytes=new Uint8Array(length);for(i=0;i<length;i++)userDataPayloadBytes[i]=expGolombDecoder.readUByte();_this._insertSampleInOrder(_this._txtTrack.samples,{pts:pes.pts,payloadType:payloadType,uuid:uuidStrArray.join(""),userDataBytes:userDataPayloadBytes,userData:Object(id3.utf8ArrayToStr)(userDataPayloadBytes.buffer)})}}else if(payloadSize<expGolombDecoder.bytesAvailable)for(i=0;i<payloadSize;i++)expGolombDecoder.readUByte()}break;case 7:if(push=!0,spsfound=!0,!track.sps){var config=(expGolombDecoder=new exp_golomb(unit.data)).readSPS();track.width=config.width,track.height=config.height,track.pixelRatio=config.pixelRatio,track.sps=[unit.data],track.duration=_this._duration;var codecarray=unit.data.subarray(1,4),codecstring="avc1.";for(i=0;i<3;i++){var h=codecarray[i].toString(16);h.length<2&&(h="0"+h),codecstring+=h}track.codec=codecstring}break;case 8:push=!0,track.pps||(track.pps=[unit.data]);break;case 9:push=!1,track.audFound=!0,avcSample&&pushAccesUnit(avcSample,track),avcSample=_this.avcSample=createAVCSample(!1,pes.pts,pes.dts,"");break;case 12:push=!1;break;default:push=!1,avcSample&&(avcSample.debug+="unknown NAL "+unit.type+" ")}avcSample&&push&&avcSample.units.push(unit)})),last&&avcSample&&(pushAccesUnit(avcSample,track),this.avcSample=null)},_proto._insertSampleInOrder=function _insertSampleInOrder(arr,data){var len=arr.length;if(len>0){if(data.pts>=arr[len-1].pts)arr.push(data);else for(var pos=len-1;pos>=0;pos--)if(data.pts<arr[pos].pts){arr.splice(pos,0,data);break}}else arr.push(data)},_proto._getLastNalUnit=function _getLastNalUnit(){var lastUnit,avcSample=this.avcSample;if(!avcSample||0===avcSample.units.length){var samples=this._avcTrack.samples;avcSample=samples[samples.length-1]}if(avcSample){var units=avcSample.units;lastUnit=units[units.length-1]}return lastUnit},_proto._parseAVCNALu=function _parseAVCNALu(array){var value,overflow,unit,lastUnitType,i=0,len=array.byteLength,track=this._avcTrack,state=track.naluState||0,lastState=state,units=[],lastUnitStart=-1;for(-1===state&&(lastUnitStart=0,lastUnitType=31&array[0],state=0,i=1);i<len;)if(value=array[i++],state)if(1!==state)if(value)if(1===value){if(lastUnitStart>=0)unit={data:array.subarray(lastUnitStart,i-state-1),type:lastUnitType},units.push(unit);else{var lastUnit=this._getLastNalUnit();if(lastUnit&&(lastState&&i<=4-lastState&&lastUnit.state&&(lastUnit.data=lastUnit.data.subarray(0,lastUnit.data.byteLength-lastState)),(overflow=i-state-1)>0)){var tmp=new Uint8Array(lastUnit.data.byteLength+overflow);tmp.set(lastUnit.data,0),tmp.set(array.subarray(0,overflow),lastUnit.data.byteLength),lastUnit.data=tmp}}i<len?(lastUnitStart=i,lastUnitType=31&array[i],state=0):state=-1}else state=0;else state=3;else state=value?0:2;else state=value?0:1;if(lastUnitStart>=0&&state>=0&&(unit={data:array.subarray(lastUnitStart,len),type:lastUnitType,state:state},units.push(unit)),0===units.length){var _lastUnit=this._getLastNalUnit();if(_lastUnit){var _tmp=new Uint8Array(_lastUnit.data.byteLength+array.byteLength);_tmp.set(_lastUnit.data,0),_tmp.set(array,_lastUnit.data.byteLength),_lastUnit.data=_tmp}}return track.naluState=state,units},_proto.discardEPB=function discardEPB(data){for(var newLength,newData,length=data.byteLength,EPBPositions=[],i=1;i<length-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(EPBPositions.push(i+2),i+=2):i++;if(0===EPBPositions.length)return data;newLength=length-EPBPositions.length,newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++)sourceIndex===EPBPositions[0]&&(sourceIndex++,EPBPositions.shift()),newData[i]=data[sourceIndex];return newData},_proto._parseAACPES=function _parseAACPES(pes){var frameDuration,frameIndex,offset,stamp,len,reason,fatal,track=this._audioTrack,data=pes.data,pts=pes.pts,aacOverFlow=this.aacOverFlow,aacLastPTS=this.aacLastPTS;if(aacOverFlow){var tmp=new Uint8Array(aacOverFlow.byteLength+data.byteLength);tmp.set(aacOverFlow,0),tmp.set(data,aacOverFlow.byteLength),data=tmp}for(offset=0,len=data.length;offset<len-1&&!isHeader(data,offset);offset++);if(offset&&(offset<len-1?(reason="AAC PES did not start with ADTS header,offset:"+offset,fatal=!1):(reason="no ADTS header found in AAC PES",fatal=!0),logger.logger.warn("parsing error:"+reason),this.observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:fatal,reason:reason}),fatal))return;if(initTrackConfig(track,this.observer,data,offset,this.audioCodec),frameIndex=0,frameDuration=getFrameDuration(track.samplerate),aacOverFlow&&aacLastPTS){var newPTS=aacLastPTS+frameDuration;Math.abs(newPTS-pts)>1&&(logger.logger.log("AAC: align PTS for overlapping frames by "+Math.round((newPTS-pts)/90)),pts=newPTS)}for(;offset<len;){if(isHeader(data,offset)){if(offset+5<len){var frame=appendFrame(track,data,offset,pts,frameIndex);if(frame){offset+=frame.length,stamp=frame.sample.pts,frameIndex++;continue}}break}offset++}aacOverFlow=offset<len?data.subarray(offset,len):null,this.aacOverFlow=aacOverFlow,this.aacLastPTS=stamp},_proto._parseMPEGPES=function _parseMPEGPES(pes){for(var data=pes.data,length=data.length,frameIndex=0,offset=0,pts=pes.pts;offset<length;)if(mpegaudio.isHeader(data,offset)){var frame=mpegaudio.appendFrame(this._audioTrack,data,offset,pts,frameIndex);if(!frame)break;offset+=frame.length,frameIndex++}else offset++},_proto._parseID3PES=function _parseID3PES(pes){this._id3Track.samples.push(pes)},TSDemuxer}(),mp3demuxer=function(){function MP3Demuxer(observer,remuxer,config){this.observer=observer,this.config=config,this.remuxer=remuxer}var _proto=MP3Demuxer.prototype;return _proto.resetInitSegment=function resetInitSegment(initSegment,audioCodec,videoCodec,duration){this._audioTrack={container:"audio/mpeg",type:"audio",id:-1,sequenceNumber:0,isAAC:!1,samples:[],len:0,manifestCodec:audioCodec,duration:duration,inputTimeScale:9e4}},_proto.resetTimeStamp=function resetTimeStamp(){},MP3Demuxer.probe=function probe(data){var offset,length,id3Data=id3.default.getID3Data(data,0);if(id3Data&&void 0!==id3.default.getTimeStamp(id3Data))for(offset=id3Data.length,length=Math.min(data.length-1,offset+100);offset<length;offset++)if(mpegaudio.probe(data,offset))return logger.logger.log("MPEG Audio sync word found !"),!0;return!1},_proto.append=function append(data,timeOffset,contiguous,accurateTimeOffset){for(var id3Data=id3.default.getID3Data(data,0)||[],timestamp=id3.default.getTimeStamp(id3Data),pts=void 0!==timestamp?90*timestamp:9e4*timeOffset,offset=id3Data.length,length=data.length,frameIndex=0,stamp=0,track=this._audioTrack,id3Samples=[{pts:pts,dts:pts,data:id3Data}];offset<length;)if(mpegaudio.isHeader(data,offset)){var frame=mpegaudio.appendFrame(track,data,offset,pts,frameIndex);if(!frame)break;offset+=frame.length,stamp=frame.sample.pts,frameIndex++}else id3.default.isHeader(data,offset)?(id3Data=id3.default.getID3Data(data,offset),id3Samples.push({pts:stamp,dts:stamp,data:id3Data}),offset+=id3Data.length):offset++;this.remuxer.remux(track,{samples:[]},{samples:id3Samples,inputTimeScale:9e4},{samples:[]},timeOffset,contiguous,accurateTimeOffset)},_proto.destroy=function destroy(){},MP3Demuxer}(),aac_helper=function(){function AAC(){}return AAC.getSilentFrame=function getSilentFrame(codec,channelCount){switch(codec){case"mp4a.40.2":if(1===channelCount)return new Uint8Array([0,200,0,128,35,128]);if(2===channelCount)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===channelCount)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===channelCount)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===channelCount)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null},AAC}(),UINT32_MAX=Math.pow(2,32)-1,mp4_generator=function(){function MP4(){}return MP4.init=function init(){var i;for(i in MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},MP4.types)MP4.types.hasOwnProperty(i)&&(MP4.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);var videoHdlr=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audioHdlr=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:videoHdlr,audio:audioHdlr};var dref=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),stco=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=stco,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var majorBrand=new Uint8Array([105,115,111,109]),avc1Brand=new Uint8Array([97,118,99,49]),minorVersion=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,majorBrand,minorVersion,majorBrand,avc1Brand),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,dref))},MP4.box=function box(type){for(var result,payload=Array.prototype.slice.call(arguments,1),size=8,i=payload.length,len=i;i--;)size+=payload[i].byteLength;for((result=new Uint8Array(size))[0]=size>>24&255,result[1]=size>>16&255,result[2]=size>>8&255,result[3]=255&size,result.set(type,4),i=0,size=8;i<len;i++)result.set(payload[i],size),size+=payload[i].byteLength;return result},MP4.hdlr=function hdlr(type){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[type])},MP4.mdat=function mdat(data){return MP4.box(MP4.types.mdat,data)},MP4.mdhd=function mdhd(timescale,duration){duration*=timescale;var upperWordDuration=Math.floor(duration/(UINT32_MAX+1)),lowerWordDuration=Math.floor(duration%(UINT32_MAX+1));return MP4.box(MP4.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,85,196,0,0]))},MP4.mdia=function mdia(track){return MP4.box(MP4.types.mdia,MP4.mdhd(track.timescale,track.duration),MP4.hdlr(track.type),MP4.minf(track))},MP4.mfhd=function mfhd(sequenceNumber){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,sequenceNumber>>24,sequenceNumber>>16&255,sequenceNumber>>8&255,255&sequenceNumber]))},MP4.minf=function minf(track){return"audio"===track.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(track)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(track))},MP4.moof=function moof(sn,baseMediaDecodeTime,track){return MP4.box(MP4.types.moof,MP4.mfhd(sn),MP4.traf(track,baseMediaDecodeTime))},MP4.moov=function moov(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trak(tracks[i]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(tracks[0].timescale,tracks[0].duration)].concat(boxes).concat(MP4.mvex(tracks)))},MP4.mvex=function mvex(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trex(tracks[i]);return MP4.box.apply(null,[MP4.types.mvex].concat(boxes))},MP4.mvhd=function mvhd(timescale,duration){duration*=timescale;var upperWordDuration=Math.floor(duration/(UINT32_MAX+1)),lowerWordDuration=Math.floor(duration%(UINT32_MAX+1)),bytes=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,bytes)},MP4.sdtp=function sdtp(track){var flags,i,samples=track.samples||[],bytes=new Uint8Array(4+samples.length);for(i=0;i<samples.length;i++)flags=samples[i].flags,bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;return MP4.box(MP4.types.sdtp,bytes)},MP4.stbl=function stbl(track){return MP4.box(MP4.types.stbl,MP4.stsd(track),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))},MP4.avc1=function avc1(track){var i,data,len,sps=[],pps=[];for(i=0;i<track.sps.length;i++)len=(data=track.sps[i]).byteLength,sps.push(len>>>8&255),sps.push(255&len),sps=sps.concat(Array.prototype.slice.call(data));for(i=0;i<track.pps.length;i++)len=(data=track.pps[i]).byteLength,pps.push(len>>>8&255),pps.push(255&len),pps=pps.concat(Array.prototype.slice.call(data));var avcc=MP4.box(MP4.types.avcC,new Uint8Array([1,sps[3],sps[4],sps[5],255,224|track.sps.length].concat(sps).concat([track.pps.length]).concat(pps))),width=track.width,height=track.height,hSpacing=track.pixelRatio[0],vSpacing=track.pixelRatio[1];return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,width>>8&255,255&width,height>>8&255,255&height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),avcc,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),MP4.box(MP4.types.pasp,new Uint8Array([hSpacing>>24,hSpacing>>16&255,hSpacing>>8&255,255&hSpacing,vSpacing>>24,vSpacing>>16&255,vSpacing>>8&255,255&vSpacing])))},MP4.esds=function esds(track){var configlen=track.config.length;return new Uint8Array([0,0,0,0,3,23+configlen,0,1,0,4,15+configlen,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([configlen]).concat(track.config).concat([6,1,2]))},MP4.mp4a=function mp4a(track){var samplerate=track.samplerate;return MP4.box(MP4.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,samplerate>>8&255,255&samplerate,0,0]),MP4.box(MP4.types.esds,MP4.esds(track)))},MP4.mp3=function mp3(track){var samplerate=track.samplerate;return MP4.box(MP4.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,samplerate>>8&255,255&samplerate,0,0]))},MP4.stsd=function stsd(track){return"audio"===track.type?track.isAAC||"mp3"!==track.codec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp3(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(track))},MP4.tkhd=function tkhd(track){var id=track.id,duration=track.duration*track.timescale,width=track.width,height=track.height,upperWordDuration=Math.floor(duration/(UINT32_MAX+1)),lowerWordDuration=Math.floor(duration%(UINT32_MAX+1));return MP4.box(MP4.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,id>>24&255,id>>16&255,id>>8&255,255&id,0,0,0,0,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,width>>8&255,255&width,0,0,height>>8&255,255&height,0,0]))},MP4.traf=function traf(track,baseMediaDecodeTime){var sampleDependencyTable=MP4.sdtp(track),id=track.id,upperWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime/(UINT32_MAX+1)),lowerWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime%(UINT32_MAX+1));return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id])),MP4.box(MP4.types.tfdt,new Uint8Array([1,0,0,0,upperWordBaseMediaDecodeTime>>24,upperWordBaseMediaDecodeTime>>16&255,upperWordBaseMediaDecodeTime>>8&255,255&upperWordBaseMediaDecodeTime,lowerWordBaseMediaDecodeTime>>24,lowerWordBaseMediaDecodeTime>>16&255,lowerWordBaseMediaDecodeTime>>8&255,255&lowerWordBaseMediaDecodeTime])),MP4.trun(track,sampleDependencyTable.length+16+20+8+16+8+8),sampleDependencyTable)},MP4.trak=function trak(track){return track.duration=track.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(track),MP4.mdia(track))},MP4.trex=function trex(track){var id=track.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},MP4.trun=function trun(track,offset){var i,sample,duration,size,flags,cts,samples=track.samples||[],len=samples.length,arraylen=12+16*len,array=new Uint8Array(arraylen);for(offset+=8+arraylen,array.set([0,0,15,1,len>>>24&255,len>>>16&255,len>>>8&255,255&len,offset>>>24&255,offset>>>16&255,offset>>>8&255,255&offset],0),i=0;i<len;i++)duration=(sample=samples[i]).duration,size=sample.size,flags=sample.flags,cts=sample.cts,array.set([duration>>>24&255,duration>>>16&255,duration>>>8&255,255&duration,size>>>24&255,size>>>16&255,size>>>8&255,255&size,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.paddingValue<<1|flags.isNonSync,61440&flags.degradPrio,15&flags.degradPrio,cts>>>24&255,cts>>>16&255,cts>>>8&255,255&cts],12+16*i);return MP4.box(MP4.types.trun,array)},MP4.initSegment=function initSegment(tracks){MP4.types||MP4.init();var result,movie=MP4.moov(tracks);return(result=new Uint8Array(MP4.FTYP.byteLength+movie.byteLength)).set(MP4.FTYP),result.set(movie,MP4.FTYP.byteLength),result},MP4}();function toTimescaleFromBase(value,destScale,srcBase,round){void 0===srcBase&&(srcBase=1),void 0===round&&(round=!1);var result=value*destScale*srcBase;return round?Math.round(result):result}function toMsFromMpegTsClock(value,round){return void 0===round&&(round=!1),toTimescaleFromBase(value,1e3,1/9e4,round)}function toMpegTsClockFromTimescale(value,srcScale){return void 0===srcScale&&(srcScale=1),toTimescaleFromBase(value,9e4,1/srcScale)}var MAX_SILENT_FRAME_DURATION_90KHZ=toMpegTsClockFromTimescale(10),PTS_DTS_SHIFT_TOLERANCE_90KHZ=toMpegTsClockFromTimescale(.2),chromeVersion=null;function PTSNormalize(value,reference){var offset;if(void 0===reference)return value;for(offset=reference<value?-8589934592:8589934592;Math.abs(value-reference)>4294967296;)value+=offset;return value}var now,mp4_remuxer=function(){function MP4Remuxer(observer,config,typeSupported,vendor){if(this.observer=observer,this.config=config,this.typeSupported=typeSupported,this.ISGenerated=!1,null===chromeVersion){var result=navigator.userAgent.match(/Chrome\/(\d+)/i);chromeVersion=result?parseInt(result[1]):0}}var _proto=MP4Remuxer.prototype;return _proto.destroy=function destroy(){},_proto.resetTimeStamp=function resetTimeStamp(defaultTimeStamp){this._initPTS=this._initDTS=defaultTimeStamp},_proto.resetInitSegment=function resetInitSegment(){this.ISGenerated=!1},_proto.getVideoStartPts=function getVideoStartPts(videoSamples){var rolloverDetected=!1,startPTS=videoSamples.reduce((function(minPTS,sample){var delta=sample.pts-minPTS;return delta<-4294967296?(rolloverDetected=!0,PTSNormalize(minPTS,sample.pts)):delta>0?minPTS:sample.pts}),videoSamples[0].pts);return rolloverDetected&&logger.logger.debug("PTS rollover detected"),startPTS},_proto.remux=function remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset){if(this.ISGenerated||this.generateIS(audioTrack,videoTrack,timeOffset),this.ISGenerated){var nbAudioSamples=audioTrack.samples.length,nbVideoSamples=videoTrack.samples.length,audioTimeOffset=timeOffset,videoTimeOffset=timeOffset;if(nbAudioSamples&&nbVideoSamples){var startPTS=this.getVideoStartPts(videoTrack.samples),audiovideoTimestampDelta=(PTSNormalize(audioTrack.samples[0].pts,startPTS)-startPTS)/videoTrack.inputTimeScale;audioTimeOffset+=Math.max(0,audiovideoTimestampDelta),videoTimeOffset+=Math.max(0,-audiovideoTimestampDelta)}if(nbAudioSamples){audioTrack.timescale||(logger.logger.warn("regenerate InitSegment as audio detected"),this.generateIS(audioTrack,videoTrack,timeOffset));var audioTrackLength,audioData=this.remuxAudio(audioTrack,audioTimeOffset,contiguous,accurateTimeOffset);if(nbVideoSamples)audioData&&(audioTrackLength=audioData.endPTS-audioData.startPTS),videoTrack.timescale||(logger.logger.warn("regenerate InitSegment as video detected"),this.generateIS(audioTrack,videoTrack,timeOffset)),this.remuxVideo(videoTrack,videoTimeOffset,contiguous,audioTrackLength)}else if(nbVideoSamples){var videoData=this.remuxVideo(videoTrack,videoTimeOffset,contiguous,0,accurateTimeOffset);videoData&&audioTrack.codec&&this.remuxEmptyAudio(audioTrack,audioTimeOffset,contiguous,videoData)}}id3Track.samples.length&&this.remuxID3(id3Track,timeOffset),textTrack.samples.length&&this.remuxText(textTrack,timeOffset),this.observer.trigger(events.default.FRAG_PARSED)},_proto.generateIS=function generateIS(audioTrack,videoTrack,timeOffset){var initPTS,initDTS,observer=this.observer,audioSamples=audioTrack.samples,videoSamples=videoTrack.samples,typeSupported=this.typeSupported,container="audio/mp4",tracks={},data={tracks:tracks},computePTSDTS=void 0===this._initPTS;if(computePTSDTS&&(initPTS=initDTS=1/0),audioTrack.config&&audioSamples.length&&(audioTrack.timescale=audioTrack.samplerate,logger.logger.log("audio sampling rate : "+audioTrack.samplerate),audioTrack.isAAC||(typeSupported.mpeg?(container="audio/mpeg",audioTrack.codec=""):typeSupported.mp3&&(audioTrack.codec="mp3")),tracks.audio={container:container,codec:audioTrack.codec,initSegment:!audioTrack.isAAC&&typeSupported.mpeg?new Uint8Array:mp4_generator.initSegment([audioTrack]),metadata:{channelCount:audioTrack.channelCount}},computePTSDTS&&(initPTS=initDTS=audioSamples[0].pts-Math.round(audioTrack.inputTimeScale*timeOffset))),videoTrack.sps&&videoTrack.pps&&videoSamples.length){var inputTimeScale=videoTrack.inputTimeScale;if(videoTrack.timescale=inputTimeScale,tracks.video={container:"video/mp4",codec:videoTrack.codec,initSegment:mp4_generator.initSegment([videoTrack]),metadata:{width:videoTrack.width,height:videoTrack.height}},computePTSDTS){var startPTS=this.getVideoStartPts(videoSamples),startOffset=Math.round(inputTimeScale*timeOffset);initDTS=Math.min(initDTS,PTSNormalize(videoSamples[0].dts,startPTS)-startOffset),initPTS=Math.min(initPTS,startPTS-startOffset),this.observer.trigger(events.default.INIT_PTS_FOUND,{initPTS:initPTS})}}else computePTSDTS&&tracks.audio&&this.observer.trigger(events.default.INIT_PTS_FOUND,{initPTS:initPTS});Object.keys(tracks).length?(observer.trigger(events.default.FRAG_PARSING_INIT_SEGMENT,data),this.ISGenerated=!0,computePTSDTS&&(this._initPTS=initPTS,this._initDTS=initDTS)):observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"})},_proto.remuxVideo=function remuxVideo(track,timeOffset,contiguous,audioTrackLength){var mp4SampleDuration,mdat,moof,firstDTS,lastDTS,timeScale=track.timescale,inputSamples=track.samples,outputSamples=[],nbSamples=inputSamples.length,initPTS=this._initPTS,offset=8,minPTS=Number.POSITIVE_INFINITY,maxPTS=Number.NEGATIVE_INFINITY,ptsDtsShift=0,sortSamples=!1,nextAvcDts=this.nextAvcDts;if(0!==nbSamples){if(!contiguous)nextAvcDts=timeOffset*timeScale-(inputSamples[0].pts-PTSNormalize(inputSamples[0].dts,inputSamples[0].pts));for(var i=0;i<nbSamples;i++){var sample=inputSamples[i];sample.pts=PTSNormalize(sample.pts-initPTS,nextAvcDts),sample.dts=PTSNormalize(sample.dts-initPTS,nextAvcDts),sample.dts>sample.pts&&(ptsDtsShift=Math.max(Math.min(ptsDtsShift,sample.pts-sample.dts),-1*PTS_DTS_SHIFT_TOLERANCE_90KHZ)),sample.dts<inputSamples[i>0?i-1:i].dts&&(sortSamples=!0)}sortSamples&&inputSamples.sort((function(a,b){var deltadts=a.dts-b.dts,deltapts=a.pts-b.pts;return deltadts||deltapts||a.id-b.id})),firstDTS=inputSamples[0].dts,lastDTS=inputSamples[nbSamples-1].dts;var averageSampleDuration=Math.round((lastDTS-firstDTS)/(nbSamples-1));if(ptsDtsShift<0){if(ptsDtsShift<-2*averageSampleDuration){logger.logger.warn("PTS < DTS detected in video samples, offsetting DTS from PTS by "+toMsFromMpegTsClock(-averageSampleDuration,!0)+" ms");for(var lastDts=ptsDtsShift,_i=0;_i<nbSamples;_i++)inputSamples[_i].dts=lastDts=Math.max(lastDts,inputSamples[_i].pts-averageSampleDuration),inputSamples[_i].pts=Math.max(lastDts,inputSamples[_i].pts)}else{logger.logger.warn("PTS < DTS detected in video samples, shifting DTS by "+toMsFromMpegTsClock(ptsDtsShift,!0)+" ms to overcome this issue");for(var _i2=0;_i2<nbSamples;_i2++)inputSamples[_i2].dts=inputSamples[_i2].dts+ptsDtsShift}firstDTS=inputSamples[0].dts,lastDTS=inputSamples[nbSamples-1].dts}if(contiguous){var delta=firstDTS-nextAvcDts,foundHole=delta>averageSampleDuration;if(foundHole||delta<-1){foundHole?logger.logger.warn("AVC: "+toMsFromMpegTsClock(delta,!0)+" ms ("+delta+"dts) hole between fragments detected, filling it"):logger.logger.warn("AVC: "+toMsFromMpegTsClock(-delta,!0)+" ms ("+delta+"dts) overlapping between fragments detected"),firstDTS=nextAvcDts;var firstPTS=inputSamples[0].pts-delta;inputSamples[0].dts=firstDTS,inputSamples[0].pts=firstPTS,logger.logger.log("Video: First PTS/DTS adjusted: "+toMsFromMpegTsClock(firstPTS,!0)+"/"+toMsFromMpegTsClock(firstDTS,!0)+", delta: "+toMsFromMpegTsClock(delta,!0)+" ms")}}chromeVersion&&chromeVersion<75&&(firstDTS=Math.max(0,firstDTS));for(var nbNalu=0,naluLen=0,_i3=0;_i3<nbSamples;_i3++){for(var _sample=inputSamples[_i3],units=_sample.units,nbUnits=units.length,sampleLen=0,j=0;j<nbUnits;j++)sampleLen+=units[j].data.length;naluLen+=sampleLen,nbNalu+=nbUnits,_sample.length=sampleLen,_sample.dts=Math.max(_sample.dts,firstDTS),_sample.pts=Math.max(_sample.pts,_sample.dts,0),minPTS=Math.min(_sample.pts,minPTS),maxPTS=Math.max(_sample.pts,maxPTS)}lastDTS=inputSamples[nbSamples-1].dts;var mdatSize=naluLen+4*nbNalu+8;try{mdat=new Uint8Array(mdatSize)}catch(err){return void this.observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MUX_ERROR,details:errors.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:mdatSize,reason:"fail allocating video mdat "+mdatSize})}var view=new DataView(mdat.buffer);view.setUint32(0,mdatSize),mdat.set(mp4_generator.types.mdat,4);for(var _i4=0;_i4<nbSamples;_i4++){for(var compositionTimeOffset,avcSample=inputSamples[_i4],avcSampleUnits=avcSample.units,mp4SampleLength=0,_j=0,_nbUnits=avcSampleUnits.length;_j<_nbUnits;_j++){var unit=avcSampleUnits[_j],unitData=unit.data,unitDataLen=unit.data.byteLength;view.setUint32(offset,unitDataLen),offset+=4,mdat.set(unitData,offset),offset+=unitDataLen,mp4SampleLength+=4+unitDataLen}if(_i4<nbSamples-1)mp4SampleDuration=inputSamples[_i4+1].dts-avcSample.dts;else{var config=this.config,lastFrameDuration=avcSample.dts-inputSamples[_i4>0?_i4-1:_i4].dts;if(config.stretchShortVideoTrack){var maxBufferHole=config.maxBufferHole,gapTolerance=Math.floor(maxBufferHole*timeScale),deltaToFrameEnd=(audioTrackLength?minPTS+audioTrackLength*timeScale:this.nextAudioPts)-avcSample.pts;deltaToFrameEnd>gapTolerance?((mp4SampleDuration=deltaToFrameEnd-lastFrameDuration)<0&&(mp4SampleDuration=lastFrameDuration),logger.logger.log("It is approximately "+toMsFromMpegTsClock(deltaToFrameEnd,!1)+" ms to the next segment; using duration "+toMsFromMpegTsClock(mp4SampleDuration,!1)+" ms for the last video frame.")):mp4SampleDuration=lastFrameDuration}else mp4SampleDuration=lastFrameDuration}compositionTimeOffset=Math.round(avcSample.pts-avcSample.dts),outputSamples.push({size:mp4SampleLength,duration:mp4SampleDuration,cts:compositionTimeOffset,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:avcSample.key?2:1,isNonSync:avcSample.key?0:1}})}this.nextAvcDts=lastDTS+mp4SampleDuration;var dropped=track.dropped;if(track.nbNalu=0,track.dropped=0,outputSamples.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var flags=outputSamples[0].flags;flags.dependsOn=2,flags.isNonSync=0}track.samples=outputSamples,moof=mp4_generator.moof(track.sequenceNumber++,firstDTS,track),track.samples=[];var data={data1:moof,data2:mdat,startPTS:minPTS/timeScale,endPTS:(maxPTS+mp4SampleDuration)/timeScale,startDTS:firstDTS/timeScale,endDTS:this.nextAvcDts/timeScale,type:"video",hasAudio:!1,hasVideo:!0,nb:outputSamples.length,dropped:dropped};return this.observer.trigger(events.default.FRAG_PARSING_DATA,data),data}},_proto.remuxAudio=function remuxAudio(track,timeOffset,contiguous,accurateTimeOffset){var mp4Sample,fillFrame,mdat,moof,firstPTS,lastPTS,inputTimeScale=track.inputTimeScale,mp4timeScale=track.timescale,scaleFactor=inputTimeScale/mp4timeScale,inputSampleDuration=(track.isAAC?1024:1152)*scaleFactor,initPTS=this._initPTS,rawMPEG=!track.isAAC&&this.typeSupported.mpeg,offset=rawMPEG?0:8,inputSamples=track.samples,outputSamples=[],nextAudioPts=this.nextAudioPts;if(contiguous|=inputSamples.length&&nextAudioPts&&(accurateTimeOffset&&Math.abs(timeOffset-nextAudioPts/inputTimeScale)<.1||Math.abs(inputSamples[0].pts-nextAudioPts-initPTS)<20*inputSampleDuration),inputSamples.forEach((function(sample){sample.pts=sample.dts=PTSNormalize(sample.pts-initPTS,timeOffset*inputTimeScale)})),0!==(inputSamples=inputSamples.filter((function(sample){return sample.pts>=0}))).length){if(contiguous||(nextAudioPts=accurateTimeOffset?Math.max(0,timeOffset*inputTimeScale):inputSamples[0].pts),track.isAAC)for(var maxAudioFramesDrift=this.config.maxAudioFramesDrift,i=0,nextPts=nextAudioPts;i<inputSamples.length;){var sample=inputSamples[i],pts=sample.pts,delta=pts-nextPts;if(delta<=-maxAudioFramesDrift*inputSampleDuration)contiguous||i>0?(logger.logger.warn("Dropping 1 audio frame @ "+toMsFromMpegTsClock(nextPts,!0)/1e3+"s due to "+toMsFromMpegTsClock(delta,!0)+" ms overlap."),inputSamples.splice(i,1)):(logger.logger.warn("Audio frame @ "+toMsFromMpegTsClock(pts,!0)/1e3+"s overlaps nextAudioPts by "+toMsFromMpegTsClock(delta,!0)+" ms."),nextPts=pts+inputSampleDuration,i++);else if(delta>=maxAudioFramesDrift*inputSampleDuration&&delta<MAX_SILENT_FRAME_DURATION_90KHZ&&nextPts){var missing=Math.round(delta/inputSampleDuration);logger.logger.warn("Injecting "+missing+" audio frames @ "+toMsFromMpegTsClock(nextPts,!0)/1e3+"s due to "+toMsFromMpegTsClock(delta,!0)+" ms gap.");for(var j=0;j<missing;j++){var newStamp=Math.max(nextPts,0);(fillFrame=aac_helper.getSilentFrame(track.manifestCodec||track.codec,track.channelCount))||(logger.logger.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),fillFrame=sample.unit.subarray()),inputSamples.splice(i,0,{unit:fillFrame,pts:newStamp,dts:newStamp}),nextPts+=inputSampleDuration,i++}sample.pts=sample.dts=nextPts,nextPts+=inputSampleDuration,i++}else Math.abs(delta),sample.pts=sample.dts=nextPts,nextPts+=inputSampleDuration,i++}for(var nbSamples=inputSamples.length,mdatSize=0;nbSamples--;)mdatSize+=inputSamples[nbSamples].unit.byteLength;for(var _j2=0,_nbSamples=inputSamples.length;_j2<_nbSamples;_j2++){var audioSample=inputSamples[_j2],unit=audioSample.unit,_pts=audioSample.pts;if(void 0!==lastPTS&&mp4Sample)mp4Sample.duration=Math.round((_pts-lastPTS)/scaleFactor);else{var _delta=_pts-nextAudioPts,numMissingFrames=0;if(contiguous&&track.isAAC&&_delta){if(_delta>0&&_delta<MAX_SILENT_FRAME_DURATION_90KHZ)numMissingFrames=Math.round((_pts-nextAudioPts)/inputSampleDuration),logger.logger.log(toMsFromMpegTsClock(_delta,!0)+" ms hole between AAC samples detected,filling it"),numMissingFrames>0&&((fillFrame=aac_helper.getSilentFrame(track.manifestCodec||track.codec,track.channelCount))||(fillFrame=unit.subarray()),mdatSize+=numMissingFrames*fillFrame.length);else if(_delta<-12){logger.logger.log("drop overlapping AAC sample, expected/parsed/delta: "+toMsFromMpegTsClock(nextAudioPts,!0)+" ms / "+toMsFromMpegTsClock(_pts,!0)+" ms / "+toMsFromMpegTsClock(-_delta,!0)+" ms"),mdatSize-=unit.byteLength;continue}_pts=nextAudioPts}if(firstPTS=_pts,!(mdatSize>0))return;mdatSize+=offset;try{mdat=new Uint8Array(mdatSize)}catch(err){return void this.observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MUX_ERROR,details:errors.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:mdatSize,reason:"fail allocating audio mdat "+mdatSize})}rawMPEG||(new DataView(mdat.buffer).setUint32(0,mdatSize),mdat.set(mp4_generator.types.mdat,4));for(var _i5=0;_i5<numMissingFrames;_i5++)(fillFrame=aac_helper.getSilentFrame(track.manifestCodec||track.codec,track.channelCount))||(logger.logger.log("Unable to get silent frame for given audio codec; duplicating this frame instead."),fillFrame=unit.subarray()),mdat.set(fillFrame,offset),offset+=fillFrame.byteLength,mp4Sample={size:fillFrame.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},outputSamples.push(mp4Sample)}mdat.set(unit,offset);var unitLen=unit.byteLength;offset+=unitLen,mp4Sample={size:unitLen,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},outputSamples.push(mp4Sample),lastPTS=_pts}var lastSampleDuration=0;if((nbSamples=outputSamples.length)>=2&&(lastSampleDuration=outputSamples[nbSamples-2].duration,mp4Sample.duration=lastSampleDuration),nbSamples){this.nextAudioPts=nextAudioPts=lastPTS+scaleFactor*lastSampleDuration,track.samples=outputSamples,moof=rawMPEG?new Uint8Array:mp4_generator.moof(track.sequenceNumber++,firstPTS/scaleFactor,track),track.samples=[];var start=firstPTS/inputTimeScale,end=nextAudioPts/inputTimeScale,audioData={data1:moof,data2:mdat,startPTS:start,endPTS:end,startDTS:start,endDTS:end,type:"audio",hasAudio:!0,hasVideo:!1,nb:nbSamples};return this.observer.trigger(events.default.FRAG_PARSING_DATA,audioData),audioData}return null}},_proto.remuxEmptyAudio=function remuxEmptyAudio(track,timeOffset,contiguous,videoData){var inputTimeScale=track.inputTimeScale,scaleFactor=inputTimeScale/(track.samplerate?track.samplerate:inputTimeScale),nextAudioPts=this.nextAudioPts,startDTS=(void 0!==nextAudioPts?nextAudioPts:videoData.startDTS*inputTimeScale)+this._initDTS,endDTS=videoData.endDTS*inputTimeScale+this._initDTS,frameDuration=1024*scaleFactor,nbSamples=Math.ceil((endDTS-startDTS)/frameDuration),silentFrame=aac_helper.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if(logger.logger.warn("remux empty Audio"),silentFrame){for(var samples=[],i=0;i<nbSamples;i++){var stamp=startDTS+i*frameDuration;samples.push({unit:silentFrame,pts:stamp,dts:stamp})}track.samples=samples,this.remuxAudio(track,timeOffset,contiguous)}else logger.logger.trace("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!")},_proto.remuxID3=function remuxID3(track,timeOffset){var length=track.samples.length;if(length){for(var inputTimeScale=track.inputTimeScale,initPTS=this._initPTS,initDTS=this._initDTS,index=0;index<length;index++){var sample=track.samples[index];sample.pts=PTSNormalize(sample.pts-initPTS,timeOffset*inputTimeScale)/inputTimeScale,sample.dts=PTSNormalize(sample.dts-initDTS,timeOffset*inputTimeScale)/inputTimeScale}this.observer.trigger(events.default.FRAG_PARSING_METADATA,{samples:track.samples}),track.samples=[]}},_proto.remuxText=function remuxText(track,timeOffset){var length=track.samples.length,inputTimeScale=track.inputTimeScale,initPTS=this._initPTS;if(length){for(var index=0;index<length;index++){var sample=track.samples[index];sample.pts=PTSNormalize(sample.pts-initPTS,timeOffset*inputTimeScale)/inputTimeScale}track.samples.sort((function(a,b){return a.pts-b.pts})),this.observer.trigger(events.default.FRAG_PARSING_USERDATA,{samples:track.samples})}track.samples=[]},MP4Remuxer}(),passthrough_remuxer=function(){function PassThroughRemuxer(observer){this.observer=observer}var _proto=PassThroughRemuxer.prototype;return _proto.destroy=function destroy(){},_proto.resetTimeStamp=function resetTimeStamp(){},_proto.resetInitSegment=function resetInitSegment(){},_proto.remux=function remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset,rawData){var observer=this.observer,streamType="";audioTrack&&(streamType+="audio"),videoTrack&&(streamType+="video"),observer.trigger(events.default.FRAG_PARSING_DATA,{data1:rawData,startPTS:timeOffset,startDTS:timeOffset,type:streamType,hasAudio:!!audioTrack,hasVideo:!!videoTrack,nb:1,dropped:0}),observer.trigger(events.default.FRAG_PARSED)},PassThroughRemuxer}(),global=Object(get_self_scope.getSelfScope)();try{now=global.performance.now.bind(global.performance)}catch(err){logger.logger.debug("Unable to use Performance API on this environment"),now=global.Date.now}var demuxer_inline_DemuxerInline=function(){function DemuxerInline(observer,typeSupported,config,vendor){this.observer=observer,this.typeSupported=typeSupported,this.config=config,this.vendor=vendor}var _proto=DemuxerInline.prototype;return _proto.destroy=function destroy(){var demuxer=this.demuxer;demuxer&&demuxer.destroy()},_proto.push=function push(data,decryptdata,initSegment,audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS){var _this=this;if(data.byteLength>0&&null!=decryptdata&&null!=decryptdata.key&&"AES-128"===decryptdata.method){var decrypter=this.decrypter;null==decrypter&&(decrypter=this.decrypter=new crypt_decrypter.default(this.observer,this.config));var startTime=now();decrypter.decrypt(data,decryptdata.key.buffer,decryptdata.iv.buffer,(function(decryptedData){var endTime=now();_this.observer.trigger(events.default.FRAG_DECRYPTED,{stats:{tstart:startTime,tdecrypt:endTime}}),_this.pushDecrypted(new Uint8Array(decryptedData),decryptdata,new Uint8Array(initSegment),audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS)}))}else this.pushDecrypted(new Uint8Array(data),decryptdata,new Uint8Array(initSegment),audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS)},_proto.pushDecrypted=function pushDecrypted(data,decryptdata,initSegment,audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS){var demuxer=this.demuxer,remuxer=this.remuxer;if(!demuxer||discontinuity||trackSwitch){for(var mux,observer=this.observer,typeSupported=this.typeSupported,config=this.config,muxConfig=[{demux:tsdemuxer,remux:mp4_remuxer},{demux:mp4demuxer.default,remux:passthrough_remuxer},{demux:aacdemuxer,remux:mp4_remuxer},{demux:mp3demuxer,remux:mp4_remuxer}],i=0,len=muxConfig.length;i<len&&!(mux=muxConfig[i]).demux.probe(data);i++);if(!mux)return void observer.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"});remuxer&&remuxer instanceof mux.remux||(remuxer=new mux.remux(observer,config,typeSupported,this.vendor)),demuxer&&demuxer instanceof mux.demux||(demuxer=new mux.demux(observer,remuxer,config,typeSupported),this.probe=mux.demux.probe),this.demuxer=demuxer,this.remuxer=remuxer}(discontinuity||trackSwitch)&&(demuxer.resetInitSegment(initSegment,audioCodec,videoCodec,duration),remuxer.resetInitSegment()),discontinuity&&(demuxer.resetTimeStamp(defaultInitPTS),remuxer.resetTimeStamp(defaultInitPTS)),"function"==typeof demuxer.setDecryptData&&demuxer.setDecryptData(decryptdata),demuxer.append(data,timeOffset,contiguous,accurateTimeOffset)},DemuxerInline}();__webpack_exports__.default=demuxer_inline_DemuxerInline},"./src/demux/demuxer-worker.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _demux_demuxer_inline__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/demux/demuxer-inline.js"),_events__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/events.js"),_utils_logger__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/utils/logger.js"),eventemitter3__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/eventemitter3/index.js");__webpack_exports__.default=function DemuxerWorker(self){var observer=new eventemitter3__WEBPACK_IMPORTED_MODULE_3__.EventEmitter;observer.trigger=function trigger(event){for(var _len=arguments.length,data=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)data[_key-1]=arguments[_key];observer.emit.apply(observer,[event,event].concat(data))},observer.off=function off(event){for(var _len2=arguments.length,data=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)data[_key2-1]=arguments[_key2];observer.removeListener.apply(observer,[event].concat(data))};var forwardMessage=function forwardMessage(ev,data){self.postMessage({event:ev,data:data})};self.addEventListener("message",(function(ev){var data=ev.data;switch(data.cmd){case"init":var config=JSON.parse(data.config);self.demuxer=new _demux_demuxer_inline__WEBPACK_IMPORTED_MODULE_0__.default(observer,data.typeSupported,config,data.vendor),Object(_utils_logger__WEBPACK_IMPORTED_MODULE_2__.enableLogs)(config.debug),forwardMessage("init",null);break;case"demux":self.demuxer.push(data.data,data.decryptdata,data.initSegment,data.audioCodec,data.videoCodec,data.timeOffset,data.discontinuity,data.trackSwitch,data.contiguous,data.duration,data.accurateTimeOffset,data.defaultInitPTS)}})),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.FRAG_DECRYPTED,forwardMessage),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.FRAG_PARSING_INIT_SEGMENT,forwardMessage),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.FRAG_PARSED,forwardMessage),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.ERROR,forwardMessage),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.FRAG_PARSING_METADATA,forwardMessage),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.FRAG_PARSING_USERDATA,forwardMessage),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.INIT_PTS_FOUND,forwardMessage),observer.on(_events__WEBPACK_IMPORTED_MODULE_1__.default.FRAG_PARSING_DATA,(function(ev,data){var transferable=[],message={event:ev,data:data};data.data1&&(message.data1=data.data1.buffer,transferable.push(data.data1.buffer),delete data.data1),data.data2&&(message.data2=data.data2.buffer,transferable.push(data.data2.buffer),delete data.data2),self.postMessage(message,transferable)}))}},"./src/demux/id3.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"utf8ArrayToStr",(function(){return utf8ArrayToStr}));var decoder,_utils_get_self_scope__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/utils/get-self-scope.js"),ID3=function(){function ID3(){}return ID3.isHeader=function isHeader(data,offset){return offset+10<=data.length&&73===data[offset]&&68===data[offset+1]&&51===data[offset+2]&&data[offset+3]<255&&data[offset+4]<255&&data[offset+6]<128&&data[offset+7]<128&&data[offset+8]<128&&data[offset+9]<128},ID3.isFooter=function isFooter(data,offset){return offset+10<=data.length&&51===data[offset]&&68===data[offset+1]&&73===data[offset+2]&&data[offset+3]<255&&data[offset+4]<255&&data[offset+6]<128&&data[offset+7]<128&&data[offset+8]<128&&data[offset+9]<128},ID3.getID3Data=function getID3Data(data,offset){for(var front=offset,length=0;ID3.isHeader(data,offset);){length+=10,length+=ID3._readSize(data,offset+6),ID3.isFooter(data,offset+10)&&(length+=10),offset+=length}if(length>0)return data.subarray(front,front+length)},ID3._readSize=function _readSize(data,offset){var size=0;return size=(127&data[offset])<<21,size|=(127&data[offset+1])<<14,size|=(127&data[offset+2])<<7,size|=127&data[offset+3]},ID3.getTimeStamp=function getTimeStamp(data){for(var frames=ID3.getID3Frames(data),i=0;i<frames.length;i++){var frame=frames[i];if(ID3.isTimeStampFrame(frame))return ID3._readTimeStamp(frame)}},ID3.isTimeStampFrame=function isTimeStampFrame(frame){return frame&&"PRIV"===frame.key&&"com.apple.streaming.transportStreamTimestamp"===frame.info},ID3._getFrameData=function _getFrameData(data){var type=String.fromCharCode(data[0],data[1],data[2],data[3]),size=ID3._readSize(data,4);return{type:type,size:size,data:data.subarray(10,10+size)}},ID3.getID3Frames=function getID3Frames(id3Data){for(var offset=0,frames=[];ID3.isHeader(id3Data,offset);){for(var size=ID3._readSize(id3Data,offset+6),end=(offset+=10)+size;offset+8<end;){var frameData=ID3._getFrameData(id3Data.subarray(offset)),frame=ID3._decodeFrame(frameData);frame&&frames.push(frame),offset+=frameData.size+10}ID3.isFooter(id3Data,offset)&&(offset+=10)}return frames},ID3._decodeFrame=function _decodeFrame(frame){return"PRIV"===frame.type?ID3._decodePrivFrame(frame):"W"===frame.type[0]?ID3._decodeURLFrame(frame):ID3._decodeTextFrame(frame)},ID3._readTimeStamp=function _readTimeStamp(timeStampFrame){if(8===timeStampFrame.data.byteLength){var data=new Uint8Array(timeStampFrame.data),pts33Bit=1&data[3],timestamp=(data[4]<<23)+(data[5]<<15)+(data[6]<<7)+data[7];return timestamp/=45,pts33Bit&&(timestamp+=47721858.84),Math.round(timestamp)}},ID3._decodePrivFrame=function _decodePrivFrame(frame){if(!(frame.size<2)){var owner=ID3._utf8ArrayToStr(frame.data,!0),privateData=new Uint8Array(frame.data.subarray(owner.length+1));return{key:frame.type,info:owner,data:privateData.buffer}}},ID3._decodeTextFrame=function _decodeTextFrame(frame){if(!(frame.size<2)){if("TXXX"===frame.type){var index=1,description=ID3._utf8ArrayToStr(frame.data.subarray(index),!0);index+=description.length+1;var value=ID3._utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value}}var text=ID3._utf8ArrayToStr(frame.data.subarray(1));return{key:frame.type,data:text}}},ID3._decodeURLFrame=function _decodeURLFrame(frame){if("WXXX"===frame.type){if(frame.size<2)return;var index=1,description=ID3._utf8ArrayToStr(frame.data.subarray(index),!0);index+=description.length+1;var value=ID3._utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value}}var url=ID3._utf8ArrayToStr(frame.data);return{key:frame.type,data:url}},ID3._utf8ArrayToStr=function _utf8ArrayToStr(array,exitOnNull){void 0===exitOnNull&&(exitOnNull=!1);var decoder=getTextDecoder();if(decoder){var decoded=decoder.decode(array);if(exitOnNull){var idx=decoded.indexOf("\0");return-1!==idx?decoded.substring(0,idx):decoded}return decoded.replace(/\0/g,"")}for(var c,char2,char3,len=array.length,out="",i=0;i<len;){if(0===(c=array[i++])&&exitOnNull)return out;if(0!==c&&3!==c)switch(c>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:out+=String.fromCharCode(c);break;case 12:case 13:char2=array[i++],out+=String.fromCharCode((31&c)<<6|63&char2);break;case 14:char2=array[i++],char3=array[i++],out+=String.fromCharCode((15&c)<<12|(63&char2)<<6|(63&char3)<<0)}}return out},ID3}();function getTextDecoder(){var global=Object(_utils_get_self_scope__WEBPACK_IMPORTED_MODULE_0__.getSelfScope)();return decoder||void 0===global.TextDecoder||(decoder=new global.TextDecoder("utf-8")),decoder}var utf8ArrayToStr=ID3._utf8ArrayToStr;__webpack_exports__.default=ID3},"./src/demux/mp4demuxer.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _utils_logger__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/utils/logger.js"),_events__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/events.js"),UINT32_MAX=Math.pow(2,32)-1,MP4Demuxer=function(){function MP4Demuxer(observer,remuxer){this.observer=observer,this.remuxer=remuxer}var _proto=MP4Demuxer.prototype;return _proto.resetTimeStamp=function resetTimeStamp(initPTS){this.initPTS=initPTS},_proto.resetInitSegment=function resetInitSegment(initSegment,audioCodec,videoCodec,duration){if(initSegment&&initSegment.byteLength){var initData=this.initData=MP4Demuxer.parseInitSegment(initSegment);null==audioCodec&&(audioCodec="mp4a.40.5"),null==videoCodec&&(videoCodec="avc1.42e01e");var tracks={};initData.audio&&initData.video?tracks.audiovideo={container:"video/mp4",codec:audioCodec+","+videoCodec,initSegment:duration?initSegment:null}:(initData.audio&&(tracks.audio={container:"audio/mp4",codec:audioCodec,initSegment:duration?initSegment:null}),initData.video&&(tracks.video={container:"video/mp4",codec:videoCodec,initSegment:duration?initSegment:null})),this.observer.trigger(_events__WEBPACK_IMPORTED_MODULE_1__.default.FRAG_PARSING_INIT_SEGMENT,{tracks:tracks})}else audioCodec&&(this.audioCodec=audioCodec),videoCodec&&(this.videoCodec=videoCodec)},MP4Demuxer.probe=function probe(data){return MP4Demuxer.findBox({data:data,start:0,end:Math.min(data.length,16384)},["moof"]).length>0},MP4Demuxer.bin2str=function bin2str(buffer){return String.fromCharCode.apply(null,buffer)},MP4Demuxer.readUint16=function readUint16(buffer,offset){buffer.data&&(offset+=buffer.start,buffer=buffer.data);var val=buffer[offset]<<8|buffer[offset+1];return val<0?65536+val:val},MP4Demuxer.readUint32=function readUint32(buffer,offset){buffer.data&&(offset+=buffer.start,buffer=buffer.data);var val=buffer[offset]<<24|buffer[offset+1]<<16|buffer[offset+2]<<8|buffer[offset+3];return val<0?4294967296+val:val},MP4Demuxer.writeUint32=function writeUint32(buffer,offset,value){buffer.data&&(offset+=buffer.start,buffer=buffer.data),buffer[offset]=value>>24,buffer[offset+1]=value>>16&255,buffer[offset+2]=value>>8&255,buffer[offset+3]=255&value},MP4Demuxer.findBox=function findBox(data,path){var i,size,end,subresults,start,endbox,results=[];if(data.data?(start=data.start,end=data.end,data=data.data):(start=0,end=data.byteLength),!path.length)return null;for(i=start;i<end;)endbox=(size=MP4Demuxer.readUint32(data,i))>1?i+size:end,MP4Demuxer.bin2str(data.subarray(i+4,i+8))===path[0]&&(1===path.length?results.push({data:data,start:i+8,end:endbox}):(subresults=MP4Demuxer.findBox({data:data,start:i+8,end:endbox},path.slice(1))).length&&(results=results.concat(subresults))),i=endbox;return results},MP4Demuxer.parseSegmentIndex=function parseSegmentIndex(initSegment){var references,moov=MP4Demuxer.findBox(initSegment,["moov"])[0],moovEndOffset=moov?moov.end:null,index=0,sidx=MP4Demuxer.findBox(initSegment,["sidx"]);if(!sidx||!sidx[0])return null;references=[];var version=(sidx=sidx[0]).data[0];index=0===version?8:16;var timescale=MP4Demuxer.readUint32(sidx,index);index+=4;index+=0===version?8:16,index+=2;var startByte=sidx.end+0,referencesCount=MP4Demuxer.readUint16(sidx,index);index+=2;for(var i=0;i<referencesCount;i++){var referenceIndex=index,referenceInfo=MP4Demuxer.readUint32(sidx,referenceIndex);referenceIndex+=4;var referenceSize=2147483647&referenceInfo;if(1===(2147483648&referenceInfo)>>>31)return void console.warn("SIDX has hierarchical references (not supported)");var subsegmentDuration=MP4Demuxer.readUint32(sidx,referenceIndex);referenceIndex+=4,references.push({referenceSize:referenceSize,subsegmentDuration:subsegmentDuration,info:{duration:subsegmentDuration/timescale,start:startByte,end:startByte+referenceSize-1}}),startByte+=referenceSize,index=referenceIndex+=4}return{earliestPresentationTime:0,timescale:timescale,version:version,referencesCount:referencesCount,references:references,moovEndOffset:moovEndOffset}},MP4Demuxer.parseInitSegment=function parseInitSegment(initSegment){var result=[];return MP4Demuxer.findBox(initSegment,["moov","trak"]).forEach((function(trak){var tkhd=MP4Demuxer.findBox(trak,["tkhd"])[0];if(tkhd){var version=tkhd.data[tkhd.start],index=0===version?12:20,trackId=MP4Demuxer.readUint32(tkhd,index),mdhd=MP4Demuxer.findBox(trak,["mdia","mdhd"])[0];if(mdhd){index=0===(version=mdhd.data[mdhd.start])?12:20;var timescale=MP4Demuxer.readUint32(mdhd,index),hdlr=MP4Demuxer.findBox(trak,["mdia","hdlr"])[0];if(hdlr){var type={soun:"audio",vide:"video"}[MP4Demuxer.bin2str(hdlr.data.subarray(hdlr.start+8,hdlr.start+12))];if(type){var codecBox=MP4Demuxer.findBox(trak,["mdia","minf","stbl","stsd"]);if(codecBox.length){codecBox=codecBox[0];var codecType=MP4Demuxer.bin2str(codecBox.data.subarray(codecBox.start+12,codecBox.start+16));_utils_logger__WEBPACK_IMPORTED_MODULE_0__.logger.log("MP4Demuxer:"+type+":"+codecType+" found")}result[trackId]={timescale:timescale,type:type},result[type]={timescale:timescale,id:trackId}}}}}})),result},MP4Demuxer.getStartDTS=function getStartDTS(initData,fragment){var trafs,baseTimes,result;return trafs=MP4Demuxer.findBox(fragment,["moof","traf"]),baseTimes=[].concat.apply([],trafs.map((function(traf){return MP4Demuxer.findBox(traf,["tfhd"]).map((function(tfhd){var id,scale;return id=MP4Demuxer.readUint32(tfhd,4),scale=initData[id].timescale||9e4,MP4Demuxer.findBox(traf,["tfdt"]).map((function(tfdt){var version,result;return version=tfdt.data[tfdt.start],result=MP4Demuxer.readUint32(tfdt,4),1===version&&(result*=Math.pow(2,32),result+=MP4Demuxer.readUint32(tfdt,8)),result}))[0]/scale}))}))),result=Math.min.apply(null,baseTimes),isFinite(result)?result:0},MP4Demuxer.offsetStartDTS=function offsetStartDTS(initData,fragment,timeOffset){MP4Demuxer.findBox(fragment,["moof","traf"]).map((function(traf){return MP4Demuxer.findBox(traf,["tfhd"]).map((function(tfhd){var id=MP4Demuxer.readUint32(tfhd,4),timescale=initData[id].timescale||9e4;MP4Demuxer.findBox(traf,["tfdt"]).map((function(tfdt){var version=tfdt.data[tfdt.start],baseMediaDecodeTime=MP4Demuxer.readUint32(tfdt,4);if(0===version)MP4Demuxer.writeUint32(tfdt,4,baseMediaDecodeTime-timeOffset*timescale);else{baseMediaDecodeTime*=Math.pow(2,32),baseMediaDecodeTime+=MP4Demuxer.readUint32(tfdt,8),baseMediaDecodeTime-=timeOffset*timescale,baseMediaDecodeTime=Math.max(baseMediaDecodeTime,0);var upper=Math.floor(baseMediaDecodeTime/(UINT32_MAX+1)),lower=Math.floor(baseMediaDecodeTime%(UINT32_MAX+1));MP4Demuxer.writeUint32(tfdt,4,upper),MP4Demuxer.writeUint32(tfdt,8,lower)}}))}))}))},_proto.append=function append(data,timeOffset,contiguous,accurateTimeOffset){var initData=this.initData;initData||(this.resetInitSegment(data,this.audioCodec,this.videoCodec,!1),initData=this.initData);var startDTS,initPTS=this.initPTS;if(void 0===initPTS){var _startDTS=MP4Demuxer.getStartDTS(initData,data);this.initPTS=initPTS=_startDTS-timeOffset,this.observer.trigger(_events__WEBPACK_IMPORTED_MODULE_1__.default.INIT_PTS_FOUND,{initPTS:initPTS})}MP4Demuxer.offsetStartDTS(initData,data,initPTS),startDTS=MP4Demuxer.getStartDTS(initData,data),this.remuxer.remux(initData.audio,initData.video,null,null,startDTS,contiguous,accurateTimeOffset,data)},_proto.destroy=function destroy(){},MP4Demuxer}();__webpack_exports__.default=MP4Demuxer},"./src/errors.ts":function(module,__webpack_exports__,__webpack_require__){"use strict";var ErrorTypes,ErrorDetails;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ErrorTypes",(function(){return ErrorTypes})),__webpack_require__.d(__webpack_exports__,"ErrorDetails",(function(){return ErrorDetails})),function(ErrorTypes){ErrorTypes.NETWORK_ERROR="networkError",ErrorTypes.MEDIA_ERROR="mediaError",ErrorTypes.KEY_SYSTEM_ERROR="keySystemError",ErrorTypes.MUX_ERROR="muxError",ErrorTypes.OTHER_ERROR="otherError"}(ErrorTypes||(ErrorTypes={})),function(ErrorDetails){ErrorDetails.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",ErrorDetails.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",ErrorDetails.KEY_SYSTEM_NO_SESSION="keySystemNoSession",ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",ErrorDetails.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",ErrorDetails.MANIFEST_LOAD_ERROR="manifestLoadError",ErrorDetails.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",ErrorDetails.MANIFEST_PARSING_ERROR="manifestParsingError",ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",ErrorDetails.LEVEL_EMPTY_ERROR="levelEmptyError",ErrorDetails.LEVEL_LOAD_ERROR="levelLoadError",ErrorDetails.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",ErrorDetails.LEVEL_SWITCH_ERROR="levelSwitchError",ErrorDetails.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",ErrorDetails.FRAG_LOAD_ERROR="fragLoadError",ErrorDetails.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",ErrorDetails.FRAG_DECRYPT_ERROR="fragDecryptError",ErrorDetails.FRAG_PARSING_ERROR="fragParsingError",ErrorDetails.REMUX_ALLOC_ERROR="remuxAllocError",ErrorDetails.KEY_LOAD_ERROR="keyLoadError",ErrorDetails.KEY_LOAD_TIMEOUT="keyLoadTimeOut",ErrorDetails.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",ErrorDetails.BUFFER_APPEND_ERROR="bufferAppendError",ErrorDetails.BUFFER_APPENDING_ERROR="bufferAppendingError",ErrorDetails.BUFFER_STALLED_ERROR="bufferStalledError",ErrorDetails.BUFFER_FULL_ERROR="bufferFullError",ErrorDetails.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",ErrorDetails.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",ErrorDetails.INTERNAL_EXCEPTION="internalException"}(ErrorDetails||(ErrorDetails={}))},"./src/events.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_exports__.default={MEDIA_ATTACHING:"hlsMediaAttaching",MEDIA_ATTACHED:"hlsMediaAttached",MEDIA_DETACHING:"hlsMediaDetaching",MEDIA_DETACHED:"hlsMediaDetached",BUFFER_RESET:"hlsBufferReset",BUFFER_CODECS:"hlsBufferCodecs",BUFFER_CREATED:"hlsBufferCreated",BUFFER_APPENDING:"hlsBufferAppending",BUFFER_APPENDED:"hlsBufferAppended",BUFFER_EOS:"hlsBufferEos",BUFFER_FLUSHING:"hlsBufferFlushing",BUFFER_FLUSHED:"hlsBufferFlushed",MANIFEST_LOADING:"hlsManifestLoading",MANIFEST_LOADED:"hlsManifestLoaded",MANIFEST_PARSED:"hlsManifestParsed",LEVEL_SWITCHING:"hlsLevelSwitching",LEVEL_SWITCHED:"hlsLevelSwitched",LEVEL_LOADING:"hlsLevelLoading",LEVEL_LOADED:"hlsLevelLoaded",LEVEL_UPDATED:"hlsLevelUpdated",LEVEL_PTS_UPDATED:"hlsLevelPtsUpdated",LEVELS_UPDATED:"hlsLevelsUpdated",AUDIO_TRACKS_UPDATED:"hlsAudioTracksUpdated",AUDIO_TRACK_SWITCHING:"hlsAudioTrackSwitching",AUDIO_TRACK_SWITCHED:"hlsAudioTrackSwitched",AUDIO_TRACK_LOADING:"hlsAudioTrackLoading",AUDIO_TRACK_LOADED:"hlsAudioTrackLoaded",SUBTITLE_TRACKS_UPDATED:"hlsSubtitleTracksUpdated",SUBTITLE_TRACK_SWITCH:"hlsSubtitleTrackSwitch",SUBTITLE_TRACK_LOADING:"hlsSubtitleTrackLoading",SUBTITLE_TRACK_LOADED:"hlsSubtitleTrackLoaded",SUBTITLE_FRAG_PROCESSED:"hlsSubtitleFragProcessed",CUES_PARSED:"hlsCuesParsed",NON_NATIVE_TEXT_TRACKS_FOUND:"hlsNonNativeTextTracksFound",INIT_PTS_FOUND:"hlsInitPtsFound",FRAG_LOADING:"hlsFragLoading",FRAG_LOAD_PROGRESS:"hlsFragLoadProgress",FRAG_LOAD_EMERGENCY_ABORTED:"hlsFragLoadEmergencyAborted",FRAG_LOADED:"hlsFragLoaded",FRAG_DECRYPTED:"hlsFragDecrypted",FRAG_PARSING_INIT_SEGMENT:"hlsFragParsingInitSegment",FRAG_PARSING_USERDATA:"hlsFragParsingUserdata",FRAG_PARSING_METADATA:"hlsFragParsingMetadata",FRAG_PARSING_DATA:"hlsFragParsingData",FRAG_PARSED:"hlsFragParsed",FRAG_BUFFERED:"hlsFragBuffered",FRAG_CHANGED:"hlsFragChanged",FPS_DROP:"hlsFpsDrop",FPS_DROP_LEVEL_CAPPING:"hlsFpsDropLevelCapping",ERROR:"hlsError",DESTROYING:"hlsDestroying",KEY_LOADING:"hlsKeyLoading",KEY_LOADED:"hlsKeyLoaded",STREAM_STATE_TRANSITION:"hlsStreamStateTransition",LIVE_BACK_BUFFER_REACHED:"hlsLiveBackBufferReached"}},"./src/hls.ts":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"default",(function(){return hls_Hls}));var cues_namespaceObject={};__webpack_require__.r(cues_namespaceObject),__webpack_require__.d(cues_namespaceObject,"newCue",(function(){return newCue}));var PlaylistContextType,PlaylistLevelType,url_toolkit=__webpack_require__("./node_modules/url-toolkit/src/url-toolkit.js"),errors=__webpack_require__("./src/errors.ts"),number=__webpack_require__("./src/polyfills/number.js"),events=__webpack_require__("./src/events.js"),logger=__webpack_require__("./src/utils/logger.js"),FORBIDDEN_EVENT_NAMES={hlsEventGeneric:!0,hlsHandlerDestroying:!0,hlsHandlerDestroyed:!0},event_handler=function(){function EventHandler(hls){this.hls=void 0,this.handledEvents=void 0,this.useGenericHandler=void 0,this.hls=hls,this.onEvent=this.onEvent.bind(this);for(var _len=arguments.length,events=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)events[_key-1]=arguments[_key];this.handledEvents=events,this.useGenericHandler=!0,this.registerListeners()}var _proto=EventHandler.prototype;return _proto.destroy=function destroy(){this.onHandlerDestroying(),this.unregisterListeners(),this.onHandlerDestroyed()},_proto.onHandlerDestroying=function onHandlerDestroying(){},_proto.onHandlerDestroyed=function onHandlerDestroyed(){},_proto.isEventHandler=function isEventHandler(){return"object"==typeof this.handledEvents&&this.handledEvents.length&&"function"==typeof this.onEvent},_proto.registerListeners=function registerListeners(){this.isEventHandler()&&this.handledEvents.forEach((function(event){if(FORBIDDEN_EVENT_NAMES[event])throw new Error("Forbidden event-name: "+event);this.hls.on(event,this.onEvent)}),this)},_proto.unregisterListeners=function unregisterListeners(){this.isEventHandler()&&this.handledEvents.forEach((function(event){this.hls.off(event,this.onEvent)}),this)},_proto.onEvent=function onEvent(event,data){this.onEventGeneric(event,data)},_proto.onEventGeneric=function onEventGeneric(event,data){try{(function eventToFunction(event,data){var funcName="on"+event.replace("hls","");if("function"!=typeof this[funcName])throw new Error("Event "+event+" has no generic handler in this "+this.constructor.name+" class (tried "+funcName+")");return this[funcName].bind(this,data)}).call(this,event,data).call()}catch(err){logger.logger.error("An internal error happened while handling event "+event+'. Error message: "'+err.message+'". Here is a stacktrace:',err),this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.OTHER_ERROR,details:errors.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:event,err:err})}},EventHandler}();!function(PlaylistContextType){PlaylistContextType.MANIFEST="manifest",PlaylistContextType.LEVEL="level",PlaylistContextType.AUDIO_TRACK="audioTrack",PlaylistContextType.SUBTITLE_TRACK="subtitleTrack"}(PlaylistContextType||(PlaylistContextType={})),function(PlaylistLevelType){PlaylistLevelType.MAIN="main",PlaylistLevelType.AUDIO="audio",PlaylistLevelType.SUBTITLE="subtitle"}(PlaylistLevelType||(PlaylistLevelType={}));var mp4demuxer=__webpack_require__("./src/demux/mp4demuxer.js");function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var ElementaryStreamTypes,level_key_LevelKey=function(){function LevelKey(baseURI,relativeURI){this._uri=null,this.baseuri=void 0,this.reluri=void 0,this.method=null,this.key=null,this.iv=null,this.baseuri=baseURI,this.reluri=relativeURI}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(LevelKey,[{key:"uri",get:function get(){return!this._uri&&this.reluri&&(this._uri=Object(url_toolkit.buildAbsoluteURL)(this.baseuri,this.reluri,{alwaysNormalize:!0})),this._uri}}]),LevelKey}();function fragment_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}!function(ElementaryStreamTypes){ElementaryStreamTypes.AUDIO="audio",ElementaryStreamTypes.VIDEO="video"}(ElementaryStreamTypes||(ElementaryStreamTypes={}));var fragment_Fragment=function(){function Fragment(){var _this$_elementaryStre;this._url=null,this._byteRange=null,this._decryptdata=null,this._elementaryStreams=((_this$_elementaryStre={})[ElementaryStreamTypes.AUDIO]=!1,_this$_elementaryStre[ElementaryStreamTypes.VIDEO]=!1,_this$_elementaryStre),this.deltaPTS=0,this.rawProgramDateTime=null,this.programDateTime=null,this.title=null,this.tagList=[],this.cc=void 0,this.type=void 0,this.relurl=void 0,this.baseurl=void 0,this.duration=void 0,this.start=void 0,this.sn=0,this.urlId=0,this.level=0,this.levelkey=void 0,this.loader=void 0}var _proto=Fragment.prototype;return _proto.setByteRange=function setByteRange(value,previousFrag){var params=value.split("@",2),byteRange=[];1===params.length?byteRange[0]=previousFrag?previousFrag.byteRangeEndOffset:0:byteRange[0]=parseInt(params[1]),byteRange[1]=parseInt(params[0])+byteRange[0],this._byteRange=byteRange},_proto.addElementaryStream=function addElementaryStream(type){this._elementaryStreams[type]=!0},_proto.hasElementaryStream=function hasElementaryStream(type){return!0===this._elementaryStreams[type]},_proto.createInitializationVector=function createInitializationVector(segmentNumber){for(var uint8View=new Uint8Array(16),i=12;i<16;i++)uint8View[i]=segmentNumber>>8*(15-i)&255;return uint8View},_proto.setDecryptDataFromLevelKey=function setDecryptDataFromLevelKey(levelkey,segmentNumber){var decryptdata=levelkey;return(null==levelkey?void 0:levelkey.method)&&levelkey.uri&&!levelkey.iv&&((decryptdata=new level_key_LevelKey(levelkey.baseuri,levelkey.reluri)).method=levelkey.method,decryptdata.iv=this.createInitializationVector(segmentNumber)),decryptdata},function fragment_createClass(Constructor,protoProps,staticProps){return protoProps&&fragment_defineProperties(Constructor.prototype,protoProps),staticProps&&fragment_defineProperties(Constructor,staticProps),Constructor}(Fragment,[{key:"url",get:function get(){return!this._url&&this.relurl&&(this._url=Object(url_toolkit.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url},set:function set(value){this._url=value}},{key:"byteRange",get:function get(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function get(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function get(){return this.byteRange[1]}},{key:"decryptdata",get:function get(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var sn=this.sn;"number"!=typeof sn&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&logger.logger.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),sn=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,sn)}return this._decryptdata}},{key:"endProgramDateTime",get:function get(){if(null===this.programDateTime)return null;if(!Object(number.isFiniteNumber)(this.programDateTime))return null;var duration=Object(number.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+1e3*duration}},{key:"encrypted",get:function get(){return!(!this.decryptdata||null===this.decryptdata.uri||null!==this.decryptdata.key)}}]),Fragment}();function level_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var level_Level=function(){function Level(baseUrl){this.endCC=0,this.endSN=0,this.fragments=[],this.initSegment=null,this.live=!0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=baseUrl,this.version=null}return function level_createClass(Constructor,protoProps,staticProps){return protoProps&&level_defineProperties(Constructor.prototype,protoProps),staticProps&&level_defineProperties(Constructor,staticProps),Constructor}(Level,[{key:"hasProgramDateTime",get:function get(){return!(!this.fragments[0]||!Object(number.isFiniteNumber)(this.fragments[0].programDateTime))}}]),Level}(),DECIMAL_RESOLUTION_REGEX=/^(\d+)x(\d+)$/,ATTR_LIST_REGEX=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,attr_list=function(){function AttrList(attrs){for(var attr in"string"==typeof attrs&&(attrs=AttrList.parseAttrList(attrs)),attrs)attrs.hasOwnProperty(attr)&&(this[attr]=attrs[attr])}var _proto=AttrList.prototype;return _proto.decimalInteger=function decimalInteger(attrName){var intValue=parseInt(this[attrName],10);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue},_proto.hexadecimalInteger=function hexadecimalInteger(attrName){if(this[attrName]){var stringValue=(this[attrName]||"0x").slice(2);stringValue=(1&stringValue.length?"0":"")+stringValue;for(var value=new Uint8Array(stringValue.length/2),i=0;i<stringValue.length/2;i++)value[i]=parseInt(stringValue.slice(2*i,2*i+2),16);return value}return null},_proto.hexadecimalIntegerAsNumber=function hexadecimalIntegerAsNumber(attrName){var intValue=parseInt(this[attrName],16);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue},_proto.decimalFloatingPoint=function decimalFloatingPoint(attrName){return parseFloat(this[attrName])},_proto.enumeratedString=function enumeratedString(attrName){return this[attrName]},_proto.decimalResolution=function decimalResolution(attrName){var res=DECIMAL_RESOLUTION_REGEX.exec(this[attrName]);if(null!==res)return{width:parseInt(res[1],10),height:parseInt(res[2],10)}},AttrList.parseAttrList=function parseAttrList(input){var match,attrs={};for(ATTR_LIST_REGEX.lastIndex=0;null!==(match=ATTR_LIST_REGEX.exec(input));){var value=match[2];0===value.indexOf('"')&&value.lastIndexOf('"')===value.length-1&&(value=value.slice(1,-1)),attrs[match[1]]=value}return attrs},AttrList}(),sampleEntryCodesISO={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0}};function isCodecSupportedInMp4(codec,type){return MediaSource.isTypeSupported((type||"video")+'/mp4;codecs="'+codec+'"')}var MASTER_PLAYLIST_REGEX=/(?:#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-SESSION-DATA:([^\n\r]*)[\r\n]+)/g,MASTER_PLAYLIST_MEDIA_REGEX=/#EXT-X-MEDIA:(.*)/g,LEVEL_PLAYLIST_REGEX_FAST=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/|(?!#)([\S+ ?]+)/.source,/|#EXT-X-BYTERANGE:*(.+)/.source,/|#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/|#.*/.source].join(""),"g"),LEVEL_PLAYLIST_REGEX_SLOW=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:(#)([^:]*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,MP4_REGEX_SUFFIX=/\.(mp4|m4s|m4v|m4a)$/i,m3u8_parser_M3U8Parser=function(){function M3U8Parser(){}return M3U8Parser.findGroup=function findGroup(groups,mediaGroupId){for(var i=0;i<groups.length;i++){var group=groups[i];if(group.id===mediaGroupId)return group}},M3U8Parser.convertAVC1ToAVCOTI=function convertAVC1ToAVCOTI(codec){var result,avcdata=codec.split(".");return avcdata.length>2?(result=avcdata.shift()+".",result+=parseInt(avcdata.shift()).toString(16),result+=("000"+parseInt(avcdata.shift()).toString(16)).substr(-4)):result=codec,result},M3U8Parser.resolve=function resolve(url,baseUrl){return url_toolkit.buildAbsoluteURL(baseUrl,url,{alwaysNormalize:!0})},M3U8Parser.parseMasterPlaylist=function parseMasterPlaylist(string,baseurl){var result,levels=[],sessionData={},hasSessionData=!1;function setCodecs(codecs,level){["video","audio"].forEach((function(type){var filtered=codecs.filter((function(codec){return function isCodecType(codec,type){var typeCodes=sampleEntryCodesISO[type];return!!typeCodes&&!0===typeCodes[codec.slice(0,4)]}(codec,type)}));if(filtered.length){var preferred=filtered.filter((function(codec){return 0===codec.lastIndexOf("avc1",0)||0===codec.lastIndexOf("mp4a",0)}));level[type+"Codec"]=preferred.length>0?preferred[0]:filtered[0],codecs=codecs.filter((function(codec){return-1===filtered.indexOf(codec)}))}})),level.unknownCodecs=codecs}for(MASTER_PLAYLIST_REGEX.lastIndex=0;null!=(result=MASTER_PLAYLIST_REGEX.exec(string));)if(result[1]){var level={},attrs=level.attrs=new attr_list(result[1]);level.url=M3U8Parser.resolve(result[2],baseurl);var resolution=attrs.decimalResolution("RESOLUTION");resolution&&(level.width=resolution.width,level.height=resolution.height),level.bitrate=attrs.decimalInteger("AVERAGE-BANDWIDTH")||attrs.decimalInteger("BANDWIDTH"),level.name=attrs.NAME,setCodecs([].concat((attrs.CODECS||"").split(/[ ,]+/)),level),level.videoCodec&&-1!==level.videoCodec.indexOf("avc1")&&(level.videoCodec=M3U8Parser.convertAVC1ToAVCOTI(level.videoCodec)),levels.push(level)}else if(result[3]){var sessionAttrs=new attr_list(result[3]);sessionAttrs["DATA-ID"]&&(hasSessionData=!0,sessionData[sessionAttrs["DATA-ID"]]=sessionAttrs)}return{levels:levels,sessionData:hasSessionData?sessionData:null}},M3U8Parser.parseMasterPlaylistMedia=function parseMasterPlaylistMedia(string,baseurl,type,audioGroups){var result;void 0===audioGroups&&(audioGroups=[]);var medias=[],id=0;for(MASTER_PLAYLIST_MEDIA_REGEX.lastIndex=0;null!==(result=MASTER_PLAYLIST_MEDIA_REGEX.exec(string));){var attrs=new attr_list(result[1]);if(attrs.TYPE===type){var media={attrs:attrs,id:id++,groupId:attrs["GROUP-ID"],instreamId:attrs["INSTREAM-ID"],name:attrs.NAME||attrs.LANGUAGE,type:type,default:"YES"===attrs.DEFAULT,autoselect:"YES"===attrs.AUTOSELECT,forced:"YES"===attrs.FORCED,lang:attrs.LANGUAGE};if(attrs.URI&&(media.url=M3U8Parser.resolve(attrs.URI,baseurl)),audioGroups.length){var groupCodec=M3U8Parser.findGroup(audioGroups,media.groupId);media.audioCodec=groupCodec?groupCodec.codec:audioGroups[0].codec}medias.push(media)}}return medias},M3U8Parser.parseLevelPlaylist=function parseLevelPlaylist(string,baseurl,id,type,levelUrlId){var result,i,levelkey,currentSN=0,totalduration=0,level=new level_Level(baseurl),discontinuityCounter=0,prevFrag=null,frag=new fragment_Fragment,firstPdtIndex=null;for(LEVEL_PLAYLIST_REGEX_FAST.lastIndex=0;null!==(result=LEVEL_PLAYLIST_REGEX_FAST.exec(string));){var duration=result[1];if(duration){frag.duration=parseFloat(duration);var title=(" "+result[2]).slice(1);frag.title=title||null,frag.tagList.push(title?["INF",duration,title]:["INF",duration])}else if(result[3]){if(Object(number.isFiniteNumber)(frag.duration)){var sn=currentSN++;frag.type=type,frag.start=totalduration,levelkey&&(frag.levelkey=levelkey),frag.sn=sn,frag.level=id,frag.cc=discontinuityCounter,frag.urlId=levelUrlId,frag.baseurl=baseurl,frag.relurl=(" "+result[3]).slice(1),assignProgramDateTime(frag,prevFrag),level.fragments.push(frag),prevFrag=frag,totalduration+=frag.duration,frag=new fragment_Fragment}}else if(result[4]){var data=(" "+result[4]).slice(1);prevFrag?frag.setByteRange(data,prevFrag):frag.setByteRange(data)}else if(result[5])frag.rawProgramDateTime=(" "+result[5]).slice(1),frag.tagList.push(["PROGRAM-DATE-TIME",frag.rawProgramDateTime]),null===firstPdtIndex&&(firstPdtIndex=level.fragments.length);else{if(!(result=result[0].match(LEVEL_PLAYLIST_REGEX_SLOW))){logger.logger.warn("No matches on slow regex match for level playlist!");continue}for(i=1;i<result.length&&void 0===result[i];i++);var value1=(" "+result[i+1]).slice(1),value2=(" "+result[i+2]).slice(1);switch(result[i]){case"#":frag.tagList.push(value2?[value1,value2]:[value1]);break;case"PLAYLIST-TYPE":level.type=value1.toUpperCase();break;case"MEDIA-SEQUENCE":currentSN=level.startSN=parseInt(value1);break;case"TARGETDURATION":level.targetduration=parseFloat(value1);break;case"VERSION":level.version=parseInt(value1);break;case"EXTM3U":break;case"ENDLIST":level.live=!1;break;case"DIS":discontinuityCounter++,frag.tagList.push(["DIS"]);break;case"DISCONTINUITY-SEQ":discontinuityCounter=parseInt(value1);break;case"KEY":var keyAttrs=new attr_list(value1),decryptmethod=keyAttrs.enumeratedString("METHOD"),decrypturi=keyAttrs.URI,decryptiv=keyAttrs.hexadecimalInteger("IV");if("com.apple.streamingkeydelivery"===(keyAttrs.KEYFORMAT||"identity")){logger.logger.warn("Keyformat com.apple.streamingkeydelivery is not supported");continue}decryptmethod&&(levelkey=new level_key_LevelKey(baseurl,decrypturi),decrypturi&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(decryptmethod)>=0&&(levelkey.method=decryptmethod,levelkey.key=null,levelkey.iv=decryptiv));break;case"START":var startTimeOffset=new attr_list(value1).decimalFloatingPoint("TIME-OFFSET");Object(number.isFiniteNumber)(startTimeOffset)&&(level.startTimeOffset=startTimeOffset);break;case"MAP":var mapAttrs=new attr_list(value1);frag.relurl=mapAttrs.URI,mapAttrs.BYTERANGE&&frag.setByteRange(mapAttrs.BYTERANGE),frag.baseurl=baseurl,frag.level=id,frag.type=type,frag.sn="initSegment",level.initSegment=frag,(frag=new fragment_Fragment).rawProgramDateTime=level.initSegment.rawProgramDateTime;break;default:logger.logger.warn("line parsed but not handled: "+result)}}}return(frag=prevFrag)&&!frag.relurl&&(level.fragments.pop(),totalduration-=frag.duration),level.totalduration=totalduration,level.averagetargetduration=totalduration/level.fragments.length,level.endSN=currentSN-1,level.startCC=level.fragments[0]?level.fragments[0].cc:0,level.endCC=discontinuityCounter,!level.initSegment&&level.fragments.length&&level.fragments.every((function(frag){return MP4_REGEX_SUFFIX.test(frag.relurl)}))&&(logger.logger.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),(frag=new fragment_Fragment).relurl=level.fragments[0].relurl,frag.baseurl=baseurl,frag.level=id,frag.type=type,frag.sn="initSegment",level.initSegment=frag,level.needSidxRanges=!0),firstPdtIndex&&function backfillProgramDateTimes(fragments,startIndex){for(var fragPrev=fragments[startIndex],i=startIndex-1;i>=0;i--){var frag=fragments[i];frag.programDateTime=fragPrev.programDateTime-1e3*frag.duration,fragPrev=frag}}(level.fragments,firstPdtIndex),level},M3U8Parser}();function assignProgramDateTime(frag,prevFrag){frag.rawProgramDateTime?frag.programDateTime=Date.parse(frag.rawProgramDateTime):(null==prevFrag?void 0:prevFrag.programDateTime)&&(frag.programDateTime=prevFrag.endProgramDateTime),Object(number.isFiniteNumber)(frag.programDateTime)||(frag.programDateTime=null,frag.rawProgramDateTime=null)}var performance=window.performance,playlist_loader=function(_EventHandler){function PlaylistLoader(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.MANIFEST_LOADING,events.default.LEVEL_LOADING,events.default.AUDIO_TRACK_LOADING,events.default.SUBTITLE_TRACK_LOADING)||this).loaders={},_this}!function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(PlaylistLoader,_EventHandler),PlaylistLoader.canHaveQualityLevels=function canHaveQualityLevels(type){return type!==PlaylistContextType.AUDIO_TRACK&&type!==PlaylistContextType.SUBTITLE_TRACK},PlaylistLoader.mapContextToLevelType=function mapContextToLevelType(context){switch(context.type){case PlaylistContextType.AUDIO_TRACK:return PlaylistLevelType.AUDIO;case PlaylistContextType.SUBTITLE_TRACK:return PlaylistLevelType.SUBTITLE;default:return PlaylistLevelType.MAIN}},PlaylistLoader.getResponseUrl=function getResponseUrl(response,context){var url=response.url;return void 0!==url&&0!==url.indexOf("data:")||(url=context.url),url};var _proto=PlaylistLoader.prototype;return _proto.createInternalLoader=function createInternalLoader(context){var config=this.hls.config,PLoader=config.pLoader,Loader=config.loader,loader=new(PLoader||Loader)(config);return context.loader=loader,this.loaders[context.type]=loader,loader},_proto.getInternalLoader=function getInternalLoader(context){return this.loaders[context.type]},_proto.resetInternalLoader=function resetInternalLoader(contextType){this.loaders[contextType]&&delete this.loaders[contextType]},_proto.destroyInternalLoaders=function destroyInternalLoaders(){for(var contextType in this.loaders){var loader=this.loaders[contextType];loader&&loader.destroy(),this.resetInternalLoader(contextType)}},_proto.destroy=function destroy(){this.destroyInternalLoaders(),_EventHandler.prototype.destroy.call(this)},_proto.onManifestLoading=function onManifestLoading(data){this.load({url:data.url,type:PlaylistContextType.MANIFEST,level:0,id:null,responseType:"text"})},_proto.onLevelLoading=function onLevelLoading(data){this.load({url:data.url,type:PlaylistContextType.LEVEL,level:data.level,id:data.id,responseType:"text"})},_proto.onAudioTrackLoading=function onAudioTrackLoading(data){this.load({url:data.url,type:PlaylistContextType.AUDIO_TRACK,level:null,id:data.id,responseType:"text"})},_proto.onSubtitleTrackLoading=function onSubtitleTrackLoading(data){this.load({url:data.url,type:PlaylistContextType.SUBTITLE_TRACK,level:null,id:data.id,responseType:"text"})},_proto.load=function load(context){var config=this.hls.config;logger.logger.debug("Loading playlist of type "+context.type+", level: "+context.level+", id: "+context.id);var maxRetry,timeout,retryDelay,maxRetryDelay,loader=this.getInternalLoader(context);if(loader){var loaderContext=loader.context;if(loaderContext&&loaderContext.url===context.url)return logger.logger.trace("playlist request ongoing"),!1;logger.logger.warn("aborting previous loader for type: "+context.type),loader.abort()}switch(context.type){case PlaylistContextType.MANIFEST:maxRetry=config.manifestLoadingMaxRetry,timeout=config.manifestLoadingTimeOut,retryDelay=config.manifestLoadingRetryDelay,maxRetryDelay=config.manifestLoadingMaxRetryTimeout;break;case PlaylistContextType.LEVEL:maxRetry=0,maxRetryDelay=0,retryDelay=0,timeout=config.levelLoadingTimeOut;break;default:maxRetry=config.levelLoadingMaxRetry,timeout=config.levelLoadingTimeOut,retryDelay=config.levelLoadingRetryDelay,maxRetryDelay=config.levelLoadingMaxRetryTimeout}loader=this.createInternalLoader(context);var loaderConfig={timeout:timeout,maxRetry:maxRetry,retryDelay:retryDelay,maxRetryDelay:maxRetryDelay},loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};return logger.logger.debug("Calling internal loader delegate for URL: "+context.url),loader.load(context,loaderConfig,loaderCallbacks),!0},_proto.loadsuccess=function loadsuccess(response,stats,context,networkDetails){if(void 0===networkDetails&&(networkDetails=null),context.isSidxRequest)return this._handleSidxRequest(response,context),void this._handlePlaylistLoaded(response,stats,context,networkDetails);if(this.resetInternalLoader(context.type),"string"!=typeof response.data)throw new Error('expected responseType of "text" for PlaylistLoader');var string=response.data;stats.tload=performance.now(),0===string.indexOf("#EXTM3U")?string.indexOf("#EXTINF:")>0||string.indexOf("#EXT-X-TARGETDURATION:")>0?this._handleTrackOrLevelPlaylist(response,stats,context,networkDetails):this._handleMasterPlaylist(response,stats,context,networkDetails):this._handleManifestParsingError(response,context,"no EXTM3U delimiter",networkDetails)},_proto.loaderror=function loaderror(response,context,networkDetails){void 0===networkDetails&&(networkDetails=null),this._handleNetworkError(context,networkDetails,!1,response)},_proto.loadtimeout=function loadtimeout(stats,context,networkDetails){void 0===networkDetails&&(networkDetails=null),this._handleNetworkError(context,networkDetails,!0)},_proto._handleMasterPlaylist=function _handleMasterPlaylist(response,stats,context,networkDetails){var hls=this.hls,string=response.data,url=PlaylistLoader.getResponseUrl(response,context),_M3U8Parser$parseMast=m3u8_parser_M3U8Parser.parseMasterPlaylist(string,url),levels=_M3U8Parser$parseMast.levels,sessionData=_M3U8Parser$parseMast.sessionData;if(levels.length){var audioGroups=levels.map((function(level){return{id:level.attrs.AUDIO,codec:level.audioCodec}})),audioTracks=m3u8_parser_M3U8Parser.parseMasterPlaylistMedia(string,url,"AUDIO",audioGroups),subtitles=m3u8_parser_M3U8Parser.parseMasterPlaylistMedia(string,url,"SUBTITLES"),captions=m3u8_parser_M3U8Parser.parseMasterPlaylistMedia(string,url,"CLOSED-CAPTIONS");if(audioTracks.length){var embeddedAudioFound=!1;audioTracks.forEach((function(audioTrack){audioTrack.url||(embeddedAudioFound=!0)})),!1===embeddedAudioFound&&levels[0].audioCodec&&!levels[0].attrs.AUDIO&&(logger.logger.log("audio codec signaled in quality level, but no embedded audio track signaled, create one"),audioTracks.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:{},url:""}))}hls.trigger(events.default.MANIFEST_LOADED,{levels:levels,audioTracks:audioTracks,subtitles:subtitles,captions:captions,url:url,stats:stats,networkDetails:networkDetails,sessionData:sessionData})}else this._handleManifestParsingError(response,context,"no level found in manifest",networkDetails)},_proto._handleTrackOrLevelPlaylist=function _handleTrackOrLevelPlaylist(response,stats,context,networkDetails){var hls=this.hls,id=context.id,level=context.level,type=context.type,url=PlaylistLoader.getResponseUrl(response,context),levelUrlId=Object(number.isFiniteNumber)(id)?id:0,levelId=Object(number.isFiniteNumber)(level)?level:levelUrlId,levelType=PlaylistLoader.mapContextToLevelType(context),levelDetails=m3u8_parser_M3U8Parser.parseLevelPlaylist(response.data,url,levelId,levelType,levelUrlId);if(levelDetails.tload=stats.tload,levelDetails.fragments.length){if(type===PlaylistContextType.MANIFEST){var singleLevel={url:url,details:levelDetails};hls.trigger(events.default.MANIFEST_LOADED,{levels:[singleLevel],audioTracks:[],url:url,stats:stats,networkDetails:networkDetails,sessionData:null})}if(stats.tparsed=performance.now(),levelDetails.needSidxRanges){var sidxUrl=levelDetails.initSegment.url;this.load({url:sidxUrl,isSidxRequest:!0,type:type,level:level,levelDetails:levelDetails,id:id,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer"})}else context.levelDetails=levelDetails,this._handlePlaylistLoaded(response,stats,context,networkDetails)}else hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.NETWORK_ERROR,details:errors.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:url,reason:"no fragments found in level",level:"number"==typeof context.level?context.level:void 0})},_proto._handleSidxRequest=function _handleSidxRequest(response,context){if("string"==typeof response.data)throw new Error("sidx request must be made with responseType of array buffer");var sidxInfo=mp4demuxer.default.parseSegmentIndex(new Uint8Array(response.data));if(sidxInfo){var sidxReferences=sidxInfo.references,levelDetails=context.levelDetails;sidxReferences.forEach((function(segmentRef,index){var segRefInfo=segmentRef.info;if(levelDetails){var frag=levelDetails.fragments[index];0===frag.byteRange.length&&frag.setByteRange(String(1+segRefInfo.end-segRefInfo.start)+"@"+String(segRefInfo.start))}})),levelDetails&&levelDetails.initSegment.setByteRange(String(sidxInfo.moovEndOffset)+"@0")}},_proto._handleManifestParsingError=function _handleManifestParsingError(response,context,reason,networkDetails){this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.NETWORK_ERROR,details:errors.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:!0,url:response.url,reason:reason,networkDetails:networkDetails})},_proto._handleNetworkError=function _handleNetworkError(context,networkDetails,timeout,response){var details,fatal;void 0===timeout&&(timeout=!1),void 0===response&&(response=null),logger.logger.info("A network error occured while loading a "+context.type+"-type playlist");var loader=this.getInternalLoader(context);switch(context.type){case PlaylistContextType.MANIFEST:details=timeout?errors.ErrorDetails.MANIFEST_LOAD_TIMEOUT:errors.ErrorDetails.MANIFEST_LOAD_ERROR,fatal=!0;break;case PlaylistContextType.LEVEL:details=timeout?errors.ErrorDetails.LEVEL_LOAD_TIMEOUT:errors.ErrorDetails.LEVEL_LOAD_ERROR,fatal=!1;break;case PlaylistContextType.AUDIO_TRACK:details=timeout?errors.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal=!1;break;default:fatal=!1}loader&&(loader.abort(),this.resetInternalLoader(context.type));var errorData={type:errors.ErrorTypes.NETWORK_ERROR,details:details,fatal:fatal,url:context.url,loader:loader,context:context,networkDetails:networkDetails};response&&(errorData.response=response),this.hls.trigger(events.default.ERROR,errorData)},_proto._handlePlaylistLoaded=function _handlePlaylistLoaded(response,stats,context,networkDetails){var type=context.type,level=context.level,id=context.id,levelDetails=context.levelDetails;if(levelDetails&&levelDetails.targetduration)if(PlaylistLoader.canHaveQualityLevels(context.type))this.hls.trigger(events.default.LEVEL_LOADED,{details:levelDetails,level:level||0,id:id||0,stats:stats,networkDetails:networkDetails});else switch(type){case PlaylistContextType.AUDIO_TRACK:this.hls.trigger(events.default.AUDIO_TRACK_LOADED,{details:levelDetails,id:id,stats:stats,networkDetails:networkDetails});break;case PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(events.default.SUBTITLE_TRACK_LOADED,{details:levelDetails,id:id,stats:stats,networkDetails:networkDetails})}else this._handleManifestParsingError(response,context,"invalid target duration",networkDetails)},PlaylistLoader}(event_handler);var fragment_loader=function(_EventHandler){function FragmentLoader(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.FRAG_LOADING)||this).loaders={},_this}!function fragment_loader_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(FragmentLoader,_EventHandler);var _proto=FragmentLoader.prototype;return _proto.destroy=function destroy(){var loaders=this.loaders;for(var loaderName in loaders){var loader=loaders[loaderName];loader&&loader.destroy()}this.loaders={},_EventHandler.prototype.destroy.call(this)},_proto.onFragLoading=function onFragLoading(data){var frag=data.frag,type=frag.type,loaders=this.loaders,config=this.hls.config,FragmentILoader=config.fLoader,DefaultILoader=config.loader;frag.loaded=0;var loaderContext,loaderConfig,loaderCallbacks,loader=loaders[type];loader&&(logger.logger.warn("abort previous fragment loader for type: "+type),loader.abort()),loader=loaders[type]=frag.loader=config.fLoader?new FragmentILoader(config):new DefaultILoader(config),loaderContext={url:frag.url,frag:frag,responseType:"arraybuffer",progressData:!1};var start=frag.byteRangeStartOffset,end=frag.byteRangeEndOffset;Object(number.isFiniteNumber)(start)&&Object(number.isFiniteNumber)(end)&&(loaderContext.rangeStart=start,loaderContext.rangeEnd=end),loaderConfig={timeout:config.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:config.fragLoadingMaxRetryTimeout},loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this),onProgress:this.loadprogress.bind(this)},loader.load(loaderContext,loaderConfig,loaderCallbacks)},_proto.loadsuccess=function loadsuccess(response,stats,context,networkDetails){void 0===networkDetails&&(networkDetails=null);var payload=response.data,frag=context.frag;frag.loader=void 0,this.loaders[frag.type]=void 0,this.hls.trigger(events.default.FRAG_LOADED,{payload:payload,frag:frag,stats:stats,networkDetails:networkDetails})},_proto.loaderror=function loaderror(response,context,networkDetails){void 0===networkDetails&&(networkDetails=null);var frag=context.frag,loader=frag.loader;loader&&loader.abort(),this.loaders[frag.type]=void 0,this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.NETWORK_ERROR,details:errors.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:context.frag,response:response,networkDetails:networkDetails})},_proto.loadtimeout=function loadtimeout(stats,context,networkDetails){void 0===networkDetails&&(networkDetails=null);var frag=context.frag,loader=frag.loader;loader&&loader.abort(),this.loaders[frag.type]=void 0,this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.NETWORK_ERROR,details:errors.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:context.frag,networkDetails:networkDetails})},_proto.loadprogress=function loadprogress(stats,context,data,networkDetails){void 0===networkDetails&&(networkDetails=null);var frag=context.frag;frag.loaded=stats.loaded,this.hls.trigger(events.default.FRAG_LOAD_PROGRESS,{frag:frag,stats:stats,networkDetails:networkDetails})},FragmentLoader}(event_handler);var key_loader=function(_EventHandler){function KeyLoader(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.KEY_LOADING)||this).loaders={},_this.decryptkey=null,_this.decrypturl=null,_this}!function key_loader_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(KeyLoader,_EventHandler);var _proto=KeyLoader.prototype;return _proto.destroy=function destroy(){for(var loaderName in this.loaders){var loader=this.loaders[loaderName];loader&&loader.destroy()}this.loaders={},_EventHandler.prototype.destroy.call(this)},_proto.onKeyLoading=function onKeyLoading(data){var frag=data.frag,type=frag.type,loader=this.loaders[type];if(frag.decryptdata){var uri=frag.decryptdata.uri;if(uri!==this.decrypturl||null===this.decryptkey){var config=this.hls.config;if(loader&&(logger.logger.warn("abort previous key loader for type:"+type),loader.abort()),!uri)return void logger.logger.warn("key uri is falsy");frag.loader=this.loaders[type]=new config.loader(config),this.decrypturl=uri,this.decryptkey=null;var loaderContext={url:uri,frag:frag,responseType:"arraybuffer"},loaderConfig={timeout:config.fragLoadingTimeOut,maxRetry:0,retryDelay:config.fragLoadingRetryDelay,maxRetryDelay:config.fragLoadingMaxRetryTimeout},loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};frag.loader.load(loaderContext,loaderConfig,loaderCallbacks)}else this.decryptkey&&(frag.decryptdata.key=this.decryptkey,this.hls.trigger(events.default.KEY_LOADED,{frag:frag}))}else logger.logger.warn("Missing decryption data on fragment in onKeyLoading")},_proto.loadsuccess=function loadsuccess(response,stats,context){var frag=context.frag;frag.decryptdata?(this.decryptkey=frag.decryptdata.key=new Uint8Array(response.data),frag.loader=void 0,delete this.loaders[frag.type],this.hls.trigger(events.default.KEY_LOADED,{frag:frag})):logger.logger.error("after key load, decryptdata unset")},_proto.loaderror=function loaderror(response,context){var frag=context.frag,loader=frag.loader;loader&&loader.abort(),delete this.loaders[frag.type],this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.NETWORK_ERROR,details:errors.ErrorDetails.KEY_LOAD_ERROR,fatal:!1,frag:frag,response:response})},_proto.loadtimeout=function loadtimeout(stats,context){var frag=context.frag,loader=frag.loader;loader&&loader.abort(),delete this.loaders[frag.type],this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.NETWORK_ERROR,details:errors.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:!1,frag:frag})},KeyLoader}(event_handler);var FragmentState_NOT_LOADED="NOT_LOADED",FragmentState_APPENDING="APPENDING",FragmentState_PARTIAL="PARTIAL",FragmentState_OK="OK",fragment_tracker_FragmentTracker=function(_EventHandler){function FragmentTracker(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.BUFFER_APPENDED,events.default.FRAG_BUFFERED,events.default.FRAG_LOADED)||this).bufferPadding=.2,_this.fragments=Object.create(null),_this.timeRanges=Object.create(null),_this.config=hls.config,_this}!function fragment_tracker_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(FragmentTracker,_EventHandler);var _proto=FragmentTracker.prototype;return _proto.destroy=function destroy(){this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.config=null,event_handler.prototype.destroy.call(this),_EventHandler.prototype.destroy.call(this)},_proto.getBufferedFrag=function getBufferedFrag(position,levelType){var fragments=this.fragments,bufferedFrags=Object.keys(fragments).filter((function(key){var fragmentEntity=fragments[key];if(fragmentEntity.body.type!==levelType)return!1;if(!fragmentEntity.buffered)return!1;var frag=fragmentEntity.body;return frag.startPTS<=position&&position<=frag.endPTS}));if(0===bufferedFrags.length)return null;var bufferedFragKey=bufferedFrags.pop();return fragments[bufferedFragKey].body},_proto.detectEvictedFragments=function detectEvictedFragments(elementaryStream,timeRange){var _this2=this;Object.keys(this.fragments).forEach((function(key){var fragmentEntity=_this2.fragments[key];if(fragmentEntity&&fragmentEntity.buffered){var esData=fragmentEntity.range[elementaryStream];if(esData)for(var fragmentTimes=esData.time,i=0;i<fragmentTimes.length;i++){var time=fragmentTimes[i];if(!_this2.isTimeBuffered(time.startPTS,time.endPTS,timeRange)){_this2.removeFragment(fragmentEntity.body);break}}}}))},_proto.detectPartialFragments=function detectPartialFragments(fragment){var _this3=this,fragKey=this.getFragmentKey(fragment),fragmentEntity=this.fragments[fragKey];fragmentEntity&&(fragmentEntity.buffered=!0,Object.keys(this.timeRanges).forEach((function(elementaryStream){if(fragment.hasElementaryStream(elementaryStream)){var timeRange=_this3.timeRanges[elementaryStream];fragmentEntity.range[elementaryStream]=_this3.getBufferedTimes(fragment.startPTS,fragment.endPTS,timeRange)}})))},_proto.getBufferedTimes=function getBufferedTimes(startPTS,endPTS,timeRange){for(var startTime,endTime,fragmentTimes=[],fragmentPartial=!1,i=0;i<timeRange.length;i++){if(startTime=timeRange.start(i)-this.bufferPadding,endTime=timeRange.end(i)+this.bufferPadding,startPTS>=startTime&&endPTS<=endTime){fragmentTimes.push({startPTS:Math.max(startPTS,timeRange.start(i)),endPTS:Math.min(endPTS,timeRange.end(i))});break}if(startPTS<endTime&&endPTS>startTime)fragmentTimes.push({startPTS:Math.max(startPTS,timeRange.start(i)),endPTS:Math.min(endPTS,timeRange.end(i))}),fragmentPartial=!0;else if(endPTS<=startTime)break}return{time:fragmentTimes,partial:fragmentPartial}},_proto.getFragmentKey=function getFragmentKey(fragment){return fragment.type+"_"+fragment.level+"_"+fragment.urlId+"_"+fragment.sn},_proto.getPartialFragment=function getPartialFragment(time){var timePadding,startTime,endTime,_this4=this,bestFragment=null,bestOverlap=0;return Object.keys(this.fragments).forEach((function(key){var fragmentEntity=_this4.fragments[key];_this4.isPartial(fragmentEntity)&&(startTime=fragmentEntity.body.startPTS-_this4.bufferPadding,endTime=fragmentEntity.body.endPTS+_this4.bufferPadding,time>=startTime&&time<=endTime&&(timePadding=Math.min(time-startTime,endTime-time),bestOverlap<=timePadding&&(bestFragment=fragmentEntity.body,bestOverlap=timePadding)))})),bestFragment},_proto.getState=function getState(fragment){var fragKey=this.getFragmentKey(fragment),fragmentEntity=this.fragments[fragKey],state=FragmentState_NOT_LOADED;return void 0!==fragmentEntity&&(state=fragmentEntity.buffered?!0===this.isPartial(fragmentEntity)?FragmentState_PARTIAL:FragmentState_OK:FragmentState_APPENDING),state},_proto.isPartial=function isPartial(fragmentEntity){return!0===fragmentEntity.buffered&&(void 0!==fragmentEntity.range.video&&!0===fragmentEntity.range.video.partial||void 0!==fragmentEntity.range.audio&&!0===fragmentEntity.range.audio.partial)},_proto.isTimeBuffered=function isTimeBuffered(startPTS,endPTS,timeRange){for(var startTime,endTime,i=0;i<timeRange.length;i++){if(startTime=timeRange.start(i)-this.bufferPadding,endTime=timeRange.end(i)+this.bufferPadding,startPTS>=startTime&&endPTS<=endTime)return!0;if(endPTS<=startTime)return!1}return!1},_proto.onFragLoaded=function onFragLoaded(e){var fragment=e.frag;Object(number.isFiniteNumber)(fragment.sn)&&!fragment.bitrateTest&&(this.fragments[this.getFragmentKey(fragment)]={body:fragment,range:Object.create(null),buffered:!1})},_proto.onBufferAppended=function onBufferAppended(e){var _this5=this;this.timeRanges=e.timeRanges,Object.keys(this.timeRanges).forEach((function(elementaryStream){var timeRange=_this5.timeRanges[elementaryStream];_this5.detectEvictedFragments(elementaryStream,timeRange)}))},_proto.onFragBuffered=function onFragBuffered(e){this.detectPartialFragments(e.frag)},_proto.hasFragment=function hasFragment(fragment){var fragKey=this.getFragmentKey(fragment);return void 0!==this.fragments[fragKey]},_proto.removeFragment=function removeFragment(fragment){var fragKey=this.getFragmentKey(fragment);delete this.fragments[fragKey]},_proto.removeAllFragments=function removeAllFragments(){this.fragments=Object.create(null)},FragmentTracker}(event_handler),binary_search={search:function search(list,comparisonFn){for(var minIndex=0,maxIndex=list.length-1,currentIndex=null,currentElement=null;minIndex<=maxIndex;){var comparisonResult=comparisonFn(currentElement=list[currentIndex=(minIndex+maxIndex)/2|0]);if(comparisonResult>0)minIndex=currentIndex+1;else{if(!(comparisonResult<0))return currentElement;maxIndex=currentIndex-1}}return null}},BufferHelper=function(){function BufferHelper(){}return BufferHelper.isBuffered=function isBuffered(media,position){try{if(media)for(var buffered=media.buffered,i=0;i<buffered.length;i++)if(position>=buffered.start(i)&&position<=buffered.end(i))return!0}catch(error){}return!1},BufferHelper.bufferInfo=function bufferInfo(media,pos,maxHoleDuration){try{if(media){var i,vbuffered=media.buffered,buffered=[];for(i=0;i<vbuffered.length;i++)buffered.push({start:vbuffered.start(i),end:vbuffered.end(i)});return this.bufferedInfo(buffered,pos,maxHoleDuration)}}catch(error){}return{len:0,start:pos,end:pos,nextStart:void 0}},BufferHelper.bufferedInfo=function bufferedInfo(buffered,pos,maxHoleDuration){buffered.sort((function(a,b){var diff=a.start-b.start;return diff||b.end-a.end}));var buffered2=[];if(maxHoleDuration)for(var i=0;i<buffered.length;i++){var buf2len=buffered2.length;if(buf2len){var buf2end=buffered2[buf2len-1].end;buffered[i].start-buf2end<maxHoleDuration?buffered[i].end>buf2end&&(buffered2[buf2len-1].end=buffered[i].end):buffered2.push(buffered[i])}else buffered2.push(buffered[i])}else buffered2=buffered;for(var bufferStartNext,bufferLen=0,bufferStart=pos,bufferEnd=pos,_i=0;_i<buffered2.length;_i++){var start=buffered2[_i].start,end=buffered2[_i].end;if(pos+maxHoleDuration>=start&&pos<end)bufferStart=start,bufferLen=(bufferEnd=end)-pos;else if(pos+maxHoleDuration<start){bufferStartNext=start;break}}return{len:bufferLen,start:bufferStart,end:bufferEnd,nextStart:bufferStartNext}},BufferHelper}(),eventemitter3=__webpack_require__("./node_modules/eventemitter3/index.js"),webworkify_webpack=__webpack_require__("./node_modules/webworkify-webpack/index.js"),demuxer_inline=__webpack_require__("./src/demux/demuxer-inline.js");function getMediaSource(){return window.MediaSource||window.WebKitMediaSource}var get_self_scope=__webpack_require__("./src/utils/get-self-scope.js");var Observer=function(_EventEmitter){function Observer(){return _EventEmitter.apply(this,arguments)||this}return function observer_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(Observer,_EventEmitter),Observer.prototype.trigger=function trigger(event){for(var _len=arguments.length,data=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)data[_key-1]=arguments[_key];this.emit.apply(this,[event,event].concat(data))},Observer}(eventemitter3.EventEmitter),global=Object(get_self_scope.getSelfScope)(),demuxer_MediaSource=getMediaSource()||{isTypeSupported:function isTypeSupported(){return!1}},demux_demuxer=function(){function Demuxer(hls,id){var _this=this;this.hls=hls,this.id=id;var observer=this.observer=new Observer,config=hls.config,forwardMessage=function forwardMessage(ev,data){(data=data||{}).frag=_this.frag,data.id=_this.id,hls.trigger(ev,data)};observer.on(events.default.FRAG_DECRYPTED,forwardMessage),observer.on(events.default.FRAG_PARSING_INIT_SEGMENT,forwardMessage),observer.on(events.default.FRAG_PARSING_DATA,forwardMessage),observer.on(events.default.FRAG_PARSED,forwardMessage),observer.on(events.default.ERROR,forwardMessage),observer.on(events.default.FRAG_PARSING_METADATA,forwardMessage),observer.on(events.default.FRAG_PARSING_USERDATA,forwardMessage),observer.on(events.default.INIT_PTS_FOUND,forwardMessage);var typeSupported={mp4:demuxer_MediaSource.isTypeSupported("video/mp4"),mpeg:demuxer_MediaSource.isTypeSupported("audio/mpeg"),mp3:demuxer_MediaSource.isTypeSupported('audio/mp4; codecs="mp3"')},vendor=navigator.vendor;if(config.enableWorker&&"undefined"!=typeof Worker){var w;logger.logger.log("demuxing in webworker");try{w=this.w=webworkify_webpack("./src/demux/demuxer-worker.js"),this.onwmsg=this.onWorkerMessage.bind(this),w.addEventListener("message",this.onwmsg),w.onerror=function(event){hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.OTHER_ERROR,details:errors.ErrorDetails.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",err:{message:event.message+" ("+event.filename+":"+event.lineno+")"}})},w.postMessage({cmd:"init",typeSupported:typeSupported,vendor:vendor,id:id,config:JSON.stringify(config)})}catch(err){logger.logger.warn("Error in worker:",err),logger.logger.error("Error while initializing DemuxerWorker, fallback on DemuxerInline"),w&&global.URL.revokeObjectURL(w.objectURL),this.demuxer=new demuxer_inline.default(observer,typeSupported,config,vendor),this.w=void 0}}else this.demuxer=new demuxer_inline.default(observer,typeSupported,config,vendor)}var _proto=Demuxer.prototype;return _proto.destroy=function destroy(){var w=this.w;if(w)w.removeEventListener("message",this.onwmsg),w.terminate(),this.w=null;else{var demuxer=this.demuxer;demuxer&&(demuxer.destroy(),this.demuxer=null)}var observer=this.observer;observer&&(observer.removeAllListeners(),this.observer=null)},_proto.push=function push(data,initSegment,audioCodec,videoCodec,frag,duration,accurateTimeOffset,defaultInitPTS){var w=this.w,timeOffset=Object(number.isFiniteNumber)(frag.startPTS)?frag.startPTS:frag.start,decryptdata=frag.decryptdata,lastFrag=this.frag,discontinuity=!(lastFrag&&frag.cc===lastFrag.cc),trackSwitch=!(lastFrag&&frag.level===lastFrag.level),nextSN=lastFrag&&frag.sn===lastFrag.sn+1,contiguous=!trackSwitch&&nextSN;if(discontinuity&&logger.logger.log(this.id+":discontinuity detected"),trackSwitch&&logger.logger.log(this.id+":switch detected"),this.frag=frag,w)w.postMessage({cmd:"demux",data:data,decryptdata:decryptdata,initSegment:initSegment,audioCodec:audioCodec,videoCodec:videoCodec,timeOffset:timeOffset,discontinuity:discontinuity,trackSwitch:trackSwitch,contiguous:contiguous,duration:duration,accurateTimeOffset:accurateTimeOffset,defaultInitPTS:defaultInitPTS},data instanceof ArrayBuffer?[data]:[]);else{var demuxer=this.demuxer;demuxer&&demuxer.push(data,decryptdata,initSegment,audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS)}},_proto.onWorkerMessage=function onWorkerMessage(ev){var data=ev.data,hls=this.hls;switch(data.event){case"init":global.URL.revokeObjectURL(this.w.objectURL);break;case events.default.FRAG_PARSING_DATA:data.data.data1=new Uint8Array(data.data1),data.data2&&(data.data.data2=new Uint8Array(data.data2));default:data.data=data.data||{},data.data.frag=this.frag,data.data.id=this.id,hls.trigger(data.event,data.data)}},Demuxer}();function addGroupId(level,type,id){switch(type){case"audio":level.audioGroupIds||(level.audioGroupIds=[]),level.audioGroupIds.push(id);break;case"text":level.textGroupIds||(level.textGroupIds=[]),level.textGroupIds.push(id)}}function updatePTS(fragments,fromIdx,toIdx){var fragFrom=fragments[fromIdx],fragTo=fragments[toIdx],fragToPTS=fragTo.startPTS;if(Object(number.isFiniteNumber)(fragToPTS))toIdx>fromIdx?(fragFrom.duration=fragToPTS-fragFrom.start,fragFrom.duration<0&&logger.logger.warn("negative duration computed for frag "+fragFrom.sn+",level "+fragFrom.level+", there should be some duration drift between playlist and fragment!")):(fragTo.duration=fragFrom.start-fragToPTS,fragTo.duration<0&&logger.logger.warn("negative duration computed for frag "+fragTo.sn+",level "+fragTo.level+", there should be some duration drift between playlist and fragment!"));else if(toIdx>fromIdx){var contiguous=fragFrom.cc===fragTo.cc;fragTo.start=fragFrom.start+(contiguous&&fragFrom.minEndPTS?fragFrom.minEndPTS-fragFrom.start:fragFrom.duration)}else fragTo.start=Math.max(fragFrom.start-fragTo.duration,0)}function updateFragPTSDTS(details,frag,startPTS,endPTS,startDTS,endDTS){var maxStartPTS=startPTS,minEndPTS=endPTS;if(Object(number.isFiniteNumber)(frag.startPTS)){var deltaPTS=Math.abs(frag.startPTS-startPTS);Object(number.isFiniteNumber)(frag.deltaPTS)?frag.deltaPTS=Math.max(deltaPTS,frag.deltaPTS):frag.deltaPTS=deltaPTS,maxStartPTS=Math.max(startPTS,frag.startPTS),startPTS=Math.min(startPTS,frag.startPTS),minEndPTS=Math.min(endPTS,frag.endPTS),endPTS=Math.max(endPTS,frag.endPTS),startDTS=Math.min(startDTS,frag.startDTS),endDTS=Math.max(endDTS,frag.endDTS)}var drift=startPTS-frag.start;frag.start=frag.startPTS=startPTS,frag.maxStartPTS=maxStartPTS,frag.endPTS=endPTS,frag.minEndPTS=minEndPTS,frag.startDTS=startDTS,frag.endDTS=endDTS,frag.duration=endPTS-startPTS;var fragIdx,fragments,i,sn=frag.sn;if(!details||sn<details.startSN||sn>details.endSN)return 0;for(fragIdx=sn-details.startSN,(fragments=details.fragments)[fragIdx]=frag,i=fragIdx;i>0;i--)updatePTS(fragments,i,i-1);for(i=fragIdx;i<fragments.length-1;i++)updatePTS(fragments,i,i+1);return details.PTSKnown=!0,drift}function mergeDetails(oldDetails,newDetails){newDetails.initSegment&&oldDetails.initSegment&&(newDetails.initSegment=oldDetails.initSegment);var PTSFrag,ccOffset=0;if(mapFragmentIntersection(oldDetails,newDetails,(function(oldFrag,newFrag){ccOffset=oldFrag.cc-newFrag.cc,Object(number.isFiniteNumber)(oldFrag.startPTS)&&(newFrag.start=newFrag.startPTS=oldFrag.startPTS,newFrag.endPTS=oldFrag.endPTS,newFrag.duration=oldFrag.duration,newFrag.backtracked=oldFrag.backtracked,newFrag.dropped=oldFrag.dropped,PTSFrag=newFrag),newDetails.PTSKnown=!0})),newDetails.PTSKnown){if(ccOffset){logger.logger.log("discontinuity sliding from playlist, take drift into account");for(var newFragments=newDetails.fragments,i=0;i<newFragments.length;i++)newFragments[i].cc+=ccOffset}PTSFrag?updateFragPTSDTS(newDetails,PTSFrag,PTSFrag.startPTS,PTSFrag.endPTS,PTSFrag.startDTS,PTSFrag.endDTS):function adjustSliding(oldPlaylist,newPlaylist){var delta=newPlaylist.startSN-oldPlaylist.startSN,oldFragments=oldPlaylist.fragments,newFragments=newPlaylist.fragments;if(delta<0||delta>oldFragments.length)return;for(var i=0;i<newFragments.length;i++)newFragments[i].start+=oldFragments[delta].start}(oldDetails,newDetails),newDetails.PTSKnown=oldDetails.PTSKnown}}function mapFragmentIntersection(oldPlaylist,newPlaylist,intersectionFn){if(oldPlaylist&&newPlaylist)for(var start=Math.max(oldPlaylist.startSN,newPlaylist.startSN)-newPlaylist.startSN,end=Math.min(oldPlaylist.endSN,newPlaylist.endSN)-newPlaylist.startSN,delta=newPlaylist.startSN-oldPlaylist.startSN,i=start;i<=end;i++){var oldFrag=oldPlaylist.fragments[delta+i],newFrag=newPlaylist.fragments[i];if(!oldFrag||!newFrag)break;intersectionFn(oldFrag,newFrag,i)}}function computeReloadInterval(currentPlaylist,newPlaylist,lastRequestTime){var reloadInterval=1e3*(newPlaylist.averagetargetduration?newPlaylist.averagetargetduration:newPlaylist.targetduration),minReloadInterval=reloadInterval/2;return currentPlaylist&&newPlaylist.endSN===currentPlaylist.endSN&&(reloadInterval=minReloadInterval),lastRequestTime&&(reloadInterval=Math.max(minReloadInterval,reloadInterval-(window.performance.now()-lastRequestTime))),Math.round(reloadInterval)}var time_ranges={toString:function toString(r){for(var log="",len=r.length,i=0;i<len;i++)log+="["+r.start(i).toFixed(3)+","+r.end(i).toFixed(3)+"]";return log}};function adjustPts(sliding,details){details.fragments.forEach((function(frag){if(frag){var start=frag.start+sliding;frag.start=frag.startPTS=start,frag.endPTS=start+frag.duration}})),details.PTSKnown=!0}function alignStream(lastFrag,lastLevel,details){!function alignDiscontinuities(lastFrag,details,lastLevel){if(function shouldAlignOnDiscontinuities(lastFrag,lastLevel,details){var shouldAlign=!1;return lastLevel&&lastLevel.details&&details&&(details.endCC>details.startCC||lastFrag&&lastFrag.cc<details.startCC)&&(shouldAlign=!0),shouldAlign}(lastFrag,lastLevel,details)){var referenceFrag=function findDiscontinuousReferenceFrag(prevDetails,curDetails){var prevFrags=prevDetails.fragments,curFrags=curDetails.fragments;if(curFrags.length&&prevFrags.length){var prevStartFrag=function findFirstFragWithCC(fragments,cc){for(var firstFrag=null,i=0;i<fragments.length;i+=1){var currentFrag=fragments[i];if(currentFrag&&currentFrag.cc===cc){firstFrag=currentFrag;break}}return firstFrag}(prevFrags,curFrags[0].cc);if(prevStartFrag&&(!prevStartFrag||prevStartFrag.startPTS))return prevStartFrag;logger.logger.log("No frag in previous level to align on")}else logger.logger.log("No fragments to align")}(lastLevel.details,details);referenceFrag&&(logger.logger.log("Adjusting PTS using last level due to CC increase within current level"),adjustPts(referenceFrag.start,details))}}(lastFrag,details,lastLevel),!details.PTSKnown&&lastLevel&&function alignPDT(details,lastDetails){if(lastDetails&&lastDetails.fragments.length){if(!details.hasProgramDateTime||!lastDetails.hasProgramDateTime)return;var lastPDT=lastDetails.fragments[0].programDateTime,sliding=(details.fragments[0].programDateTime-lastPDT)/1e3+lastDetails.fragments[0].start;Object(number.isFiniteNumber)(sliding)&&(logger.logger.log("adjusting PTS using programDateTime delta, sliding:"+sliding.toFixed(3)),adjustPts(sliding,details))}}(details,lastLevel.details)}function findFragmentByPDT(fragments,PDTValue,maxFragLookUpTolerance){if(null===PDTValue||!Array.isArray(fragments)||!fragments.length||!Object(number.isFiniteNumber)(PDTValue))return null;if(PDTValue<(fragments[0].programDateTime||0))return null;if(PDTValue>=(fragments[fragments.length-1].endProgramDateTime||0))return null;maxFragLookUpTolerance=maxFragLookUpTolerance||0;for(var seg=0;seg<fragments.length;++seg){var frag=fragments[seg];if(pdtWithinToleranceTest(PDTValue,maxFragLookUpTolerance,frag))return frag}return null}function findFragmentByPTS(fragPrevious,fragments,bufferEnd,maxFragLookUpTolerance){void 0===bufferEnd&&(bufferEnd=0),void 0===maxFragLookUpTolerance&&(maxFragLookUpTolerance=0);var fragNext=null;if(fragPrevious?fragNext=fragments[fragPrevious.sn-fragments[0].sn+1]:0===bufferEnd&&0===fragments[0].start&&(fragNext=fragments[0]),fragNext&&0===fragmentWithinToleranceTest(bufferEnd,maxFragLookUpTolerance,fragNext))return fragNext;var foundFragment=binary_search.search(fragments,fragmentWithinToleranceTest.bind(null,bufferEnd,maxFragLookUpTolerance));return foundFragment||fragNext}function fragmentWithinToleranceTest(bufferEnd,maxFragLookUpTolerance,candidate){void 0===bufferEnd&&(bufferEnd=0),void 0===maxFragLookUpTolerance&&(maxFragLookUpTolerance=0);var candidateLookupTolerance=Math.min(maxFragLookUpTolerance,candidate.duration+(candidate.deltaPTS?candidate.deltaPTS:0));return candidate.start+candidate.duration-candidateLookupTolerance<=bufferEnd?1:candidate.start-candidateLookupTolerance>bufferEnd&&candidate.start?-1:0}function pdtWithinToleranceTest(pdtBufferEnd,maxFragLookUpTolerance,candidate){var candidateLookupTolerance=1e3*Math.min(maxFragLookUpTolerance,candidate.duration+(candidate.deltaPTS?candidate.deltaPTS:0));return(candidate.endProgramDateTime||0)-candidateLookupTolerance>pdtBufferEnd}var gap_controller_GapController=function(){function GapController(config,media,fragmentTracker,hls){this.config=config,this.media=media,this.fragmentTracker=fragmentTracker,this.hls=hls,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1}var _proto=GapController.prototype;return _proto.poll=function poll(lastCurrentTime){var config=this.config,media=this.media,stalled=this.stalled,currentTime=media.currentTime,seeking=media.seeking,seeked=this.seeking&&!seeking,beginSeek=!this.seeking&&seeking;if(this.seeking=seeking,currentTime===lastCurrentTime){if((beginSeek||seeked)&&(this.stalled=null),!media.paused&&!media.ended&&0!==media.playbackRate&&media.buffered.length){var bufferInfo=BufferHelper.bufferInfo(media,currentTime,0),isBuffered=bufferInfo.len>0,nextStart=bufferInfo.nextStart||0;if(isBuffered||nextStart){if(seeking){var hasEnoughBuffer=bufferInfo.len>2,noBufferGap=!nextStart||nextStart-currentTime>2&&!this.fragmentTracker.getPartialFragment(currentTime);if(hasEnoughBuffer||noBufferGap)return;this.moved=!1}if(!this.moved&&this.stalled){var startJump=Math.max(nextStart,bufferInfo.start||0)-currentTime;if(startJump>0&&startJump<=2)return void this._trySkipBufferHole(null)}var tnow=self.performance.now();if(null!==stalled){var stalledDuration=tnow-stalled;!seeking&&stalledDuration>=250&&this._reportStall(bufferInfo.len);var bufferedWithHoles=BufferHelper.bufferInfo(media,currentTime,config.maxBufferHole);this._tryFixBufferStall(bufferedWithHoles,stalledDuration)}else this.stalled=tnow}}}else if(this.moved=!0,null!==stalled){if(this.stallReported){var _stalledDuration=self.performance.now()-stalled;logger.logger.warn("playback not stuck anymore @"+currentTime+", after "+Math.round(_stalledDuration)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}},_proto._tryFixBufferStall=function _tryFixBufferStall(bufferInfo,stalledDurationMs){var config=this.config,fragmentTracker=this.fragmentTracker,currentTime=this.media.currentTime,partial=fragmentTracker.getPartialFragment(currentTime);if(partial&&this._trySkipBufferHole(partial))return;bufferInfo.len>config.maxBufferHole&&stalledDurationMs>1e3*config.highBufferWatchdogPeriod&&(logger.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())},_proto._reportStall=function _reportStall(bufferLen){var hls=this.hls,media=this.media;this.stallReported||(this.stallReported=!0,logger.logger.warn("Playback stalling at @"+media.currentTime+" due to low buffer (buffer="+bufferLen+")"),hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:bufferLen}))},_proto._trySkipBufferHole=function _trySkipBufferHole(partial){for(var config=this.config,hls=this.hls,media=this.media,currentTime=media.currentTime,lastEndTime=0,i=0;i<media.buffered.length;i++){var startTime=media.buffered.start(i);if(currentTime+config.maxBufferHole>=lastEndTime&&currentTime<startTime){var targetTime=Math.max(startTime+.05,media.currentTime+.1);return logger.logger.warn("skipping hole, adjusting currentTime from "+currentTime+" to "+targetTime),this.moved=!0,this.stalled=null,media.currentTime=targetTime,partial&&hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+currentTime+" to "+targetTime,frag:partial}),targetTime}lastEndTime=media.buffered.end(i)}return 0},_proto._tryNudgeBuffer=function _tryNudgeBuffer(){var config=this.config,hls=this.hls,media=this.media,currentTime=media.currentTime,nudgeRetry=(this.nudgeRetry||0)+1;if(this.nudgeRetry=nudgeRetry,nudgeRetry<config.nudgeMaxRetry){var targetTime=currentTime+nudgeRetry*config.nudgeOffset;logger.logger.warn("Nudging 'currentTime' from "+currentTime+" to "+targetTime),media.currentTime=targetTime,hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else logger.logger.error("Playhead still not moving while enough data buffered @"+currentTime+" after "+config.nudgeMaxRetry+" nudges"),hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})},GapController}();function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}var TaskLoop=function(_EventHandler){function TaskLoop(hls){for(var _this,_len=arguments.length,events=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)events[_key-1]=arguments[_key];return(_this=_EventHandler.call.apply(_EventHandler,[this,hls].concat(events))||this)._boundTick=void 0,_this._tickTimer=null,_this._tickInterval=null,_this._tickCallCount=0,_this._boundTick=_this.tick.bind(_assertThisInitialized(_this)),_this}!function task_loop_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(TaskLoop,_EventHandler);var _proto=TaskLoop.prototype;return _proto.onHandlerDestroying=function onHandlerDestroying(){this.clearNextTick(),this.clearInterval()},_proto.hasInterval=function hasInterval(){return!!this._tickInterval},_proto.hasNextTick=function hasNextTick(){return!!this._tickTimer},_proto.setInterval=function setInterval(millis){return!this._tickInterval&&(this._tickInterval=self.setInterval(this._boundTick,millis),!0)},_proto.clearInterval=function clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)},_proto.clearNextTick=function clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)},_proto.tick=function tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&(this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)),this._tickCallCount=0)},_proto.doTick=function doTick(){},TaskLoop}(event_handler);var State_STOPPED="STOPPED",State_STARTING="STARTING",State_IDLE="IDLE",State_PAUSED="PAUSED",State_KEY_LOADING="KEY_LOADING",State_FRAG_LOADING="FRAG_LOADING",State_FRAG_LOADING_WAITING_RETRY="FRAG_LOADING_WAITING_RETRY",State_WAITING_TRACK="WAITING_TRACK",State_PARSING="PARSING",State_PARSED="PARSED",State_BUFFER_FLUSHING="BUFFER_FLUSHING",State_ENDED="ENDED",State_ERROR="ERROR",State_WAITING_INIT_PTS="WAITING_INIT_PTS",State_WAITING_LEVEL="WAITING_LEVEL",base_stream_controller_BaseStreamController=function(_TaskLoop){function BaseStreamController(){return _TaskLoop.apply(this,arguments)||this}!function base_stream_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(BaseStreamController,_TaskLoop);var _proto=BaseStreamController.prototype;return _proto.doTick=function doTick(){},_proto.startLoad=function startLoad(){},_proto.stopLoad=function stopLoad(){var frag=this.fragCurrent;frag&&(frag.loader&&frag.loader.abort(),this.fragmentTracker.removeFragment(frag)),this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=State_STOPPED},_proto._streamEnded=function _streamEnded(bufferInfo,levelDetails){var fragCurrent=this.fragCurrent,fragmentTracker=this.fragmentTracker;if(!levelDetails.live&&fragCurrent&&!fragCurrent.backtracked&&fragCurrent.sn===levelDetails.endSN&&!bufferInfo.nextStart){var fragState=fragmentTracker.getState(fragCurrent);return fragState===FragmentState_PARTIAL||fragState===FragmentState_OK}return!1},_proto.onMediaSeeking=function onMediaSeeking(){var config=this.config,media=this.media,mediaBuffer=this.mediaBuffer,state=this.state,currentTime=media?media.currentTime:null,bufferInfo=BufferHelper.bufferInfo(mediaBuffer||media,currentTime,this.config.maxBufferHole);if(logger.logger.log("media seeking to "+(Object(number.isFiniteNumber)(currentTime)?currentTime.toFixed(3):currentTime)),state===State_FRAG_LOADING){var fragCurrent=this.fragCurrent;if(0===bufferInfo.len&&fragCurrent){var tolerance=config.maxFragLookUpTolerance,fragStartOffset=fragCurrent.start-tolerance,fragEndOffset=fragCurrent.start+fragCurrent.duration+tolerance;currentTime<fragStartOffset||currentTime>fragEndOffset?(fragCurrent.loader&&(logger.logger.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),fragCurrent.loader.abort()),this.fragCurrent=null,this.fragPrevious=null,this.state=State_IDLE):logger.logger.log("seeking outside of buffer but within currently loaded fragment range")}}else state===State_ENDED&&(0===bufferInfo.len&&(this.fragPrevious=null,this.fragCurrent=null),this.state=State_IDLE);media&&(this.lastCurrentTime=currentTime),this.loadedmetadata||(this.nextLoadPosition=this.startPosition=currentTime),this.tick()},_proto.onMediaEnded=function onMediaEnded(){this.startPosition=this.lastCurrentTime=0},_proto.onHandlerDestroying=function onHandlerDestroying(){this.stopLoad(),_TaskLoop.prototype.onHandlerDestroying.call(this)},_proto.onHandlerDestroyed=function onHandlerDestroyed(){this.state=State_STOPPED,this.fragmentTracker=null},_proto.computeLivePosition=function computeLivePosition(sliding,levelDetails){var targetLatency=void 0!==this.config.liveSyncDuration?this.config.liveSyncDuration:this.config.liveSyncDurationCount*levelDetails.targetduration;return sliding+Math.max(0,levelDetails.totalduration-targetLatency)},BaseStreamController}(TaskLoop);function stream_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var chromeOrFirefox,stream_controller=function(_BaseStreamController){function StreamController(hls,fragmentTracker){var _this;return(_this=_BaseStreamController.call(this,hls,events.default.MEDIA_ATTACHED,events.default.MEDIA_DETACHING,events.default.MANIFEST_LOADING,events.default.MANIFEST_PARSED,events.default.LEVEL_LOADED,events.default.LEVELS_UPDATED,events.default.KEY_LOADED,events.default.FRAG_LOADED,events.default.FRAG_LOAD_EMERGENCY_ABORTED,events.default.FRAG_PARSING_INIT_SEGMENT,events.default.FRAG_PARSING_DATA,events.default.FRAG_PARSED,events.default.ERROR,events.default.AUDIO_TRACK_SWITCHING,events.default.AUDIO_TRACK_SWITCHED,events.default.BUFFER_CREATED,events.default.BUFFER_APPENDED,events.default.BUFFER_FLUSHED)||this).fragmentTracker=fragmentTracker,_this.config=hls.config,_this.audioCodecSwap=!1,_this._state=State_STOPPED,_this.stallReported=!1,_this.gapController=null,_this.altAudio=!1,_this.audioOnly=!1,_this.bitrateTest=!1,_this}!function stream_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(StreamController,_BaseStreamController);var _proto=StreamController.prototype;return _proto.startLoad=function startLoad(startPosition){if(this.levels){var lastCurrentTime=this.lastCurrentTime,hls=this.hls;if(this.stopLoad(),this.setInterval(100),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var startLevel=hls.startLevel;-1===startLevel&&(hls.config.testBandwidth?(startLevel=0,this.bitrateTest=!0):startLevel=hls.nextAutoLevel),this.level=hls.nextLoadLevel=startLevel,this.loadedmetadata=!1}lastCurrentTime>0&&-1===startPosition&&(logger.logger.log("override startPosition with lastCurrentTime @"+lastCurrentTime.toFixed(3)),startPosition=lastCurrentTime),this.state=State_IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=startPosition,this.tick()}else this.forceStartLoad=!0,this.state=State_STOPPED},_proto.stopLoad=function stopLoad(){this.forceStartLoad=!1,_BaseStreamController.prototype.stopLoad.call(this)},_proto.doTick=function doTick(){switch(this.state){case State_BUFFER_FLUSHING:this.fragLoadError=0;break;case State_IDLE:this._doTickIdle();break;case State_WAITING_LEVEL:var level=this.levels[this.level];level&&level.details&&(this.state=State_IDLE);break;case State_FRAG_LOADING_WAITING_RETRY:var now=window.performance.now(),retryDate=this.retryDate;(!retryDate||now>=retryDate||this.media&&this.media.seeking)&&(logger.logger.log("mediaController: retryDate reached, switch back to IDLE state"),this.state=State_IDLE)}this._checkBuffer(),this._checkFragmentChanged()},_proto._doTickIdle=function _doTickIdle(){var hls=this.hls,config=hls.config,media=this.media;if(void 0!==this.levelLastLoaded&&(media||!this.startFragRequested&&config.startFragPrefetch))if(this.altAudio&&this.audioOnly)this.demuxer.frag=null;else{var pos;pos=this.loadedmetadata?media.currentTime:this.nextLoadPosition;var level=hls.nextLoadLevel,levelInfo=this.levels[level];if(levelInfo){var maxBufLen,levelBitrate=levelInfo.bitrate;maxBufLen=levelBitrate?Math.max(8*config.maxBufferSize/levelBitrate,config.maxBufferLength):config.maxBufferLength,maxBufLen=Math.min(maxBufLen,config.maxMaxBufferLength);var maxBufferHole=pos<config.maxBufferHole?Math.max(2,config.maxBufferHole):config.maxBufferHole,bufferInfo=BufferHelper.bufferInfo(this.mediaBuffer?this.mediaBuffer:media,pos,maxBufferHole),bufferLen=bufferInfo.len;if(!(bufferLen>=maxBufLen)){logger.logger.trace("buffer length of "+bufferLen.toFixed(3)+" is below max of "+maxBufLen.toFixed(3)+". checking for more payload ..."),this.level=hls.nextLoadLevel=level;var levelDetails=levelInfo.details;if(!levelDetails||levelDetails.live&&this.levelLastLoaded!==level)this.state=State_WAITING_LEVEL;else{if(this._streamEnded(bufferInfo,levelDetails)){var data={};return this.altAudio&&(data.type="video"),this.hls.trigger(events.default.BUFFER_EOS,data),void(this.state=State_ENDED)}this._fetchPayloadOrEos(pos,bufferInfo,levelDetails)}}}}},_proto._fetchPayloadOrEos=function _fetchPayloadOrEos(pos,bufferInfo,levelDetails){var fragPrevious=this.fragPrevious,fragments=(this.level,levelDetails.fragments),fragLen=fragments.length;if(0!==fragLen){var frag,start=fragments[0].start,end=fragments[fragLen-1].start+fragments[fragLen-1].duration,bufferEnd=bufferInfo.end;if(levelDetails.initSegment&&!levelDetails.initSegment.data)frag=levelDetails.initSegment;else if(levelDetails.live){var initialLiveManifestSize=this.config.initialLiveManifestSize;if(fragLen<initialLiveManifestSize)return void logger.logger.warn("Can not start playback of a level, reason: not enough fragments "+fragLen+" < "+initialLiveManifestSize);if(null===(frag=this._ensureFragmentAtLivePoint(levelDetails,bufferEnd,start,end,fragPrevious,fragments)))return}else bufferEnd<start&&(frag=fragments[0]);frag||(frag=this._findFragment(start,fragPrevious,fragLen,fragments,bufferEnd,end,levelDetails)),frag&&(frag.encrypted?this._loadKey(frag,levelDetails):this._loadFragment(frag,levelDetails,pos,bufferEnd))}},_proto._ensureFragmentAtLivePoint=function _ensureFragmentAtLivePoint(levelDetails,bufferEnd,start,end,fragPrevious,fragments){var frag,config=this.hls.config,media=this.media,maxLatency=1/0;if(void 0!==config.liveMaxLatencyDuration?maxLatency=config.liveMaxLatencyDuration:Object(number.isFiniteNumber)(config.liveMaxLatencyDurationCount)&&(maxLatency=config.liveMaxLatencyDurationCount*levelDetails.targetduration),bufferEnd<Math.max(start-config.maxFragLookUpTolerance,end-maxLatency)){var liveSyncPosition=this.liveSyncPosition=this.computeLivePosition(start,levelDetails);bufferEnd=liveSyncPosition,media&&!media.paused&&media.readyState&&media.duration>liveSyncPosition&&liveSyncPosition>media.currentTime&&(logger.logger.log("buffer end: "+bufferEnd.toFixed(3)+" is located too far from the end of live sliding playlist, reset currentTime to : "+liveSyncPosition.toFixed(3)),media.currentTime=liveSyncPosition),this.nextLoadPosition=liveSyncPosition}if(levelDetails.PTSKnown&&bufferEnd>end&&media&&media.readyState)return null;if(this.startFragRequested&&!levelDetails.PTSKnown&&fragPrevious)if(levelDetails.hasProgramDateTime)logger.logger.log("live playlist, switching playlist, load frag with same PDT: "+fragPrevious.programDateTime),frag=findFragmentByPDT(fragments,fragPrevious.endProgramDateTime,config.maxFragLookUpTolerance);else{var targetSN=fragPrevious.sn+1;if(targetSN>=levelDetails.startSN&&targetSN<=levelDetails.endSN){var fragNext=fragments[targetSN-levelDetails.startSN];fragPrevious.cc===fragNext.cc&&(frag=fragNext,logger.logger.log("live playlist, switching playlist, load frag with next SN: "+frag.sn))}frag||(frag=binary_search.search(fragments,(function(frag){return fragPrevious.cc-frag.cc})))&&logger.logger.log("live playlist, switching playlist, load frag with same CC: "+frag.sn)}return frag},_proto._findFragment=function _findFragment(start,fragPreviousLoad,fragmentIndexRange,fragments,bufferEnd,end,levelDetails){var fragNextLoad,config=this.hls.config;bufferEnd<end?fragNextLoad=findFragmentByPTS(fragPreviousLoad,fragments,bufferEnd,bufferEnd>end-config.maxFragLookUpTolerance?0:config.maxFragLookUpTolerance):fragNextLoad=fragments[fragmentIndexRange-1];if(fragNextLoad){var curSNIdx=fragNextLoad.sn-levelDetails.startSN,sameLevel=fragPreviousLoad&&fragNextLoad.level===fragPreviousLoad.level,prevSnFrag=fragments[curSNIdx-1],nextSnFrag=fragments[curSNIdx+1];if(fragPreviousLoad&&fragNextLoad.sn===fragPreviousLoad.sn)if(sameLevel&&!fragNextLoad.backtracked)if(fragNextLoad.sn<levelDetails.endSN){var deltaPTS=fragPreviousLoad.deltaPTS;deltaPTS&&deltaPTS>config.maxBufferHole&&fragPreviousLoad.dropped&&curSNIdx?(fragNextLoad=prevSnFrag,logger.logger.warn("Previous fragment was dropped with large PTS gap between audio and video. Maybe fragment is not starting with a keyframe? Loading previous one to try to overcome this")):(fragNextLoad=nextSnFrag,this.fragmentTracker.getState(fragNextLoad)!==FragmentState_OK&&logger.logger.log("Re-loading fragment with SN: "+fragNextLoad.sn))}else fragNextLoad=null;else fragNextLoad.backtracked&&(nextSnFrag&&nextSnFrag.backtracked?(logger.logger.warn("Already backtracked from fragment "+nextSnFrag.sn+", will not backtrack to fragment "+fragNextLoad.sn+". Loading fragment "+nextSnFrag.sn),fragNextLoad=nextSnFrag):(logger.logger.warn("Loaded fragment with dropped frames, backtracking 1 segment to find a keyframe"),fragNextLoad.dropped=0,prevSnFrag?(fragNextLoad=prevSnFrag).backtracked=!0:curSNIdx&&(fragNextLoad=null)))}return fragNextLoad},_proto._loadKey=function _loadKey(frag,levelDetails){logger.logger.log("Loading key for "+frag.sn+" of ["+levelDetails.startSN+"-"+levelDetails.endSN+"], level "+this.level),this.state=State_KEY_LOADING,this.hls.trigger(events.default.KEY_LOADING,{frag:frag})},_proto._loadFragment=function _loadFragment(frag,levelDetails,pos,bufferEnd){var fragState=this.fragmentTracker.getState(frag);this.fragCurrent=frag,"initSegment"!==frag.sn&&(this.startFragRequested=!0),Object(number.isFiniteNumber)(frag.sn)&&!frag.bitrateTest&&(this.nextLoadPosition=frag.start+frag.duration),frag.backtracked||fragState===FragmentState_NOT_LOADED||fragState===FragmentState_PARTIAL?(frag.autoLevel=this.hls.autoLevelEnabled,frag.bitrateTest=this.bitrateTest,logger.logger.log("Loading "+frag.sn+" of ["+levelDetails.startSN+"-"+levelDetails.endSN+"], level "+this.level+", "+(this.loadedmetadata?"currentTime":"nextLoadPosition")+": "+parseFloat(pos.toFixed(3))+", bufferEnd: "+parseFloat(bufferEnd.toFixed(3))),this.hls.trigger(events.default.FRAG_LOADING,{frag:frag}),this.demuxer||(this.demuxer=new demux_demuxer(this.hls,"main")),this.state=State_FRAG_LOADING):fragState===FragmentState_APPENDING&&this._reduceMaxBufferLength(frag.duration)&&this.fragmentTracker.removeFragment(frag)},_proto.getBufferedFrag=function getBufferedFrag(position){return this.fragmentTracker.getBufferedFrag(position,PlaylistLevelType.MAIN)},_proto.followingBufferedFrag=function followingBufferedFrag(frag){return frag?this.getBufferedFrag(frag.endPTS+.5):null},_proto._checkFragmentChanged=function _checkFragmentChanged(){var fragPlayingCurrent,currentTime,video=this.media;if(video&&video.readyState&&!1===video.seeking&&((currentTime=video.currentTime)>this.lastCurrentTime&&(this.lastCurrentTime=currentTime),BufferHelper.isBuffered(video,currentTime)?fragPlayingCurrent=this.getBufferedFrag(currentTime):BufferHelper.isBuffered(video,currentTime+.1)&&(fragPlayingCurrent=this.getBufferedFrag(currentTime+.1)),fragPlayingCurrent)){var fragPlaying=fragPlayingCurrent;if(fragPlaying!==this.fragPlaying){this.hls.trigger(events.default.FRAG_CHANGED,{frag:fragPlaying});var fragPlayingLevel=fragPlaying.level;this.fragPlaying&&this.fragPlaying.level===fragPlayingLevel||this.hls.trigger(events.default.LEVEL_SWITCHED,{level:fragPlayingLevel}),this.fragPlaying=fragPlaying}}},_proto.immediateLevelSwitch=function immediateLevelSwitch(){if(logger.logger.log("immediateLevelSwitch"),!this.immediateSwitch){this.immediateSwitch=!0;var previouslyPaused,media=this.media;media?(previouslyPaused=media.paused)||media.pause():previouslyPaused=!0,this.previouslyPaused=previouslyPaused}var fragCurrent=this.fragCurrent;fragCurrent&&fragCurrent.loader&&fragCurrent.loader.abort(),this.fragCurrent=null,this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},_proto.immediateLevelSwitchEnd=function immediateLevelSwitchEnd(){var media=this.media;media&&media.buffered.length&&(this.immediateSwitch=!1,media.currentTime>0&&BufferHelper.isBuffered(media,media.currentTime)&&(media.currentTime-=1e-4),this.previouslyPaused||media.play())},_proto.nextLevelSwitch=function nextLevelSwitch(){var media=this.media;if(media&&media.readyState){var fetchdelay,fragPlayingCurrent=this.getBufferedFrag(media.currentTime);if(fragPlayingCurrent&&fragPlayingCurrent.startPTS>1&&this.flushMainBuffer(0,fragPlayingCurrent.startPTS-1),media.paused)fetchdelay=0;else{var nextLevelId=this.hls.nextLoadLevel,nextLevel=this.levels[nextLevelId],fragLastKbps=this.fragLastKbps;fetchdelay=fragLastKbps&&this.fragCurrent?this.fragCurrent.duration*nextLevel.bitrate/(1e3*fragLastKbps)+1:0}var bufferedFrag=this.getBufferedFrag(media.currentTime+fetchdelay);if(bufferedFrag){var nextBufferedFrag=this.followingBufferedFrag(bufferedFrag);if(nextBufferedFrag){var fragCurrent=this.fragCurrent;fragCurrent&&fragCurrent.loader&&fragCurrent.loader.abort(),this.fragCurrent=null;var startPts=Math.max(bufferedFrag.endPTS,nextBufferedFrag.maxStartPTS+Math.min(this.config.maxFragLookUpTolerance,nextBufferedFrag.duration));this.flushMainBuffer(startPts,Number.POSITIVE_INFINITY)}}}},_proto.flushMainBuffer=function flushMainBuffer(startOffset,endOffset){this.state=State_BUFFER_FLUSHING;var flushScope={startOffset:startOffset,endOffset:endOffset};this.altAudio&&(flushScope.type="video"),this.hls.trigger(events.default.BUFFER_FLUSHING,flushScope)},_proto.onMediaAttached=function onMediaAttached(data){var media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),this.onvended=this.onMediaEnded.bind(this),media.addEventListener("seeking",this.onvseeking),media.addEventListener("seeked",this.onvseeked),media.addEventListener("ended",this.onvended);var config=this.config;this.levels&&config.autoStartLoad&&this.hls.startLoad(config.startPosition),this.gapController=new gap_controller_GapController(config,media,this.fragmentTracker,this.hls)},_proto.onMediaDetaching=function onMediaDetaching(){var media=this.media;media&&media.ended&&(logger.logger.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0);var levels=this.levels;levels&&levels.forEach((function(level){level.details&&level.details.fragments.forEach((function(fragment){fragment.backtracked=void 0}))})),media&&(media.removeEventListener("seeking",this.onvseeking),media.removeEventListener("seeked",this.onvseeked),media.removeEventListener("ended",this.onvended),this.onvseeking=this.onvseeked=this.onvended=null),this.fragmentTracker.removeAllFragments(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.stopLoad()},_proto.onMediaSeeked=function onMediaSeeked(){var media=this.media,currentTime=media?media.currentTime:void 0;Object(number.isFiniteNumber)(currentTime)&&logger.logger.log("media seeked to "+currentTime.toFixed(3)),this.tick()},_proto.onManifestLoading=function onManifestLoading(){logger.logger.log("trigger BUFFER_RESET"),this.hls.trigger(events.default.BUFFER_RESET),this.fragmentTracker.removeAllFragments(),this.stalled=!1,this.startPosition=this.lastCurrentTime=0},_proto.onManifestParsed=function onManifestParsed(data){var codec,aac=!1,heaac=!1;data.levels.forEach((function(level){(codec=level.audioCodec)&&(-1!==codec.indexOf("mp4a.40.2")&&(aac=!0),-1!==codec.indexOf("mp4a.40.5")&&(heaac=!0))})),this.audioCodecSwitch=aac&&heaac,this.audioCodecSwitch&&logger.logger.log("both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.altAudio=data.altAudio,this.levels=data.levels,this.startFragRequested=!1;var config=this.config;(config.autoStartLoad||this.forceStartLoad)&&this.hls.startLoad(config.startPosition)},_proto.onLevelLoaded=function onLevelLoaded(data){var newDetails=data.details,newLevelId=data.level,lastLevel=this.levels[this.levelLastLoaded],curLevel=this.levels[newLevelId],duration=newDetails.totalduration,sliding=0;if(logger.logger.log("level "+newLevelId+" loaded ["+newDetails.startSN+","+newDetails.endSN+"],duration:"+duration),newDetails.live||curLevel.details&&curLevel.details.live){var curDetails=curLevel.details;curDetails&&newDetails.fragments.length>0?(mergeDetails(curDetails,newDetails),sliding=newDetails.fragments[0].start,this.liveSyncPosition=this.computeLivePosition(sliding,curDetails),newDetails.PTSKnown&&Object(number.isFiniteNumber)(sliding)?logger.logger.log("live playlist sliding:"+sliding.toFixed(3)):(logger.logger.log("live playlist - outdated PTS, unknown sliding"),alignStream(this.fragPrevious,lastLevel,newDetails))):(logger.logger.log("live playlist - first load, unknown sliding"),newDetails.PTSKnown=!1,alignStream(this.fragPrevious,lastLevel,newDetails))}else newDetails.PTSKnown=!1;if(curLevel.details=newDetails,this.levelLastLoaded=newLevelId,this.hls.trigger(events.default.LEVEL_UPDATED,{details:newDetails,level:newLevelId}),!1===this.startFragRequested){if(-1===this.startPosition||-1===this.lastCurrentTime){var startTimeOffset=newDetails.startTimeOffset;Object(number.isFiniteNumber)(startTimeOffset)?(startTimeOffset<0&&(logger.logger.log("negative start time offset "+startTimeOffset+", count from end of last fragment"),startTimeOffset=sliding+duration+startTimeOffset),logger.logger.log("start time offset found in playlist, adjust startPosition to "+startTimeOffset),this.startPosition=startTimeOffset):newDetails.live?(this.startPosition=this.computeLivePosition(sliding,newDetails),logger.logger.log("configure startPosition to "+this.startPosition)):this.startPosition=0,this.lastCurrentTime=this.startPosition}this.nextLoadPosition=this.startPosition}this.state===State_WAITING_LEVEL&&(this.state=State_IDLE),this.tick()},_proto.onKeyLoaded=function onKeyLoaded(){this.state===State_KEY_LOADING&&(this.state=State_IDLE,this.tick())},_proto.onFragLoaded=function onFragLoaded(data){var fragCurrent=this.fragCurrent,hls=this.hls,levels=this.levels,media=this.media,fragLoaded=data.frag;if(this.state===State_FRAG_LOADING&&fragCurrent&&"main"===fragLoaded.type&&fragLoaded.level===fragCurrent.level&&fragLoaded.sn===fragCurrent.sn){var stats=data.stats,currentLevel=levels[fragCurrent.level],details=currentLevel.details;if(this.bitrateTest=!1,this.stats=stats,logger.logger.log("Loaded "+fragCurrent.sn+" of ["+details.startSN+" ,"+details.endSN+"],level "+fragCurrent.level),fragLoaded.bitrateTest&&hls.nextLoadLevel)this.state=State_IDLE,this.startFragRequested=!1,stats.tparsed=stats.tbuffered=window.performance.now(),hls.trigger(events.default.FRAG_BUFFERED,{stats:stats,frag:fragCurrent,id:"main"}),this.tick();else if("initSegment"===fragLoaded.sn)this.state=State_IDLE,stats.tparsed=stats.tbuffered=window.performance.now(),details.initSegment.data=data.payload,hls.trigger(events.default.FRAG_BUFFERED,{stats:stats,frag:fragCurrent,id:"main"}),this.tick();else{logger.logger.log("Parsing "+fragCurrent.sn+" of ["+details.startSN+" ,"+details.endSN+"],level "+fragCurrent.level+", cc "+fragCurrent.cc),this.state=State_PARSING,this.pendingBuffering=!0,this.appended=!1,fragLoaded.bitrateTest&&(fragLoaded.bitrateTest=!1,this.fragmentTracker.onFragLoaded({frag:fragLoaded}));var accurateTimeOffset=!(media&&media.seeking)&&(details.PTSKnown||!details.live),initSegmentData=details.initSegment?details.initSegment.data:[],audioCodec=this._getAudioCodec(currentLevel);(this.demuxer=this.demuxer||new demux_demuxer(this.hls,"main")).push(data.payload,initSegmentData,audioCodec,currentLevel.videoCodec,fragCurrent,details.totalduration,accurateTimeOffset)}}this.fragLoadError=0},_proto.onFragParsingInitSegment=function onFragParsingInitSegment(data){var fragCurrent=this.fragCurrent,fragNew=data.frag;if(fragCurrent&&"main"===data.id&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State_PARSING){var trackName,track,tracks=data.tracks;if(this.audioOnly=tracks.audio&&!tracks.video,this.altAudio&&!this.audioOnly&&delete tracks.audio,track=tracks.audio){var audioCodec=this.levels[this.level].audioCodec,ua=navigator.userAgent.toLowerCase();audioCodec&&this.audioCodecSwap&&(logger.logger.log("swapping playlist audio codec"),audioCodec=-1!==audioCodec.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),this.audioCodecSwitch&&1!==track.metadata.channelCount&&-1===ua.indexOf("firefox")&&(audioCodec="mp4a.40.5"),-1!==ua.indexOf("android")&&"audio/mpeg"!==track.container&&(audioCodec="mp4a.40.2",logger.logger.log("Android: force audio codec to "+audioCodec)),track.levelCodec=audioCodec,track.id=data.id}for(trackName in(track=tracks.video)&&(track.levelCodec=this.levels[this.level].videoCodec,track.id=data.id),this.hls.trigger(events.default.BUFFER_CODECS,tracks),tracks){track=tracks[trackName],logger.logger.log("main track:"+trackName+",container:"+track.container+",codecs[level/parsed]=["+track.levelCodec+"/"+track.codec+"]");var initSegment=track.initSegment;initSegment&&(this.appended=!0,this.pendingBuffering=!0,this.hls.trigger(events.default.BUFFER_APPENDING,{type:trackName,data:initSegment,parent:"main",content:"initSegment"}))}this.tick()}},_proto.onFragParsingData=function onFragParsingData(data){var _this2=this,fragCurrent=this.fragCurrent,fragNew=data.frag;if(fragCurrent&&"main"===data.id&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&("audio"!==data.type||!this.altAudio)&&this.state===State_PARSING){var level=this.levels[this.level],frag=fragCurrent;if(Object(number.isFiniteNumber)(data.endPTS)||(data.endPTS=data.startPTS+fragCurrent.duration,data.endDTS=data.startDTS+fragCurrent.duration),!0===data.hasAudio&&frag.addElementaryStream(ElementaryStreamTypes.AUDIO),!0===data.hasVideo&&frag.addElementaryStream(ElementaryStreamTypes.VIDEO),logger.logger.log("Parsed "+data.type+",PTS:["+data.startPTS.toFixed(3)+","+data.endPTS.toFixed(3)+"],DTS:["+data.startDTS.toFixed(3)+"/"+data.endDTS.toFixed(3)+"],nb:"+data.nb+",dropped:"+(data.dropped||0)),"video"===data.type)if(frag.dropped=data.dropped,frag.dropped)if(frag.backtracked)logger.logger.warn("Already backtracked on this fragment, appending with the gap",frag.sn);else{var levelDetails=level.details;if(!levelDetails||frag.sn!==levelDetails.startSN)return logger.logger.warn("missing video frame(s), backtracking fragment",frag.sn),this.fragmentTracker.removeFragment(frag),frag.backtracked=!0,this.nextLoadPosition=data.startPTS,this.state=State_IDLE,this.fragPrevious=frag,this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),void this.tick();logger.logger.warn("missing video frame(s) on first frag, appending with gap",frag.sn)}else frag.backtracked=!1;var drift=updateFragPTSDTS(level.details,frag,data.startPTS,data.endPTS,data.startDTS,data.endDTS),hls=this.hls;hls.trigger(events.default.LEVEL_PTS_UPDATED,{details:level.details,level:this.level,drift:drift,type:data.type,start:data.startPTS,end:data.endPTS}),[data.data1,data.data2].forEach((function(buffer){buffer&&buffer.length&&_this2.state===State_PARSING&&(_this2.appended=!0,_this2.pendingBuffering=!0,hls.trigger(events.default.BUFFER_APPENDING,{type:data.type,data:buffer,parent:"main",content:"data"}))})),this.tick()}},_proto.onFragParsed=function onFragParsed(data){var fragCurrent=this.fragCurrent,fragNew=data.frag;fragCurrent&&"main"===data.id&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State_PARSING&&(this.stats.tparsed=window.performance.now(),this.state=State_PARSED,this._checkAppendedParsed())},_proto.onAudioTrackSwitching=function onAudioTrackSwitching(data){var fromAltAudio=this.altAudio,altAudio=!!data.url,trackId=data.id;if(!altAudio){if(this.mediaBuffer!==this.media){logger.logger.log("switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var fragCurrent=this.fragCurrent;fragCurrent.loader&&(logger.logger.log("switching to main audio track, cancel main fragment load"),fragCurrent.loader.abort()),this.fragCurrent=null,this.fragPrevious=null,this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),this.state=State_IDLE}var hls=this.hls;fromAltAudio&&hls.trigger(events.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),hls.trigger(events.default.AUDIO_TRACK_SWITCHED,{id:trackId})}},_proto.onAudioTrackSwitched=function onAudioTrackSwitched(data){var trackId=data.id,altAudio=!!this.hls.audioTracks[trackId].url;if(altAudio){var videoBuffer=this.videoBuffer;videoBuffer&&this.mediaBuffer!==videoBuffer&&(logger.logger.log("switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=videoBuffer)}this.altAudio=altAudio,this.tick()},_proto.onBufferCreated=function onBufferCreated(data){var mediaTrack,name,tracks=data.tracks,alternate=!1;for(var type in tracks){var track=tracks[type];"main"===track.id?(name=type,mediaTrack=track,"video"===type&&(this.videoBuffer=tracks[type].buffer)):alternate=!0}alternate&&mediaTrack?(logger.logger.log("alternate track found, use "+name+".buffered to schedule main fragment loading"),this.mediaBuffer=mediaTrack.buffer):this.mediaBuffer=this.media},_proto.onBufferAppended=function onBufferAppended(data){if("main"===data.parent){var state=this.state;state!==State_PARSING&&state!==State_PARSED||(this.pendingBuffering=data.pending>0,this._checkAppendedParsed())}},_proto._checkAppendedParsed=function _checkAppendedParsed(){if(!(this.state!==State_PARSED||this.appended&&this.pendingBuffering)){var frag=this.fragCurrent;if(frag){var media=this.mediaBuffer?this.mediaBuffer:this.media;logger.logger.log("main buffered : "+time_ranges.toString(media.buffered)),this.fragPrevious=frag;var stats=this.stats;stats.tbuffered=window.performance.now(),this.fragLastKbps=Math.round(8*stats.total/(stats.tbuffered-stats.tfirst)),this.hls.trigger(events.default.FRAG_BUFFERED,{stats:stats,frag:frag,id:"main"}),this.state=State_IDLE}(this.loadedmetadata||this.startPosition<=0)&&this.tick()}},_proto.onError=function onError(data){var frag=data.frag||this.fragCurrent;if(!frag||"main"===frag.type){var mediaBuffered=!!this.media&&BufferHelper.isBuffered(this.media,this.media.currentTime)&&BufferHelper.isBuffered(this.media,this.media.currentTime+.5);switch(data.details){case errors.ErrorDetails.FRAG_LOAD_ERROR:case errors.ErrorDetails.FRAG_LOAD_TIMEOUT:case errors.ErrorDetails.KEY_LOAD_ERROR:case errors.ErrorDetails.KEY_LOAD_TIMEOUT:if(!data.fatal)if(this.fragLoadError+1<=this.config.fragLoadingMaxRetry){var delay=Math.min(Math.pow(2,this.fragLoadError)*this.config.fragLoadingRetryDelay,this.config.fragLoadingMaxRetryTimeout);logger.logger.warn("mediaController: frag loading failed, retry in "+delay+" ms"),this.retryDate=window.performance.now()+delay,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.fragLoadError++,this.state=State_FRAG_LOADING_WAITING_RETRY}else logger.logger.error("mediaController: "+data.details+" reaches max retry, redispatch as fatal ..."),data.fatal=!0,this.state=State_ERROR;break;case errors.ErrorDetails.LEVEL_LOAD_ERROR:case errors.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==State_ERROR&&(data.fatal?(this.state=State_ERROR,logger.logger.warn("streamController: "+data.details+",switch to "+this.state+" state ...")):data.levelRetry||this.state!==State_WAITING_LEVEL||(this.state=State_IDLE));break;case errors.ErrorDetails.BUFFER_FULL_ERROR:"main"!==data.parent||this.state!==State_PARSING&&this.state!==State_PARSED||(mediaBuffered?(this._reduceMaxBufferLength(this.config.maxBufferLength),this.state=State_IDLE):(logger.logger.warn("buffer full error also media.currentTime is not buffered, flush everything"),this.fragCurrent=null,this.flushMainBuffer(0,Number.POSITIVE_INFINITY)))}}},_proto._reduceMaxBufferLength=function _reduceMaxBufferLength(minLength){var config=this.config;return config.maxMaxBufferLength>=minLength&&(config.maxMaxBufferLength/=2,logger.logger.warn("main:reduce max buffer length to "+config.maxMaxBufferLength+"s"),!0)},_proto._checkBuffer=function _checkBuffer(){var media=this.media;if(media&&0!==media.readyState){var buffered=(this.mediaBuffer?this.mediaBuffer:media).buffered;!this.loadedmetadata&&buffered.length?(this.loadedmetadata=!0,this._seekToStartPos()):this.immediateSwitch?this.immediateLevelSwitchEnd():this.gapController.poll(this.lastCurrentTime,buffered)}},_proto.onFragLoadEmergencyAborted=function onFragLoadEmergencyAborted(){this.state=State_IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tick()},_proto.onBufferFlushed=function onBufferFlushed(){var media=this.mediaBuffer?this.mediaBuffer:this.media;if(media){var elementaryStreamType=this.audioOnly?ElementaryStreamTypes.AUDIO:ElementaryStreamTypes.VIDEO;this.fragmentTracker.detectEvictedFragments(elementaryStreamType,media.buffered)}this.state=State_IDLE,this.fragPrevious=null},_proto.onLevelsUpdated=function onLevelsUpdated(data){this.levels=data.levels},_proto.swapAudioCodec=function swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap},_proto._seekToStartPos=function _seekToStartPos(){var media=this.media,currentTime=media.currentTime,startPosition=this.startPosition;if(currentTime!==startPosition&&startPosition>=0){if(media.seeking)return void logger.logger.log("could not seek to "+startPosition+", already seeking at "+currentTime);var delta=(media.buffered.length?media.buffered.start(0):0)-startPosition;delta>0&&delta<this.config.maxBufferHole&&(logger.logger.log("adjusting start position by "+delta+" to match buffer start"),startPosition+=delta,this.startPosition=startPosition),logger.logger.log("seek to target start position "+startPosition+" from current time "+currentTime+". ready state "+media.readyState),media.currentTime=startPosition}},_proto._getAudioCodec=function _getAudioCodec(currentLevel){var audioCodec=this.config.defaultAudioCodec||currentLevel.audioCodec;return this.audioCodecSwap&&(logger.logger.log("swapping playlist audio codec"),audioCodec&&(audioCodec=-1!==audioCodec.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5")),audioCodec},function stream_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&stream_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&stream_controller_defineProperties(Constructor,staticProps),Constructor}(StreamController,[{key:"state",set:function set(nextState){if(this.state!==nextState){var previousState=this.state;this._state=nextState,logger.logger.log("main stream-controller: "+previousState+"->"+nextState),this.hls.trigger(events.default.STREAM_STATE_TRANSITION,{previousState:previousState,nextState:nextState})}},get:function get(){return this._state}},{key:"currentLevel",get:function get(){var media=this.media;if(media){var frag=this.getBufferedFrag(media.currentTime);if(frag)return frag.level}return-1}},{key:"nextBufferedFrag",get:function get(){var media=this.media;return media?this.followingBufferedFrag(this.getBufferedFrag(media.currentTime)):null}},{key:"nextLevel",get:function get(){var frag=this.nextBufferedFrag;return frag?frag.level:-1}},{key:"liveSyncPosition",get:function get(){return this._liveSyncPosition},set:function set(value){this._liveSyncPosition=value}}]),StreamController}(base_stream_controller_BaseStreamController);function level_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var level_controller_LevelController=function(_EventHandler){function LevelController(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.MANIFEST_LOADED,events.default.LEVEL_LOADED,events.default.AUDIO_TRACK_SWITCHED,events.default.FRAG_LOADED,events.default.ERROR)||this).canload=!1,_this.currentLevelIndex=null,_this.manualLevelIndex=-1,_this.timer=null,chromeOrFirefox=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),_this}!function level_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(LevelController,_EventHandler);var _proto=LevelController.prototype;return _proto.onHandlerDestroying=function onHandlerDestroying(){this.clearTimer(),this.manualLevelIndex=-1},_proto.clearTimer=function clearTimer(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)},_proto.startLoad=function startLoad(){var levels=this._levels;this.canload=!0,this.levelRetryCount=0,levels&&levels.forEach((function(level){level.loadError=0;var levelDetails=level.details;levelDetails&&levelDetails.live&&(level.details=void 0)})),null!==this.timer&&this.loadLevel()},_proto.stopLoad=function stopLoad(){this.canload=!1},_proto.onManifestLoaded=function onManifestLoaded(data){var bitrateStart,levels=[],audioTracks=[],levelSet={},levelFromSet=null,videoCodecFound=!1,audioCodecFound=!1;if(data.levels.forEach((function(level){var attributes=level.attrs;level.loadError=0,level.fragmentError=!1,videoCodecFound=videoCodecFound||!!level.videoCodec,audioCodecFound=audioCodecFound||!!level.audioCodec,chromeOrFirefox&&level.audioCodec&&-1!==level.audioCodec.indexOf("mp4a.40.34")&&(level.audioCodec=void 0),(levelFromSet=levelSet[level.bitrate])?levelFromSet.url.push(level.url):(level.url=[level.url],level.urlId=0,levelSet[level.bitrate]=level,levels.push(level)),attributes&&(attributes.AUDIO&&addGroupId(levelFromSet||level,"audio",attributes.AUDIO),attributes.SUBTITLES&&addGroupId(levelFromSet||level,"text",attributes.SUBTITLES))})),videoCodecFound&&audioCodecFound&&(levels=levels.filter((function(_ref){return!!_ref.videoCodec}))),levels=levels.filter((function(_ref2){var audioCodec=_ref2.audioCodec,videoCodec=_ref2.videoCodec;return(!audioCodec||isCodecSupportedInMp4(audioCodec,"audio"))&&(!videoCodec||isCodecSupportedInMp4(videoCodec,"video"))})),data.audioTracks&&(audioTracks=data.audioTracks.filter((function(track){return!track.audioCodec||isCodecSupportedInMp4(track.audioCodec,"audio")}))).forEach((function(track,index){track.id=index})),levels.length>0){bitrateStart=levels[0].bitrate,levels.sort((function(a,b){return a.bitrate-b.bitrate})),this._levels=levels;for(var i=0;i<levels.length;i++)if(levels[i].bitrate===bitrateStart){this._firstLevel=i,logger.logger.log("manifest loaded,"+levels.length+" level(s) found, first bitrate:"+bitrateStart);break}var audioOnly=audioCodecFound&&!videoCodecFound;this.hls.trigger(events.default.MANIFEST_PARSED,{levels:levels,audioTracks:audioTracks,firstLevel:this._firstLevel,stats:data.stats,audio:audioCodecFound,video:videoCodecFound,altAudio:!audioOnly&&audioTracks.some((function(t){return!!t.url}))})}else this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:this.hls.url,reason:"no level with compatible codecs found in manifest"})},_proto.setLevelInternal=function setLevelInternal(newLevel){var levels=this._levels,hls=this.hls;if(newLevel>=0&&newLevel<levels.length){if(this.clearTimer(),this.currentLevelIndex!==newLevel){logger.logger.log("switching to level "+newLevel),this.currentLevelIndex=newLevel;var levelProperties=levels[newLevel];levelProperties.level=newLevel,hls.trigger(events.default.LEVEL_SWITCHING,levelProperties)}var level=levels[newLevel],levelDetails=level.details;if(!levelDetails||levelDetails.live){var urlId=level.urlId;hls.trigger(events.default.LEVEL_LOADING,{url:level.url[urlId],level:newLevel,id:urlId})}}else hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.OTHER_ERROR,details:errors.ErrorDetails.LEVEL_SWITCH_ERROR,level:newLevel,fatal:!1,reason:"invalid level idx"})},_proto.onError=function onError(data){if(data.fatal)data.type===errors.ErrorTypes.NETWORK_ERROR&&this.clearTimer();else{var levelIndex,levelError=!1,fragmentError=!1;switch(data.details){case errors.ErrorDetails.FRAG_LOAD_ERROR:case errors.ErrorDetails.FRAG_LOAD_TIMEOUT:case errors.ErrorDetails.KEY_LOAD_ERROR:case errors.ErrorDetails.KEY_LOAD_TIMEOUT:levelIndex=data.frag.level,fragmentError=!0;break;case errors.ErrorDetails.LEVEL_LOAD_ERROR:case errors.ErrorDetails.LEVEL_LOAD_TIMEOUT:levelIndex=data.context.level,levelError=!0;break;case errors.ErrorDetails.REMUX_ALLOC_ERROR:levelIndex=data.level,levelError=!0}void 0!==levelIndex&&this.recoverLevel(data,levelIndex,levelError,fragmentError)}},_proto.recoverLevel=function recoverLevel(errorEvent,levelIndex,levelError,fragmentError){var redundantLevels,delay,nextLevel,_this2=this,config=this.hls.config,errorDetails=errorEvent.details,level=this._levels[levelIndex];if(level.loadError++,level.fragmentError=fragmentError,levelError){if(!(this.levelRetryCount+1<=config.levelLoadingMaxRetry))return logger.logger.error("level controller, cannot recover from "+errorDetails+" error"),this.currentLevelIndex=null,this.clearTimer(),void(errorEvent.fatal=!0);delay=Math.min(Math.pow(2,this.levelRetryCount)*config.levelLoadingRetryDelay,config.levelLoadingMaxRetryTimeout),this.timer=setTimeout((function(){return _this2.loadLevel()}),delay),errorEvent.levelRetry=!0,this.levelRetryCount++,logger.logger.warn("level controller, "+errorDetails+", retry in "+delay+" ms, current retry count is "+this.levelRetryCount)}(levelError||fragmentError)&&((redundantLevels=level.url.length)>1&&level.loadError<redundantLevels?(level.urlId=(level.urlId+1)%redundantLevels,level.details=void 0,logger.logger.warn("level controller, "+errorDetails+" for level "+levelIndex+": switching to redundant URL-id "+level.urlId)):-1===this.manualLevelIndex?(nextLevel=0===levelIndex?this._levels.length-1:levelIndex-1,logger.logger.warn("level controller, "+errorDetails+": switch to "+nextLevel),this.hls.nextAutoLevel=this.currentLevelIndex=nextLevel):fragmentError&&(logger.logger.warn("level controller, "+errorDetails+": reload a fragment"),this.currentLevelIndex=null))},_proto.onFragLoaded=function onFragLoaded(_ref3){var frag=_ref3.frag;if(void 0!==frag&&"main"===frag.type){var level=this._levels[frag.level];void 0!==level&&(level.fragmentError=!1,level.loadError=0,this.levelRetryCount=0)}},_proto.onLevelLoaded=function onLevelLoaded(data){var _this3=this,level=data.level,details=data.details;if(level===this.currentLevelIndex){var curLevel=this._levels[level];if(curLevel.fragmentError||(curLevel.loadError=0,this.levelRetryCount=0),details.live){var reloadInterval=computeReloadInterval(curLevel.details,details,data.stats.trequest);logger.logger.log("live playlist, reload in "+Math.round(reloadInterval)+" ms"),this.timer=setTimeout((function(){return _this3.loadLevel()}),reloadInterval)}else this.clearTimer()}},_proto.onAudioTrackSwitched=function onAudioTrackSwitched(data){var audioGroupId=this.hls.audioTracks[data.id].groupId,currentLevel=this.hls.levels[this.currentLevelIndex];if(currentLevel&&currentLevel.audioGroupIds){for(var urlId=-1,i=0;i<currentLevel.audioGroupIds.length;i++)if(currentLevel.audioGroupIds[i]===audioGroupId){urlId=i;break}urlId!==currentLevel.urlId&&(currentLevel.urlId=urlId,this.startLoad())}},_proto.loadLevel=function loadLevel(){if(logger.logger.debug("call to loadLevel"),null!==this.currentLevelIndex&&this.canload){var levelObject=this._levels[this.currentLevelIndex];if("object"==typeof levelObject&&levelObject.url.length>0){var level=this.currentLevelIndex,id=levelObject.urlId,url=levelObject.url[id];logger.logger.log("Attempt loading level index "+level+" with URL-id "+id),this.hls.trigger(events.default.LEVEL_LOADING,{url:url,level:level,id:id})}}},_proto.removeLevel=function removeLevel(levelIndex,urlId){var levels=this.levels.filter((function(level,index){return index!==levelIndex||level.url.length>1&&void 0!==urlId&&(level.url=level.url.filter((function(url,id){return id!==urlId})),level.urlId=0,!0)})).map((function(level,index){var details=level.details;return details&&details.fragments&&details.fragments.forEach((function(fragment){fragment.level=index})),level}));this._levels=levels,this.hls.trigger(events.default.LEVELS_UPDATED,{levels:levels})},function level_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&level_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&level_controller_defineProperties(Constructor,staticProps),Constructor}(LevelController,[{key:"levels",get:function get(){return this._levels}},{key:"level",get:function get(){return this.currentLevelIndex},set:function set(newLevel){var levels=this._levels;levels&&(newLevel=Math.min(newLevel,levels.length-1),this.currentLevelIndex===newLevel&&levels[newLevel].details||this.setLevelInternal(newLevel))}},{key:"manualLevel",get:function get(){return this.manualLevelIndex},set:function set(newLevel){this.manualLevelIndex=newLevel,void 0===this._startLevel&&(this._startLevel=newLevel),-1!==newLevel&&(this.level=newLevel)}},{key:"firstLevel",get:function get(){return this._firstLevel},set:function set(newLevel){this._firstLevel=newLevel}},{key:"startLevel",get:function get(){if(void 0===this._startLevel){var configStartLevel=this.hls.config.startLevel;return void 0!==configStartLevel?configStartLevel:this._firstLevel}return this._startLevel},set:function set(newLevel){this._startLevel=newLevel}},{key:"nextLoadLevel",get:function get(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel},set:function set(nextLevel){this.level=nextLevel,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=nextLevel)}}]),LevelController}(event_handler),id3=__webpack_require__("./src/demux/id3.js");function sendAddTrackEvent(track,videoEl){var event;try{event=new Event("addtrack")}catch(err){(event=document.createEvent("Event")).initEvent("addtrack",!1,!1)}event.track=track,videoEl.dispatchEvent(event)}function clearCurrentCues(track){if(null==track?void 0:track.cues)for(;track.cues.length>0;)track.removeCue(track.cues[0])}var id3_track_controller=function(_EventHandler){function ID3TrackController(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.MEDIA_ATTACHED,events.default.MEDIA_DETACHING,events.default.FRAG_PARSING_METADATA,events.default.LIVE_BACK_BUFFER_REACHED)||this).id3Track=void 0,_this.media=void 0,_this}!function id3_track_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(ID3TrackController,_EventHandler);var _proto=ID3TrackController.prototype;return _proto.destroy=function destroy(){event_handler.prototype.destroy.call(this)},_proto.onMediaAttached=function onMediaAttached(data){this.media=data.media,this.media},_proto.onMediaDetaching=function onMediaDetaching(){clearCurrentCues(this.id3Track),this.id3Track=void 0,this.media=void 0},_proto.getID3Track=function getID3Track(textTracks){for(var i=0;i<textTracks.length;i++){var textTrack=textTracks[i];if("metadata"===textTrack.kind&&"id3"===textTrack.label)return sendAddTrackEvent(textTrack,this.media),textTrack}return this.media.addTextTrack("metadata","id3")},_proto.onFragParsingMetadata=function onFragParsingMetadata(data){var fragment=data.frag,samples=data.samples;this.id3Track||(this.id3Track=this.getID3Track(this.media.textTracks),this.id3Track.mode="hidden");for(var Cue=window.WebKitDataCue||window.VTTCue||window.TextTrackCue,i=0;i<samples.length;i++){var frames=id3.default.getID3Frames(samples[i].data);if(frames){var startTime=Math.max(samples[i].pts,0),endTime=i<samples.length-1?samples[i+1].pts:fragment.endPTS;endTime||(endTime=fragment.start+fragment.duration),endTime-startTime<=0&&(endTime=startTime+.25);for(var j=0;j<frames.length;j++){var frame=frames[j];if(!id3.default.isTimeStampFrame(frame)){var cue=new Cue(startTime,endTime,"");cue.value=frame,this.id3Track.addCue(cue)}}}}},_proto.onLiveBackBufferReached=function onLiveBackBufferReached(_ref){var bufferEnd=_ref.bufferEnd,id3Track=this.id3Track;if(id3Track&&id3Track.cues&&id3Track.cues.length){var foundCue=function getClosestCue(cues,time){if(time<cues[0].endTime)return cues[0];if(time>cues[cues.length-1].endTime)return cues[cues.length-1];for(var left=0,right=cues.length-1;left<=right;){var mid=Math.floor((right+left)/2);if(time<cues[mid].endTime)right=mid-1;else{if(!(time>cues[mid].endTime))return cues[mid];left=mid+1}}return cues[left].endTime-time<time-cues[right].endTime?cues[left]:cues[right]}(id3Track.cues,bufferEnd);if(foundCue)for(;id3Track.cues[0]!==foundCue;)id3Track.removeCue(id3Track.cues[0])}},ID3TrackController}(event_handler);var ewma=function(){function EWMA(halfLife){this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.alpha_=halfLife?Math.exp(Math.log(.5)/halfLife):0,this.estimate_=0,this.totalWeight_=0}var _proto=EWMA.prototype;return _proto.sample=function sample(weight,value){var adjAlpha=Math.pow(this.alpha_,weight);this.estimate_=value*(1-adjAlpha)+adjAlpha*this.estimate_,this.totalWeight_+=weight},_proto.getTotalWeight=function getTotalWeight(){return this.totalWeight_},_proto.getEstimate=function getEstimate(){if(this.alpha_){var zeroFactor=1-Math.pow(this.alpha_,this.totalWeight_);return this.estimate_/zeroFactor}return this.estimate_},EWMA}(),ewma_bandwidth_estimator=function(){function EwmaBandWidthEstimator(hls,slow,fast,defaultEstimate){this.hls=void 0,this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.hls=hls,this.defaultEstimate_=defaultEstimate,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new ewma(slow),this.fast_=new ewma(fast)}var _proto=EwmaBandWidthEstimator.prototype;return _proto.sample=function sample(durationMs,numBytes){var durationS=(durationMs=Math.max(durationMs,this.minDelayMs_))/1e3,bandwidthInBps=8*numBytes/durationS;this.fast_.sample(durationS,bandwidthInBps),this.slow_.sample(durationS,bandwidthInBps)},_proto.canEstimate=function canEstimate(){var fast=this.fast_;return fast&&fast.getTotalWeight()>=this.minWeight_},_proto.getEstimate=function getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},_proto.destroy=function destroy(){},EwmaBandWidthEstimator}();function abr_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var abr_controller_performance=window.performance,abr_controller=function(_EventHandler){function AbrController(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.FRAG_LOADING,events.default.FRAG_LOADED,events.default.FRAG_BUFFERED,events.default.ERROR)||this).lastLoadedFragLevel=0,_this._nextAutoLevel=-1,_this.hls=hls,_this.timer=null,_this._bwEstimator=null,_this.onCheck=_this._abandonRulesCheck.bind(function abr_controller_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(_this)),_this}!function abr_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(AbrController,_EventHandler);var _proto=AbrController.prototype;return _proto.destroy=function destroy(){this.clearTimer(),event_handler.prototype.destroy.call(this)},_proto.onFragLoading=function onFragLoading(data){var frag=data.frag;if("main"===frag.type&&(this.timer||(this.fragCurrent=frag,this.timer=setInterval(this.onCheck,100)),!this._bwEstimator)){var ewmaFast,ewmaSlow,hls=this.hls,config=hls.config,level=frag.level;hls.levels[level].details.live?(ewmaFast=config.abrEwmaFastLive,ewmaSlow=config.abrEwmaSlowLive):(ewmaFast=config.abrEwmaFastVoD,ewmaSlow=config.abrEwmaSlowVoD),this._bwEstimator=new ewma_bandwidth_estimator(hls,ewmaSlow,ewmaFast,config.abrEwmaDefaultEstimate)}},_proto._abandonRulesCheck=function _abandonRulesCheck(){var hls=this.hls,video=hls.media,frag=this.fragCurrent;if(frag){var loader=frag.loader;if(!loader||loader.stats&&loader.stats.aborted)return logger.logger.warn("frag loader destroy or aborted, disarm abandonRules"),this.clearTimer(),void(this._nextAutoLevel=-1);var stats=loader.stats;if(video&&stats&&(!video.paused&&0!==video.playbackRate||!video.readyState)&&frag.autoLevel&&frag.level){var requestDelay=abr_controller_performance.now()-stats.trequest,playbackRate=Math.abs(video.playbackRate);if(requestDelay>500*frag.duration/playbackRate){var levels=hls.levels,loadRate=Math.max(1,stats.bw?stats.bw/8:1e3*stats.loaded/requestDelay),level=levels[frag.level];if(!level)return;var levelBitrate=level.realBitrate?Math.max(level.realBitrate,level.bitrate):level.bitrate,expectedLen=stats.total?stats.total:Math.max(stats.loaded,Math.round(frag.duration*levelBitrate/8)),pos=video.currentTime,fragLoadedDelay=(expectedLen-stats.loaded)/loadRate,bufferStarvationDelay=(BufferHelper.bufferInfo(video,pos,hls.config.maxBufferHole).end-pos)/playbackRate;if(bufferStarvationDelay<2*frag.duration/playbackRate&&fragLoadedDelay>bufferStarvationDelay){var nextLoadLevel,minAutoLevel=hls.minAutoLevel;for(nextLoadLevel=frag.level-1;nextLoadLevel>minAutoLevel;nextLoadLevel--){var levelNextBitrate=levels[nextLoadLevel].realBitrate?Math.max(levels[nextLoadLevel].realBitrate,levels[nextLoadLevel].bitrate):levels[nextLoadLevel].bitrate;if(frag.duration*levelNextBitrate/(6.4*loadRate)<bufferStarvationDelay)break}undefined<fragLoadedDelay&&(logger.logger.warn("loading too slow, abort fragment loading and switch to level "+nextLoadLevel+":fragLoadedDelay["+nextLoadLevel+"]<fragLoadedDelay["+(frag.level-1)+"];bufferStarvationDelay:"+undefined.toFixed(1)+"<"+fragLoadedDelay.toFixed(1)+":"+bufferStarvationDelay.toFixed(1)),hls.nextLoadLevel=nextLoadLevel,this._bwEstimator.sample(requestDelay,stats.loaded),loader.abort(),this.clearTimer(),hls.trigger(events.default.FRAG_LOAD_EMERGENCY_ABORTED,{frag:frag,stats:stats}))}}}}},_proto.onFragLoaded=function onFragLoaded(data){var frag=data.frag;if("main"===frag.type&&Object(number.isFiniteNumber)(frag.sn)){if(this.clearTimer(),this.lastLoadedFragLevel=frag.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var level=this.hls.levels[frag.level],loadedBytes=(level.loaded?level.loaded.bytes:0)+data.stats.loaded,loadedDuration=(level.loaded?level.loaded.duration:0)+data.frag.duration;level.loaded={bytes:loadedBytes,duration:loadedDuration},level.realBitrate=Math.round(8*loadedBytes/loadedDuration)}if(data.frag.bitrateTest){var stats=data.stats;stats.tparsed=stats.tbuffered=stats.tload,this.onFragBuffered(data)}}},_proto.onFragBuffered=function onFragBuffered(data){var stats=data.stats,frag=data.frag;if(!0!==stats.aborted&&"main"===frag.type&&Object(number.isFiniteNumber)(frag.sn)&&(!frag.bitrateTest||stats.tload===stats.tbuffered)){var fragLoadingProcessingMs=stats.tparsed-stats.trequest;logger.logger.log("latency/loading/parsing/append/kbps:"+Math.round(stats.tfirst-stats.trequest)+"/"+Math.round(stats.tload-stats.tfirst)+"/"+Math.round(stats.tparsed-stats.tload)+"/"+Math.round(stats.tbuffered-stats.tparsed)+"/"+Math.round(8*stats.loaded/(stats.tbuffered-stats.trequest))),this._bwEstimator.sample(fragLoadingProcessingMs,stats.loaded),stats.bwEstimate=this._bwEstimator.getEstimate(),frag.bitrateTest?this.bitrateTestDelay=fragLoadingProcessingMs/1e3:this.bitrateTestDelay=0}},_proto.onError=function onError(data){switch(data.details){case errors.ErrorDetails.FRAG_LOAD_ERROR:case errors.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer()}},_proto.clearTimer=function clearTimer(){clearInterval(this.timer),this.timer=null},_proto._findBestLevel=function _findBestLevel(currentLevel,currentFragDuration,currentBw,minAutoLevel,maxAutoLevel,maxFetchDuration,bwFactor,bwUpFactor,levels){for(var i=maxAutoLevel;i>=minAutoLevel;i--){var levelInfo=levels[i];if(levelInfo){var levelDetails=levelInfo.details,avgDuration=levelDetails?levelDetails.totalduration/levelDetails.fragments.length:currentFragDuration,live=!!levelDetails&&levelDetails.live,adjustedbw=void 0;adjustedbw=i<=currentLevel?bwFactor*currentBw:bwUpFactor*currentBw;var bitrate=levels[i].realBitrate?Math.max(levels[i].realBitrate,levels[i].bitrate):levels[i].bitrate,fetchDuration=bitrate*avgDuration/adjustedbw;if(logger.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+i+"/"+Math.round(adjustedbw)+"/"+bitrate+"/"+avgDuration+"/"+maxFetchDuration+"/"+fetchDuration),adjustedbw>bitrate&&(!fetchDuration||live&&!this.bitrateTestDelay||fetchDuration<maxFetchDuration))return i}}return-1},function abr_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&abr_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&abr_controller_defineProperties(Constructor,staticProps),Constructor}(AbrController,[{key:"nextAutoLevel",get:function get(){var forcedAutoLevel=this._nextAutoLevel,bwEstimator=this._bwEstimator;if(!(-1===forcedAutoLevel||bwEstimator&&bwEstimator.canEstimate()))return forcedAutoLevel;var nextABRAutoLevel=this._nextABRAutoLevel;return-1!==forcedAutoLevel&&(nextABRAutoLevel=Math.min(forcedAutoLevel,nextABRAutoLevel)),nextABRAutoLevel},set:function set(nextLevel){this._nextAutoLevel=nextLevel}},{key:"_nextABRAutoLevel",get:function get(){var hls=this.hls,maxAutoLevel=hls.maxAutoLevel,levels=hls.levels,config=hls.config,minAutoLevel=hls.minAutoLevel,video=hls.media,currentLevel=this.lastLoadedFragLevel,currentFragDuration=this.fragCurrent?this.fragCurrent.duration:0,pos=video?video.currentTime:0,playbackRate=video&&0!==video.playbackRate?Math.abs(video.playbackRate):1,avgbw=this._bwEstimator?this._bwEstimator.getEstimate():config.abrEwmaDefaultEstimate,bufferStarvationDelay=(BufferHelper.bufferInfo(video,pos,config.maxBufferHole).end-pos)/playbackRate,bestLevel=this._findBestLevel(currentLevel,currentFragDuration,avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,config.abrBandWidthFactor,config.abrBandWidthUpFactor,levels);if(bestLevel>=0)return bestLevel;logger.logger.trace("rebuffering expected to happen, lets try to find a quality level minimizing the rebuffering");var maxStarvationDelay=currentFragDuration?Math.min(currentFragDuration,config.maxStarvationDelay):config.maxStarvationDelay,bwFactor=config.abrBandWidthFactor,bwUpFactor=config.abrBandWidthUpFactor;if(0===bufferStarvationDelay){var bitrateTestDelay=this.bitrateTestDelay;if(bitrateTestDelay)maxStarvationDelay=(currentFragDuration?Math.min(currentFragDuration,config.maxLoadingDelay):config.maxLoadingDelay)-bitrateTestDelay,logger.logger.trace("bitrate test took "+Math.round(1e3*bitrateTestDelay)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*maxStarvationDelay)+" ms"),bwFactor=bwUpFactor=1}return bestLevel=this._findBestLevel(currentLevel,currentFragDuration,avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay+maxStarvationDelay,bwFactor,bwUpFactor,levels),Math.max(bestLevel,0)}}]),AbrController}(event_handler);var buffer_controller_MediaSource=getMediaSource(),buffer_controller=function(_EventHandler){function BufferController(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.MEDIA_ATTACHING,events.default.MEDIA_DETACHING,events.default.MANIFEST_PARSED,events.default.BUFFER_RESET,events.default.BUFFER_APPENDING,events.default.BUFFER_CODECS,events.default.BUFFER_EOS,events.default.BUFFER_FLUSHING,events.default.LEVEL_PTS_UPDATED,events.default.LEVEL_UPDATED)||this)._msDuration=null,_this._levelDuration=null,_this._levelTargetDuration=10,_this._live=null,_this._objectUrl=null,_this._needsFlush=!1,_this._needsEos=!1,_this.config=void 0,_this.audioTimestampOffset=void 0,_this.bufferCodecEventsExpected=0,_this._bufferCodecEventsTotal=0,_this.media=null,_this.mediaSource=null,_this.segments=[],_this.parent=void 0,_this.appending=!1,_this.appended=0,_this.appendError=0,_this.flushBufferCounter=0,_this.tracks={},_this.pendingTracks={},_this.sourceBuffer={},_this.flushRange=[],_this._onMediaSourceOpen=function(){logger.logger.log("media source opened"),_this.hls.trigger(events.default.MEDIA_ATTACHED,{media:_this.media});var mediaSource=_this.mediaSource;mediaSource&&mediaSource.removeEventListener("sourceopen",_this._onMediaSourceOpen),_this.checkPendingTracks()},_this._onMediaSourceClose=function(){logger.logger.log("media source closed")},_this._onMediaSourceEnded=function(){logger.logger.log("media source ended")},_this._onSBUpdateEnd=function(){if(_this.audioTimestampOffset&&_this.sourceBuffer.audio){var audioBuffer=_this.sourceBuffer.audio;logger.logger.warn("change mpeg audio timestamp offset from "+audioBuffer.timestampOffset+" to "+_this.audioTimestampOffset),audioBuffer.timestampOffset=_this.audioTimestampOffset,delete _this.audioTimestampOffset}_this._needsFlush&&_this.doFlush(),_this._needsEos&&_this.checkEos(),_this.appending=!1;var parent=_this.parent,pending=_this.segments.reduce((function(counter,segment){return segment.parent===parent?counter+1:counter}),0),timeRanges={},sbSet=_this.sourceBuffer;for(var streamType in sbSet){var sb=sbSet[streamType];if(!sb)throw Error("handling source buffer update end error: source buffer for "+streamType+" uninitilized and unable to update buffered TimeRanges.");timeRanges[streamType]=sb.buffered}_this.hls.trigger(events.default.BUFFER_APPENDED,{parent:parent,pending:pending,timeRanges:timeRanges}),_this._needsFlush||_this.doAppending(),_this.updateMediaElementDuration(),0===pending&&_this.flushLiveBackBuffer()},_this._onSBUpdateError=function(event){logger.logger.error("sourceBuffer error:",event),_this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1})},_this.config=hls.config,_this}!function buffer_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(BufferController,_EventHandler);var _proto=BufferController.prototype;return _proto.destroy=function destroy(){event_handler.prototype.destroy.call(this)},_proto.onLevelPtsUpdated=function onLevelPtsUpdated(data){var type=data.type,audioTrack=this.tracks.audio;if("audio"===type&&audioTrack&&"audio/mpeg"===audioTrack.container){var audioBuffer=this.sourceBuffer.audio;if(!audioBuffer)throw Error("Level PTS Updated and source buffer for audio uninitalized");if(Math.abs(audioBuffer.timestampOffset-data.start)>.1){var updating=audioBuffer.updating;try{audioBuffer.abort()}catch(err){logger.logger.warn("can not abort audio buffer: "+err)}updating?this.audioTimestampOffset=data.start:(logger.logger.warn("change mpeg audio timestamp offset from "+audioBuffer.timestampOffset+" to "+data.start),audioBuffer.timestampOffset=data.start)}}},_proto.onManifestParsed=function onManifestParsed(data){var codecEvents=2;(data.audio&&!data.video||!data.altAudio)&&(codecEvents=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=codecEvents,logger.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},_proto.onMediaAttaching=function onMediaAttaching(data){var media=this.media=data.media;if(media&&buffer_controller_MediaSource){var ms=this.mediaSource=new buffer_controller_MediaSource;ms.addEventListener("sourceopen",this._onMediaSourceOpen),ms.addEventListener("sourceended",this._onMediaSourceEnded),ms.addEventListener("sourceclose",this._onMediaSourceClose),media.src=window.URL.createObjectURL(ms),this._objectUrl=media.src}},_proto.onMediaDetaching=function onMediaDetaching(){logger.logger.log("media source detaching");var ms=this.mediaSource;if(ms){if("open"===ms.readyState)try{ms.endOfStream()}catch(err){logger.logger.warn("onMediaDetaching:"+err.message+" while calling endOfStream")}ms.removeEventListener("sourceopen",this._onMediaSourceOpen),ms.removeEventListener("sourceended",this._onMediaSourceEnded),ms.removeEventListener("sourceclose",this._onMediaSourceClose),this.media&&(this._objectUrl&&window.URL.revokeObjectURL(this._objectUrl),this.media.src===this._objectUrl?(this.media.removeAttribute("src"),this.media.load()):logger.logger.warn("media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={},this.sourceBuffer={},this.flushRange=[],this.segments=[],this.appended=0}this.hls.trigger(events.default.MEDIA_DETACHED)},_proto.checkPendingTracks=function checkPendingTracks(){var bufferCodecEventsExpected=this.bufferCodecEventsExpected,pendingTracks=this.pendingTracks,pendingTracksCount=Object.keys(pendingTracks).length;(pendingTracksCount&&!bufferCodecEventsExpected||2===pendingTracksCount)&&(this.createSourceBuffers(pendingTracks),this.pendingTracks={},this.doAppending())},_proto.onBufferReset=function onBufferReset(){var sourceBuffer=this.sourceBuffer;for(var type in sourceBuffer){var sb=sourceBuffer[type];try{sb&&(this.mediaSource&&this.mediaSource.removeSourceBuffer(sb),sb.removeEventListener("updateend",this._onSBUpdateEnd),sb.removeEventListener("error",this._onSBUpdateError))}catch(err){}}this.sourceBuffer={},this.flushRange=[],this.segments=[],this.appended=0},_proto.onBufferCodecs=function onBufferCodecs(tracks){var _this2=this;Object.keys(this.sourceBuffer).length||(Object.keys(tracks).forEach((function(trackName){_this2.pendingTracks[trackName]=tracks[trackName]})),this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())},_proto.createSourceBuffers=function createSourceBuffers(tracks){var sourceBuffer=this.sourceBuffer,mediaSource=this.mediaSource;if(!mediaSource)throw Error("createSourceBuffers called when mediaSource was null");for(var trackName in tracks)if(!sourceBuffer[trackName]){var track=tracks[trackName];if(!track)throw Error("source buffer exists for track "+trackName+", however track does not");var codec=track.levelCodec||track.codec,mimeType=track.container+";codecs="+codec;logger.logger.log("creating sourceBuffer("+mimeType+")");try{var sb=sourceBuffer[trackName]=mediaSource.addSourceBuffer(mimeType);sb.addEventListener("updateend",this._onSBUpdateEnd),sb.addEventListener("error",this._onSBUpdateError),this.tracks[trackName]={buffer:sb,codec:codec,id:track.id,container:track.container,levelCodec:track.levelCodec}}catch(err){logger.logger.error("error while trying to add sourceBuffer:"+err.message),this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,err:err,mimeType:mimeType})}}this.hls.trigger(events.default.BUFFER_CREATED,{tracks:this.tracks})},_proto.onBufferAppending=function onBufferAppending(data){this._needsFlush||(this.segments?this.segments.push(data):this.segments=[data],this.doAppending())},_proto.onBufferEos=function onBufferEos(data){for(var type in this.sourceBuffer)if(!data.type||data.type===type){var sb=this.sourceBuffer[type];sb&&!sb.ended&&(sb.ended=!0,logger.logger.log(type+" sourceBuffer now EOS"))}this.checkEos()},_proto.checkEos=function checkEos(){var sourceBuffer=this.sourceBuffer,mediaSource=this.mediaSource;if(mediaSource&&"open"===mediaSource.readyState){for(var type in sourceBuffer){var sb=sourceBuffer[type];if(sb){if(!sb.ended)return;if(sb.updating)return void(this._needsEos=!0)}}logger.logger.log("all media data are available, signal endOfStream() to MediaSource and stop loading fragment");try{mediaSource.endOfStream()}catch(e){logger.logger.warn("exception while calling mediaSource.endOfStream()")}this._needsEos=!1}else this._needsEos=!1},_proto.onBufferFlushing=function onBufferFlushing(data){data.type?this.flushRange.push({start:data.startOffset,end:data.endOffset,type:data.type}):(this.flushRange.push({start:data.startOffset,end:data.endOffset,type:"video"}),this.flushRange.push({start:data.startOffset,end:data.endOffset,type:"audio"})),this.flushBufferCounter=0,this.doFlush()},_proto.flushLiveBackBuffer=function flushLiveBackBuffer(){if(this._live){var liveBackBufferLength=this.config.liveBackBufferLength;if(isFinite(liveBackBufferLength)&&!(liveBackBufferLength<0))if(this.media)for(var currentTime=this.media.currentTime,sourceBuffer=this.sourceBuffer,bufferTypes=Object.keys(sourceBuffer),targetBackBufferPosition=currentTime-Math.max(liveBackBufferLength,this._levelTargetDuration),index=bufferTypes.length-1;index>=0;index--){var bufferType=bufferTypes[index],sb=sourceBuffer[bufferType];if(sb){var buffered=sb.buffered;buffered.length>0&&targetBackBufferPosition>buffered.start(0)&&this.removeBufferRange(bufferType,sb,0,targetBackBufferPosition)&&this.hls.trigger(events.default.LIVE_BACK_BUFFER_REACHED,{bufferEnd:targetBackBufferPosition})}}else logger.logger.error("flushLiveBackBuffer called without attaching media")}},_proto.onLevelUpdated=function onLevelUpdated(_ref){var details=_ref.details;details.fragments.length>0&&(this._levelDuration=details.totalduration+details.fragments[0].start,this._levelTargetDuration=details.averagetargetduration||details.targetduration||10,this._live=details.live,this.updateMediaElementDuration())},_proto.updateMediaElementDuration=function updateMediaElementDuration(){var duration,config=this.config;if(null!==this._levelDuration&&this.media&&this.mediaSource&&this.sourceBuffer&&0!==this.media.readyState&&"open"===this.mediaSource.readyState){for(var type in this.sourceBuffer){var sb=this.sourceBuffer[type];if(sb&&!0===sb.updating)return}duration=this.media.duration,null===this._msDuration&&(this._msDuration=this.mediaSource.duration),!0===this._live&&!0===config.liveDurationInfinity?(logger.logger.log("Media Source duration is set to Infinity"),this._msDuration=this.mediaSource.duration=1/0):(this._levelDuration>this._msDuration&&this._levelDuration>duration||!Object(number.isFiniteNumber)(duration))&&(logger.logger.log("Updating Media Source duration to "+this._levelDuration.toFixed(3)),this._msDuration=this.mediaSource.duration=this._levelDuration)}},_proto.doFlush=function doFlush(){for(;this.flushRange.length;){var range=this.flushRange[0];if(!this.flushBuffer(range.start,range.end,range.type))return void(this._needsFlush=!0);this.flushRange.shift(),this.flushBufferCounter=0}if(0===this.flushRange.length){this._needsFlush=!1;var appended=0,sourceBuffer=this.sourceBuffer;try{for(var type in sourceBuffer){var sb=sourceBuffer[type];sb&&(appended+=sb.buffered.length)}}catch(error){logger.logger.error("error while accessing sourceBuffer.buffered")}this.appended=appended,this.hls.trigger(events.default.BUFFER_FLUSHED)}},_proto.doAppending=function doAppending(){var config=this.config,hls=this.hls,segments=this.segments,sourceBuffer=this.sourceBuffer;if(Object.keys(sourceBuffer).length){if(!this.media||this.media.error)return this.segments=[],void logger.logger.error("trying to append although a media error occured, flush segment and abort");if(!this.appending){var segment=segments.shift();if(segment)try{var sb=sourceBuffer[segment.type];if(!sb)return void this._onSBUpdateEnd();if(sb.updating)return void segments.unshift(segment);sb.ended=!1,this.parent=segment.parent,sb.appendBuffer(segment.data),this.appendError=0,this.appended++,this.appending=!0}catch(err){logger.logger.error("error while trying to append buffer:"+err.message),segments.unshift(segment);var event={type:errors.ErrorTypes.MEDIA_ERROR,parent:segment.parent,details:"",fatal:!1};22===err.code?(this.segments=[],event.details=errors.ErrorDetails.BUFFER_FULL_ERROR):(this.appendError++,event.details=errors.ErrorDetails.BUFFER_APPEND_ERROR,this.appendError>config.appendErrorMaxRetry&&(logger.logger.log("fail "+config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),this.segments=[],event.fatal=!0)),hls.trigger(events.default.ERROR,event)}}}},_proto.flushBuffer=function flushBuffer(startOffset,endOffset,sbType){var sourceBuffer=this.sourceBuffer;if(!Object.keys(sourceBuffer).length)return!0;var currentTime="null";if(this.media&&(currentTime=this.media.currentTime.toFixed(3)),logger.logger.log("flushBuffer,pos/start/end: "+currentTime+"/"+startOffset+"/"+endOffset),this.flushBufferCounter>=this.appended)return logger.logger.warn("abort flushing too many retries"),!0;var sb=sourceBuffer[sbType];if(sb){if(sb.ended=!1,sb.updating)return logger.logger.warn("cannot flush, sb updating in progress"),!1;if(this.removeBufferRange(sbType,sb,startOffset,endOffset))return this.flushBufferCounter++,!1}return logger.logger.log("buffer flushed"),!0},_proto.removeBufferRange=function removeBufferRange(type,sb,startOffset,endOffset){try{for(var i=0;i<sb.buffered.length;i++){var bufStart=sb.buffered.start(i),bufEnd=sb.buffered.end(i),removeStart=Math.max(bufStart,startOffset),removeEnd=Math.min(bufEnd,endOffset);if(Math.min(removeEnd,bufEnd)-removeStart>.5){var currentTime="null";return this.media&&(currentTime=this.media.currentTime.toString()),logger.logger.log("sb remove "+type+" ["+removeStart+","+removeEnd+"], of ["+bufStart+","+bufEnd+"], pos:"+currentTime),sb.remove(removeStart,removeEnd),!0}}}catch(error){logger.logger.warn("removeBufferRange failed",error)}return!1},BufferController}(event_handler);function cap_level_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var cap_level_controller=function(_EventHandler){function CapLevelController(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.FPS_DROP_LEVEL_CAPPING,events.default.MEDIA_ATTACHING,events.default.MANIFEST_PARSED,events.default.LEVELS_UPDATED,events.default.BUFFER_CODECS,events.default.MEDIA_DETACHING)||this).autoLevelCapping=Number.POSITIVE_INFINITY,_this.firstLevel=null,_this.levels=[],_this.media=null,_this.restrictedLevels=[],_this.timer=null,_this.clientRect=null,_this}!function cap_level_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(CapLevelController,_EventHandler);var _proto=CapLevelController.prototype;return _proto.destroy=function destroy(){this.hls.config.capLevelToPlayerSize&&(this.media=null,this.clientRect=null,this.stopCapping())},_proto.onFpsDropLevelCapping=function onFpsDropLevelCapping(data){CapLevelController.isLevelAllowed(data.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(data.droppedLevel)},_proto.onMediaAttaching=function onMediaAttaching(data){this.media=data.media instanceof window.HTMLVideoElement?data.media:null},_proto.onManifestParsed=function onManifestParsed(data){var hls=this.hls;this.restrictedLevels=[],this.levels=data.levels,this.firstLevel=data.firstLevel,hls.config.capLevelToPlayerSize&&data.video&&this.startCapping()},_proto.onBufferCodecs=function onBufferCodecs(data){this.hls.config.capLevelToPlayerSize&&data.video&&this.startCapping()},_proto.onLevelsUpdated=function onLevelsUpdated(data){this.levels=data.levels},_proto.onMediaDetaching=function onMediaDetaching(){this.stopCapping()},_proto.detectPlayerSize=function detectPlayerSize(){if(this.media){var levelsLength=this.levels?this.levels.length:0;if(levelsLength){var hls=this.hls;hls.autoLevelCapping=this.getMaxLevel(levelsLength-1),hls.autoLevelCapping>this.autoLevelCapping&&hls.streamController.nextLevelSwitch(),this.autoLevelCapping=hls.autoLevelCapping}}},_proto.getMaxLevel=function getMaxLevel(capLevelIndex){var _this2=this;if(!this.levels)return-1;var validLevels=this.levels.filter((function(level,index){return CapLevelController.isLevelAllowed(index,_this2.restrictedLevels)&&index<=capLevelIndex}));return this.clientRect=null,CapLevelController.getMaxLevelByMediaSize(validLevels,this.mediaWidth,this.mediaHeight)},_proto.startCapping=function startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),clearInterval(this.timer),this.timer=setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},_proto.stopCapping=function stopCapping(){this.restrictedLevels=[],this.firstLevel=null,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(this.timer=clearInterval(this.timer),this.timer=null)},_proto.getDimensions=function getDimensions(){if(this.clientRect)return this.clientRect;var media=this.media,boundsRect={width:0,height:0};if(media){var clientRect=media.getBoundingClientRect();boundsRect.width=clientRect.width,boundsRect.height=clientRect.height,boundsRect.width||boundsRect.height||(boundsRect.width=clientRect.right-clientRect.left||media.width||0,boundsRect.height=clientRect.bottom-clientRect.top||media.height||0)}return this.clientRect=boundsRect,boundsRect},CapLevelController.isLevelAllowed=function isLevelAllowed(level,restrictedLevels){return void 0===restrictedLevels&&(restrictedLevels=[]),-1===restrictedLevels.indexOf(level)},CapLevelController.getMaxLevelByMediaSize=function getMaxLevelByMediaSize(levels,width,height){if(!levels||levels&&!levels.length)return-1;for(var atGreatestBandiwdth=function atGreatestBandiwdth(curLevel,nextLevel){return!nextLevel||(curLevel.width!==nextLevel.width||curLevel.height!==nextLevel.height)},maxLevelIndex=levels.length-1,i=0;i<levels.length;i+=1){var level=levels[i];if((level.width>=width||level.height>=height)&&atGreatestBandiwdth(level,levels[i+1])){maxLevelIndex=i;break}}return maxLevelIndex},function cap_level_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&cap_level_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&cap_level_controller_defineProperties(Constructor,staticProps),Constructor}(CapLevelController,[{key:"mediaWidth",get:function get(){return this.getDimensions().width*CapLevelController.contentScaleFactor}},{key:"mediaHeight",get:function get(){return this.getDimensions().height*CapLevelController.contentScaleFactor}}],[{key:"contentScaleFactor",get:function get(){var pixelRatio=1;try{pixelRatio=window.devicePixelRatio}catch(e){}return pixelRatio}}]),CapLevelController}(event_handler);var fps_controller_performance=window.performance,fps_controller=function(_EventHandler){function FPSController(hls){return _EventHandler.call(this,hls,events.default.MEDIA_ATTACHING)||this}!function fps_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(FPSController,_EventHandler);var _proto=FPSController.prototype;return _proto.destroy=function destroy(){this.timer&&clearInterval(this.timer),this.isVideoPlaybackQualityAvailable=!1},_proto.onMediaAttaching=function onMediaAttaching(data){var config=this.hls.config;config.capLevelOnFPSDrop&&("function"==typeof(this.video=data.media instanceof window.HTMLVideoElement?data.media:null).getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),clearInterval(this.timer),this.timer=setInterval(this.checkFPSInterval.bind(this),config.fpsDroppedMonitoringPeriod))},_proto.checkFPS=function checkFPS(video,decodedFrames,droppedFrames){var currentTime=fps_controller_performance.now();if(decodedFrames){if(this.lastTime){var currentPeriod=currentTime-this.lastTime,currentDropped=droppedFrames-this.lastDroppedFrames,currentDecoded=decodedFrames-this.lastDecodedFrames,droppedFPS=1e3*currentDropped/currentPeriod,hls=this.hls;if(hls.trigger(events.default.FPS_DROP,{currentDropped:currentDropped,currentDecoded:currentDecoded,totalDroppedFrames:droppedFrames}),droppedFPS>0&&currentDropped>hls.config.fpsDroppedMonitoringThreshold*currentDecoded){var currentLevel=hls.currentLevel;logger.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+currentLevel),currentLevel>0&&(-1===hls.autoLevelCapping||hls.autoLevelCapping>=currentLevel)&&(currentLevel-=1,hls.trigger(events.default.FPS_DROP_LEVEL_CAPPING,{level:currentLevel,droppedLevel:hls.currentLevel}),hls.autoLevelCapping=currentLevel,hls.streamController.nextLevelSwitch())}}this.lastTime=currentTime,this.lastDroppedFrames=droppedFrames,this.lastDecodedFrames=decodedFrames}},_proto.checkFPSInterval=function checkFPSInterval(){var video=this.video;if(video)if(this.isVideoPlaybackQualityAvailable){var videoPlaybackQuality=video.getVideoPlaybackQuality();this.checkFPS(video,videoPlaybackQuality.totalVideoFrames,videoPlaybackQuality.droppedVideoFrames)}else this.checkFPS(video,video.webkitDecodedFrameCount,video.webkitDroppedFrameCount)},FPSController}(event_handler),xhr_loader=function(){function XhrLoader(config){config&&config.xhrSetup&&(this.xhrSetup=config.xhrSetup)}var _proto=XhrLoader.prototype;return _proto.destroy=function destroy(){this.abort(),this.loader=null},_proto.abort=function abort(){var loader=this.loader;loader&&4!==loader.readyState&&(this.stats.aborted=!0,loader.abort()),window.clearTimeout(this.requestTimeout),this.requestTimeout=null,window.clearTimeout(this.retryTimeout),this.retryTimeout=null},_proto.load=function load(context,config,callbacks){this.context=context,this.config=config,this.callbacks=callbacks,this.stats={trequest:window.performance.now(),retry:0},this.retryDelay=config.retryDelay,this.loadInternal()},_proto.loadInternal=function loadInternal(){var xhr,context=this.context;xhr=this.loader=new window.XMLHttpRequest;var stats=this.stats;stats.tfirst=0,stats.loaded=0;var xhrSetup=this.xhrSetup;try{if(xhrSetup)try{xhrSetup(xhr,context.url)}catch(e){xhr.open("GET",context.url,!0),xhrSetup(xhr,context.url)}xhr.readyState||xhr.open("GET",context.url,!0)}catch(e){return void this.callbacks.onError({code:xhr.status,text:e.message},context,xhr)}context.rangeEnd&&xhr.setRequestHeader("Range","bytes="+context.rangeStart+"-"+(context.rangeEnd-1)),xhr.onreadystatechange=this.readystatechange.bind(this),xhr.onprogress=this.loadprogress.bind(this),xhr.responseType=context.responseType,this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),this.config.timeout),xhr.send()},_proto.readystatechange=function readystatechange(event){var xhr=event.currentTarget,readyState=xhr.readyState,stats=this.stats,context=this.context,config=this.config;if(!stats.aborted&&readyState>=2)if(window.clearTimeout(this.requestTimeout),0===stats.tfirst&&(stats.tfirst=Math.max(window.performance.now(),stats.trequest)),4===readyState){var status=xhr.status;if(status>=200&&status<300){var data,len;stats.tload=Math.max(stats.tfirst,window.performance.now()),len="arraybuffer"===context.responseType?(data=xhr.response).byteLength:(data=xhr.responseText).length,stats.loaded=stats.total=len;var response={url:xhr.responseURL,data:data};this.callbacks.onSuccess(response,stats,context,xhr)}else stats.retry>=config.maxRetry||status>=400&&status<499?(logger.logger.error(status+" while loading "+context.url),this.callbacks.onError({code:status,text:xhr.statusText},context,xhr)):(logger.logger.warn(status+" while loading "+context.url+", retrying in "+this.retryDelay+"..."),this.destroy(),this.retryTimeout=window.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,config.maxRetryDelay),stats.retry++)}else this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),config.timeout)},_proto.loadtimeout=function loadtimeout(){logger.logger.warn("timeout while loading "+this.context.url),this.callbacks.onTimeout(this.stats,this.context,null)},_proto.loadprogress=function loadprogress(event){var xhr=event.currentTarget,stats=this.stats;stats.loaded=event.loaded,event.lengthComputable&&(stats.total=event.total);var onProgress=this.callbacks.onProgress;onProgress&&onProgress(stats,this.context,null,xhr)},XhrLoader}();function audio_track_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var audio_track_controller=function(_TaskLoop){function AudioTrackController(hls){var _this;return(_this=_TaskLoop.call(this,hls,events.default.MANIFEST_LOADING,events.default.MANIFEST_PARSED,events.default.AUDIO_TRACK_LOADED,events.default.AUDIO_TRACK_SWITCHED,events.default.LEVEL_LOADED,events.default.ERROR)||this)._trackId=-1,_this._selectDefaultTrack=!0,_this.tracks=[],_this.trackIdBlacklist=Object.create(null),_this.audioGroupId=null,_this}!function audio_track_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(AudioTrackController,_TaskLoop);var _proto=AudioTrackController.prototype;return _proto.onManifestLoading=function onManifestLoading(){this.tracks=[],this._trackId=-1,this._selectDefaultTrack=!0},_proto.onManifestParsed=function onManifestParsed(data){var tracks=this.tracks=data.audioTracks||[];this.hls.trigger(events.default.AUDIO_TRACKS_UPDATED,{audioTracks:tracks}),this._selectAudioGroup(this.hls.nextLoadLevel)},_proto.onAudioTrackLoaded=function onAudioTrackLoaded(data){if(data.id>=this.tracks.length)logger.logger.warn("Invalid audio track id:",data.id);else{if(logger.logger.log("audioTrack "+data.id+" loaded"),this.tracks[data.id].details=data.details,data.details.live&&!this.hasInterval()){var updatePeriodMs=1e3*data.details.targetduration;this.setInterval(updatePeriodMs)}!data.details.live&&this.hasInterval()&&this.clearInterval()}},_proto.onAudioTrackSwitched=function onAudioTrackSwitched(data){var audioGroupId=this.tracks[data.id].groupId;audioGroupId&&this.audioGroupId!==audioGroupId&&(this.audioGroupId=audioGroupId)},_proto.onLevelLoaded=function onLevelLoaded(data){this._selectAudioGroup(data.level)},_proto.onError=function onError(data){data.type===errors.ErrorTypes.NETWORK_ERROR&&(data.fatal&&this.clearInterval(),data.details===errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR&&(logger.logger.warn("Network failure on audio-track id:",data.context.id),this._handleLoadError()))},_proto._setAudioTrack=function _setAudioTrack(newId){if(this._trackId===newId&&this.tracks[this._trackId].details)logger.logger.debug("Same id as current audio-track passed, and track details available -> no-op");else if(newId<0||newId>=this.tracks.length)logger.logger.warn("Invalid id passed to audio-track controller");else{var audioTrack=this.tracks[newId];logger.logger.log("Now switching to audio-track index "+newId),this.clearInterval(),this._trackId=newId;var url=audioTrack.url,type=audioTrack.type,id=audioTrack.id;this.hls.trigger(events.default.AUDIO_TRACK_SWITCHING,{id:id,type:type,url:url}),this._loadTrackDetailsIfNeeded(audioTrack)}},_proto.doTick=function doTick(){this._updateTrack(this._trackId)},_proto._selectAudioGroup=function _selectAudioGroup(levelId){var levelInfo=this.hls.levels[levelId];if(levelInfo&&levelInfo.audioGroupIds){var audioGroupId=levelInfo.audioGroupIds[levelInfo.urlId];this.audioGroupId!==audioGroupId&&(this.audioGroupId=audioGroupId,this._selectInitialAudioTrack())}},_proto._selectInitialAudioTrack=function _selectInitialAudioTrack(){var _this2=this,tracks=this.tracks;if(tracks.length){var currentAudioTrack=this.tracks[this._trackId],name=null;if(currentAudioTrack&&(name=currentAudioTrack.name),this._selectDefaultTrack){var defaultTracks=tracks.filter((function(track){return track.default}));defaultTracks.length?tracks=defaultTracks:logger.logger.warn("No default audio tracks defined")}var trackFound=!1,traverseTracks=function traverseTracks(){tracks.forEach((function(track){trackFound||_this2.audioGroupId&&track.groupId!==_this2.audioGroupId||name&&name!==track.name||(_this2._setAudioTrack(track.id),trackFound=!0)}))};traverseTracks(),trackFound||(name=null,traverseTracks()),trackFound||(logger.logger.error("No track found for running audio group-ID: "+this.audioGroupId),this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))}},_proto._needsTrackLoading=function _needsTrackLoading(audioTrack){var details=audioTrack.details,url=audioTrack.url;return!(details&&!details.live)&&!!url},_proto._loadTrackDetailsIfNeeded=function _loadTrackDetailsIfNeeded(audioTrack){if(this._needsTrackLoading(audioTrack)){var url=audioTrack.url,id=audioTrack.id;logger.logger.log("loading audio-track playlist for id: "+id),this.hls.trigger(events.default.AUDIO_TRACK_LOADING,{url:url,id:id})}},_proto._updateTrack=function _updateTrack(newId){if(!(newId<0||newId>=this.tracks.length)){this.clearInterval(),this._trackId=newId,logger.logger.log("trying to update audio-track "+newId);var audioTrack=this.tracks[newId];this._loadTrackDetailsIfNeeded(audioTrack)}},_proto._handleLoadError=function _handleLoadError(){this.trackIdBlacklist[this._trackId]=!0;var previousId=this._trackId,_this$tracks$previous=this.tracks[previousId],name=_this$tracks$previous.name,language=_this$tracks$previous.language,groupId=_this$tracks$previous.groupId;logger.logger.warn("Loading failed on audio track id: "+previousId+", group-id: "+groupId+', name/language: "'+name+'" / "'+language+'"');for(var newId=previousId,i=0;i<this.tracks.length;i++){if(!this.trackIdBlacklist[i])if(this.tracks[i].name===name){newId=i;break}}newId!==previousId?(logger.logger.log("Attempting audio-track fallback id:",newId,"group-id:",this.tracks[newId].groupId),this._setAudioTrack(newId)):logger.logger.warn('No fallback audio-track found for name/language: "'+name+'" / "'+language+'"')},function audio_track_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&audio_track_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&audio_track_controller_defineProperties(Constructor,staticProps),Constructor}(AudioTrackController,[{key:"audioTracks",get:function get(){return this.tracks}},{key:"audioTrack",get:function get(){return this._trackId},set:function set(newId){this._setAudioTrack(newId),this._selectDefaultTrack=!1}}]),AudioTrackController}(TaskLoop);function audio_stream_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var audio_stream_controller_performance=window.performance,audio_stream_controller=function(_BaseStreamController){function AudioStreamController(hls,fragmentTracker){var _this;return(_this=_BaseStreamController.call(this,hls,events.default.MEDIA_ATTACHED,events.default.MEDIA_DETACHING,events.default.AUDIO_TRACKS_UPDATED,events.default.AUDIO_TRACK_SWITCHING,events.default.AUDIO_TRACK_LOADED,events.default.KEY_LOADED,events.default.FRAG_LOADED,events.default.FRAG_PARSING_INIT_SEGMENT,events.default.FRAG_PARSING_DATA,events.default.FRAG_PARSED,events.default.ERROR,events.default.BUFFER_RESET,events.default.BUFFER_CREATED,events.default.BUFFER_APPENDED,events.default.BUFFER_FLUSHED,events.default.INIT_PTS_FOUND)||this).fragmentTracker=fragmentTracker,_this.config=hls.config,_this.audioCodecSwap=!1,_this._state=State_STOPPED,_this.initPTS=[],_this.waitingFragment=null,_this.videoTrackCC=null,_this.waitingVideoCC=null,_this}!function audio_stream_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(AudioStreamController,_BaseStreamController);var _proto=AudioStreamController.prototype;return _proto.onInitPtsFound=function onInitPtsFound(data){var demuxerId=data.id,cc=data.frag.cc,initPTS=data.initPTS;"main"===demuxerId&&(this.initPTS[cc]=initPTS,this.videoTrackCC=cc,logger.logger.log("InitPTS for cc: "+cc+" found from main: "+initPTS),this.state===State_WAITING_INIT_PTS&&this.tick())},_proto.startLoad=function startLoad(startPosition){if(this.tracks){var lastCurrentTime=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),this.fragLoadError=0,lastCurrentTime>0&&-1===startPosition?(logger.logger.log("audio:override startPosition with lastCurrentTime @"+lastCurrentTime.toFixed(3)),this.state=State_IDLE):(this.lastCurrentTime=this.startPosition?this.startPosition:startPosition,this.state=State_STARTING),this.nextLoadPosition=this.startPosition=this.lastCurrentTime,this.tick()}else this.startPosition=startPosition,this.state=State_STOPPED},_proto.doTick=function doTick(){var pos,track,trackDetails,hls=this.hls,config=hls.config;switch(this.state){case State_ERROR:case State_PAUSED:case State_BUFFER_FLUSHING:break;case State_STARTING:this.state=State_WAITING_TRACK,this.loadedmetadata=!1;break;case State_IDLE:var tracks=this.tracks;if(!tracks)break;if(!this.media&&(this.startFragRequested||!config.startFragPrefetch))break;if(this.loadedmetadata)pos=this.media.currentTime;else if(void 0===(pos=this.nextLoadPosition))break;var media=this.mediaBuffer?this.mediaBuffer:this.media,videoBuffer=this.videoBuffer?this.videoBuffer:this.media,maxBufferHole=pos<config.maxBufferHole?Math.max(2,config.maxBufferHole):config.maxBufferHole,bufferInfo=BufferHelper.bufferInfo(media,pos,maxBufferHole),mainBufferInfo=BufferHelper.bufferInfo(videoBuffer,pos,maxBufferHole),bufferLen=bufferInfo.len,bufferEnd=bufferInfo.end,fragPrevious=this.fragPrevious,maxConfigBuffer=Math.min(config.maxBufferLength,config.maxMaxBufferLength),maxBufLen=Math.max(maxConfigBuffer,mainBufferInfo.len),audioSwitch=this.audioSwitch,trackId=this.trackId;if((bufferLen<maxBufLen||audioSwitch)&&trackId<tracks.length){if(void 0===(trackDetails=tracks[trackId].details)){this.state=State_WAITING_TRACK;break}if(!audioSwitch&&this._streamEnded(bufferInfo,trackDetails))return this.hls.trigger(events.default.BUFFER_EOS,{type:"audio"}),void(this.state=State_ENDED);var frag,fragments=trackDetails.fragments,fragLen=fragments.length,start=fragments[0].start,end=fragments[fragLen-1].start+fragments[fragLen-1].duration;if(audioSwitch)if(trackDetails.live&&!trackDetails.PTSKnown)logger.logger.log("switching audiotrack, live stream, unknown PTS,load first fragment"),bufferEnd=0;else if(bufferEnd=pos,trackDetails.PTSKnown&&pos<start){if(!(bufferInfo.end>start||bufferInfo.nextStart))return;logger.logger.log("alt audio track ahead of main track, seek to start of alt audio track"),this.media.currentTime=start+.05}if(trackDetails.initSegment&&!trackDetails.initSegment.data)frag=trackDetails.initSegment;else if(bufferEnd<=start){if(frag=fragments[0],null!==this.videoTrackCC&&frag.cc!==this.videoTrackCC&&(frag=function findFragWithCC(fragments,CC){return binary_search.search(fragments,(function(candidate){return candidate.cc<CC?1:candidate.cc>CC?-1:0}))}(fragments,this.videoTrackCC)),trackDetails.live&&frag.loadIdx&&frag.loadIdx===this.fragLoadIdx){var nextBuffered=bufferInfo.nextStart?bufferInfo.nextStart:start;return logger.logger.log("no alt audio available @currentTime:"+this.media.currentTime+", seeking @"+(nextBuffered+.05)),void(this.media.currentTime=nextBuffered+.05)}}else{var foundFrag,maxFragLookUpTolerance=config.maxFragLookUpTolerance,fragNext=fragPrevious?fragments[fragPrevious.sn-fragments[0].sn+1]:void 0;bufferEnd<end?(bufferEnd>end-maxFragLookUpTolerance&&(maxFragLookUpTolerance=0),foundFrag=fragNext&&!fragmentWithinToleranceTest(bufferEnd,maxFragLookUpTolerance,fragNext)?fragNext:binary_search.search(fragments,(function(frag){return fragmentWithinToleranceTest(bufferEnd,maxFragLookUpTolerance,frag)}))):foundFrag=fragments[fragLen-1],foundFrag&&(frag=foundFrag,start=foundFrag.start,fragPrevious&&frag.level===fragPrevious.level&&frag.sn===fragPrevious.sn&&(frag.sn<trackDetails.endSN?(frag=fragments[frag.sn+1-trackDetails.startSN],this.fragmentTracker.getState(frag)!==FragmentState_OK&&logger.logger.log("SN just loaded, load next one: "+frag.sn)):frag=null))}frag&&(frag.encrypted?(logger.logger.log("Loading key for "+frag.sn+" of ["+trackDetails.startSN+" ,"+trackDetails.endSN+"],track "+trackId),this.state=State_KEY_LOADING,hls.trigger(events.default.KEY_LOADING,{frag:frag})):(this.fragCurrent=frag,(audioSwitch||this.fragmentTracker.getState(frag)===FragmentState_NOT_LOADED)&&(logger.logger.log("Loading "+frag.sn+", cc: "+frag.cc+" of ["+trackDetails.startSN+" ,"+trackDetails.endSN+"],track "+trackId+", "+(this.loadedmetadata?"currentTime":"nextLoadPosition")+": "+pos+", bufferEnd: "+bufferEnd.toFixed(3)),"initSegment"!==frag.sn&&(this.startFragRequested=!0),Object(number.isFiniteNumber)(frag.sn)&&(this.nextLoadPosition=frag.start+frag.duration),hls.trigger(events.default.FRAG_LOADING,{frag:frag}),this.state=State_FRAG_LOADING)))}break;case State_WAITING_TRACK:(track=this.tracks[this.trackId])&&track.details&&(this.state=State_IDLE);break;case State_FRAG_LOADING_WAITING_RETRY:var now=audio_stream_controller_performance.now(),retryDate=this.retryDate,isSeeking=(media=this.media)&&media.seeking;(!retryDate||now>=retryDate||isSeeking)&&(logger.logger.log("audioStreamController: retryDate reached, switch back to IDLE state"),this.state=State_IDLE);break;case State_WAITING_INIT_PTS:var waitingFrag=this.waitingFragment;if(waitingFrag){var waitingFragCC=waitingFrag.frag.cc;if(void 0!==this.initPTS[waitingFragCC])this.waitingFragment=null,this.state=State_FRAG_LOADING,this.onFragLoaded(waitingFrag);else if(this.videoTrackCC!==this.waitingVideoCC)logger.logger.log("Waiting fragment cc ("+waitingFragCC+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var _bufferInfo=BufferHelper.bufferInfo(this.mediaBuffer,this.media.currentTime,config.maxBufferHole);fragmentWithinToleranceTest(_bufferInfo.end,config.maxFragLookUpTolerance,waitingFrag.frag)<0&&(logger.logger.log("Waiting fragment cc ("+waitingFragCC+") @ "+waitingFrag.frag.start+" cancelled because another fragment at "+_bufferInfo.end+" is needed"),this.clearWaitingFragment())}}else this.state=State_IDLE}},_proto.clearWaitingFragment=function clearWaitingFragment(){var waitingFrag=this.waitingFragment;waitingFrag&&(this.fragmentTracker.removeFragment(waitingFrag.frag),this.waitingFragment=null,this.waitingVideoCC=null,this.state=State_IDLE)},_proto.onMediaAttached=function onMediaAttached(data){var media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),media.addEventListener("seeking",this.onvseeking),media.addEventListener("ended",this.onvended);var config=this.config;this.tracks&&config.autoStartLoad&&this.startLoad(config.startPosition)},_proto.onMediaDetaching=function onMediaDetaching(){var media=this.media;media&&media.ended&&(logger.logger.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),media&&(media.removeEventListener("seeking",this.onvseeking),media.removeEventListener("ended",this.onvended),this.onvseeking=this.onvseeked=this.onvended=null),this.media=this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},_proto.onAudioTracksUpdated=function onAudioTracksUpdated(data){logger.logger.log("audio tracks updated"),this.tracks=data.audioTracks},_proto.onAudioTrackSwitching=function onAudioTrackSwitching(data){var altAudio=!!data.url;this.trackId=data.id,this.fragCurrent=null,this.clearWaitingFragment(),this.state=State_PAUSED,altAudio?this.setInterval(100):this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),altAudio&&(this.audioSwitch=!0,this.state=State_IDLE),this.tick()},_proto.onAudioTrackLoaded=function onAudioTrackLoaded(data){var newDetails=data.details,trackId=data.id,track=this.tracks[trackId],curDetails=track.details,duration=newDetails.totalduration,sliding=0;if(logger.logger.log("track "+trackId+" loaded ["+newDetails.startSN+","+newDetails.endSN+"],duration:"+duration),newDetails.live||curDetails&&curDetails.live?curDetails&&newDetails.fragments.length>0?(mergeDetails(curDetails,newDetails),sliding=newDetails.fragments[0].start,newDetails.PTSKnown?logger.logger.log("live audio playlist sliding:"+sliding.toFixed(3)):logger.logger.log("live audio playlist - outdated PTS, unknown sliding")):(newDetails.PTSKnown=!1,logger.logger.log("live audio playlist - first load, unknown sliding")):newDetails.PTSKnown=!1,track.details=newDetails,!this.startFragRequested){if(-1===this.startPosition){var startTimeOffset=newDetails.startTimeOffset;Object(number.isFiniteNumber)(startTimeOffset)?(logger.logger.log("start time offset found in playlist, adjust startPosition to "+startTimeOffset),this.startPosition=startTimeOffset):newDetails.live?(this.startPosition=this.computeLivePosition(sliding,newDetails),logger.logger.log("compute startPosition for audio-track to "+this.startPosition)):this.startPosition=0}this.nextLoadPosition=this.startPosition}this.state===State_WAITING_TRACK&&(this.state=State_IDLE),this.tick()},_proto.onKeyLoaded=function onKeyLoaded(){this.state===State_KEY_LOADING&&(this.state=State_IDLE,this.tick())},_proto.onFragLoaded=function onFragLoaded(data){var fragCurrent=this.fragCurrent,fragLoaded=data.frag;if(this.state===State_FRAG_LOADING&&fragCurrent&&"audio"===fragLoaded.type&&fragLoaded.level===fragCurrent.level&&fragLoaded.sn===fragCurrent.sn){var track=this.tracks[this.trackId],details=track.details,duration=details.totalduration,trackId=fragCurrent.level,sn=fragCurrent.sn,cc=fragCurrent.cc,audioCodec=this.config.defaultAudioCodec||track.audioCodec||"mp4a.40.2",stats=this.stats=data.stats;if("initSegment"===sn)this.state=State_IDLE,stats.tparsed=stats.tbuffered=audio_stream_controller_performance.now(),details.initSegment.data=data.payload,this.hls.trigger(events.default.FRAG_BUFFERED,{stats:stats,frag:fragCurrent,id:"audio"}),this.tick();else{this.state=State_PARSING,this.appended=!1,this.demuxer||(this.demuxer=new demux_demuxer(this.hls,"audio"));var initPTS=this.initPTS[cc],initSegmentData=details.initSegment?details.initSegment.data:[];if(void 0!==initPTS){this.pendingBuffering=!0,logger.logger.log("Demuxing "+sn+" of ["+details.startSN+" ,"+details.endSN+"],track "+trackId);this.demuxer.push(data.payload,initSegmentData,audioCodec,null,fragCurrent,duration,!1,initPTS)}else logger.logger.log("Unknown video PTS for cc "+cc+", waiting for video PTS before demuxing audio frag "+sn+" of ["+details.startSN+" ,"+details.endSN+"],track "+trackId),this.waitingFragment=data,this.waitingVideoCC=this.videoTrackCC,this.state=State_WAITING_INIT_PTS}}this.fragLoadError=0},_proto.onFragParsingInitSegment=function onFragParsingInitSegment(data){var fragCurrent=this.fragCurrent,fragNew=data.frag;if(fragCurrent&&"audio"===data.id&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State_PARSING){var track,tracks=data.tracks;if(tracks.video&&delete tracks.video,track=tracks.audio){track.levelCodec=track.codec,track.id=data.id,this.hls.trigger(events.default.BUFFER_CODECS,tracks),logger.logger.log("audio track:audio,container:"+track.container+",codecs[level/parsed]=["+track.levelCodec+"/"+track.codec+"]");var initSegment=track.initSegment;if(initSegment){var appendObj={type:"audio",data:initSegment,parent:"audio",content:"initSegment"};this.audioSwitch?this.pendingData=[appendObj]:(this.appended=!0,this.pendingBuffering=!0,this.hls.trigger(events.default.BUFFER_APPENDING,appendObj))}this.tick()}}},_proto.onFragParsingData=function onFragParsingData(data){var _this2=this,fragCurrent=this.fragCurrent,fragNew=data.frag;if(fragCurrent&&"audio"===data.id&&"audio"===data.type&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State_PARSING){var trackId=this.trackId,track=this.tracks[trackId],hls=this.hls;Object(number.isFiniteNumber)(data.endPTS)||(data.endPTS=data.startPTS+fragCurrent.duration,data.endDTS=data.startDTS+fragCurrent.duration),fragCurrent.addElementaryStream(ElementaryStreamTypes.AUDIO),logger.logger.log("parsed "+data.type+",PTS:["+data.startPTS.toFixed(3)+","+data.endPTS.toFixed(3)+"],DTS:["+data.startDTS.toFixed(3)+"/"+data.endDTS.toFixed(3)+"],nb:"+data.nb),updateFragPTSDTS(track.details,fragCurrent,data.startPTS,data.endPTS);var media=this.media,appendOnBufferFlush=!1;if(this.audioSwitch)if(media&&media.readyState){var currentTime=media.currentTime;logger.logger.log("switching audio track : currentTime:"+currentTime),currentTime>=data.startPTS&&(logger.logger.log("switching audio track : flushing all audio"),this.state=State_BUFFER_FLUSHING,hls.trigger(events.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),appendOnBufferFlush=!0,this.audioSwitch=!1,hls.trigger(events.default.AUDIO_TRACK_SWITCHED,{id:trackId}))}else this.audioSwitch=!1,hls.trigger(events.default.AUDIO_TRACK_SWITCHED,{id:trackId});var pendingData=this.pendingData;if(!pendingData)return logger.logger.warn("Apparently attempt to enqueue media payload without codec initialization data upfront"),void hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.MEDIA_ERROR,details:null,fatal:!0});this.audioSwitch||([data.data1,data.data2].forEach((function(buffer){buffer&&buffer.length&&pendingData.push({type:data.type,data:buffer,parent:"audio",content:"data"})})),!appendOnBufferFlush&&pendingData.length&&(pendingData.forEach((function(appendObj){_this2.state===State_PARSING&&(_this2.pendingBuffering=!0,_this2.hls.trigger(events.default.BUFFER_APPENDING,appendObj))})),this.pendingData=[],this.appended=!0)),this.tick()}},_proto.onFragParsed=function onFragParsed(data){var fragCurrent=this.fragCurrent,fragNew=data.frag;fragCurrent&&"audio"===data.id&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State_PARSING&&(this.stats.tparsed=audio_stream_controller_performance.now(),this.state=State_PARSED,this._checkAppendedParsed())},_proto.onBufferReset=function onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},_proto.onBufferCreated=function onBufferCreated(data){var audioTrack=data.tracks.audio;audioTrack&&(this.mediaBuffer=audioTrack.buffer,this.loadedmetadata=!0),data.tracks.video&&(this.videoBuffer=data.tracks.video.buffer)},_proto.onBufferAppended=function onBufferAppended(data){if("audio"===data.parent){var state=this.state;state!==State_PARSING&&state!==State_PARSED||(this.pendingBuffering=data.pending>0,this._checkAppendedParsed())}},_proto._checkAppendedParsed=function _checkAppendedParsed(){if(!(this.state!==State_PARSED||this.appended&&this.pendingBuffering)){var frag=this.fragCurrent,stats=this.stats,hls=this.hls;if(frag){this.fragPrevious=frag,stats.tbuffered=audio_stream_controller_performance.now(),hls.trigger(events.default.FRAG_BUFFERED,{stats:stats,frag:frag,id:"audio"});var media=this.mediaBuffer?this.mediaBuffer:this.media;media&&logger.logger.log("audio buffered : "+time_ranges.toString(media.buffered)),this.audioSwitch&&this.appended&&(this.audioSwitch=!1,hls.trigger(events.default.AUDIO_TRACK_SWITCHED,{id:this.trackId})),this.state=State_IDLE}this.tick()}},_proto.onError=function onError(data){var frag=data.frag;if(!frag||"audio"===frag.type)switch(data.details){case errors.ErrorDetails.FRAG_LOAD_ERROR:case errors.ErrorDetails.FRAG_LOAD_TIMEOUT:var _frag=data.frag;if(_frag&&"audio"!==_frag.type)break;if(!data.fatal){var loadError=this.fragLoadError;loadError?loadError++:loadError=1;var config=this.config;if(loadError<=config.fragLoadingMaxRetry){this.fragLoadError=loadError;var delay=Math.min(Math.pow(2,loadError-1)*config.fragLoadingRetryDelay,config.fragLoadingMaxRetryTimeout);logger.logger.warn("AudioStreamController: frag loading failed, retry in "+delay+" ms"),this.retryDate=audio_stream_controller_performance.now()+delay,this.state=State_FRAG_LOADING_WAITING_RETRY}else logger.logger.error("AudioStreamController: "+data.details+" reaches max retry, redispatch as fatal ..."),data.fatal=!0,this.state=State_ERROR}break;case errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case errors.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:case errors.ErrorDetails.KEY_LOAD_ERROR:case errors.ErrorDetails.KEY_LOAD_TIMEOUT:this.state!==State_ERROR&&(this.state=data.fatal?State_ERROR:State_IDLE,logger.logger.warn("AudioStreamController: "+data.details+" while loading frag, now switching to "+this.state+" state ..."));break;case errors.ErrorDetails.BUFFER_FULL_ERROR:if("audio"===data.parent&&(this.state===State_PARSING||this.state===State_PARSED)){var media=this.mediaBuffer,currentTime=this.media.currentTime;if(media&&BufferHelper.isBuffered(media,currentTime)&&BufferHelper.isBuffered(media,currentTime+.5)){var _config=this.config;_config.maxMaxBufferLength>=_config.maxBufferLength&&(_config.maxMaxBufferLength/=2,logger.logger.warn("AudioStreamController: reduce max buffer length to "+_config.maxMaxBufferLength+"s")),this.state=State_IDLE}else logger.logger.warn("AudioStreamController: buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,this.state=State_BUFFER_FLUSHING,this.hls.trigger(events.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"})}}},_proto.onBufferFlushed=function onBufferFlushed(){var _this3=this,pendingData=this.pendingData;pendingData&&pendingData.length?(logger.logger.log("AudioStreamController: appending pending audio data after buffer flushed"),pendingData.forEach((function(appendObj){_this3.hls.trigger(events.default.BUFFER_APPENDING,appendObj)})),this.appended=!0,this.pendingData=[],this.state=State_PARSED):(this.state=State_IDLE,this.fragPrevious=null,this.tick())},function audio_stream_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&audio_stream_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&audio_stream_controller_defineProperties(Constructor,staticProps),Constructor}(AudioStreamController,[{key:"state",set:function set(nextState){if(this.state!==nextState){var previousState=this.state;this._state=nextState,logger.logger.log("audio stream:"+previousState+"->"+nextState)}},get:function get(){return this._state}}]),AudioStreamController}(base_stream_controller_BaseStreamController),vttcue=function(){if("undefined"!=typeof window&&window.VTTCue)return window.VTTCue;var directionSetting={"":!0,lr:!0,rl:!0},alignSetting={start:!0,middle:!0,end:!0,left:!0,right:!0};function findAlignSetting(value){return"string"==typeof value&&(!!alignSetting[value.toLowerCase()]&&value.toLowerCase())}function extend(obj){for(var i=1;i<arguments.length;i++){var cobj=arguments[i];for(var p in cobj)obj[p]=cobj[p]}return obj}function VTTCue(startTime,endTime,text){var cue=this,baseObj={enumerable:!0};cue.hasBeenReset=!1;var _id="",_pauseOnExit=!1,_startTime=startTime,_endTime=endTime,_text=text,_region=null,_vertical="",_snapToLines=!0,_line="auto",_lineAlign="start",_position=50,_positionAlign="middle",_size=50,_align="middle";Object.defineProperty(cue,"id",extend({},baseObj,{get:function get(){return _id},set:function set(value){_id=""+value}})),Object.defineProperty(cue,"pauseOnExit",extend({},baseObj,{get:function get(){return _pauseOnExit},set:function set(value){_pauseOnExit=!!value}})),Object.defineProperty(cue,"startTime",extend({},baseObj,{get:function get(){return _startTime},set:function set(value){if("number"!=typeof value)throw new TypeError("Start time must be set to a number.");_startTime=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"endTime",extend({},baseObj,{get:function get(){return _endTime},set:function set(value){if("number"!=typeof value)throw new TypeError("End time must be set to a number.");_endTime=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"text",extend({},baseObj,{get:function get(){return _text},set:function set(value){_text=""+value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"region",extend({},baseObj,{get:function get(){return _region},set:function set(value){_region=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"vertical",extend({},baseObj,{get:function get(){return _vertical},set:function set(value){var setting=function findDirectionSetting(value){return"string"==typeof value&&!!directionSetting[value.toLowerCase()]&&value.toLowerCase()}(value);if(!1===setting)throw new SyntaxError("An invalid or illegal string was specified.");_vertical=setting,this.hasBeenReset=!0}})),Object.defineProperty(cue,"snapToLines",extend({},baseObj,{get:function get(){return _snapToLines},set:function set(value){_snapToLines=!!value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"line",extend({},baseObj,{get:function get(){return _line},set:function set(value){if("number"!=typeof value&&"auto"!==value)throw new SyntaxError("An invalid number or illegal string was specified.");_line=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"lineAlign",extend({},baseObj,{get:function get(){return _lineAlign},set:function set(value){var setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_lineAlign=setting,this.hasBeenReset=!0}})),Object.defineProperty(cue,"position",extend({},baseObj,{get:function get(){return _position},set:function set(value){if(value<0||value>100)throw new Error("Position must be between 0 and 100.");_position=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"positionAlign",extend({},baseObj,{get:function get(){return _positionAlign},set:function set(value){var setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_positionAlign=setting,this.hasBeenReset=!0}})),Object.defineProperty(cue,"size",extend({},baseObj,{get:function get(){return _size},set:function set(value){if(value<0||value>100)throw new Error("Size must be between 0 and 100.");_size=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"align",extend({},baseObj,{get:function get(){return _align},set:function set(value){var setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_align=setting,this.hasBeenReset=!0}})),cue.displayState=void 0}return VTTCue.prototype.getCueAsHTML=function(){return window.WebVTT.convertCueToDOMTree(window,this.text)},VTTCue}(),StringDecoder=function StringDecoder(){return{decode:function decode(data){if(!data)return"";if("string"!=typeof data)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(data))}}};function VTTParser(){this.window=window,this.state="INITIAL",this.buffer="",this.decoder=new StringDecoder,this.regionList=[]}function Settings(){this.values=Object.create(null)}function parseOptions(input,callback,keyValueDelim,groupDelim){var groups=groupDelim?input.split(groupDelim):[input];for(var i in groups)if("string"==typeof groups[i]){var kv=groups[i].split(keyValueDelim);if(2===kv.length)callback(kv[0],kv[1])}}Settings.prototype={set:function set(k,v){this.get(k)||""===v||(this.values[k]=v)},get:function get(k,dflt,defaultKey){return defaultKey?this.has(k)?this.values[k]:dflt[defaultKey]:this.has(k)?this.values[k]:dflt},has:function has(k){return k in this.values},alt:function alt(k,v,a){for(var n=0;n<a.length;++n)if(v===a[n]){this.set(k,v);break}},integer:function integer(k,v){/^-?\d+$/.test(v)&&this.set(k,parseInt(v,10))},percent:function percent(k,v){return!!(v.match(/^([\d]{1,3})(\.[\d]*)?%$/)&&(v=parseFloat(v))>=0&&v<=100)&&(this.set(k,v),!0)}};var defaults=new vttcue(0,0,0),center="middle"===defaults.align?"middle":"center";function parseCue(input,cue,regionList){var oInput=input;function consumeTimeStamp(){var ts=function parseTimeStamp(input){function computeSeconds(h,m,s,f){return 3600*(0|h)+60*(0|m)+(0|s)+(0|f)/1e3}var m=input.match(/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/);return m?m[3]?computeSeconds(m[1],m[2],m[3].replace(":",""),m[4]):m[1]>59?computeSeconds(m[1],m[2],0,m[4]):computeSeconds(0,m[1],m[2],m[4]):null}(input);if(null===ts)throw new Error("Malformed timestamp: "+oInput);return input=input.replace(/^[^\sa-zA-Z-]+/,""),ts}function skipWhitespace(){input=input.replace(/^\s+/,"")}if(skipWhitespace(),cue.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==input.substr(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+oInput);input=input.substr(3),skipWhitespace(),cue.endTime=consumeTimeStamp(),skipWhitespace(),function consumeCueSettings(input,cue){var settings=new Settings;parseOptions(input,(function(k,v){switch(k){case"region":for(var i=regionList.length-1;i>=0;i--)if(regionList[i].id===v){settings.set(k,regionList[i].region);break}break;case"vertical":settings.alt(k,v,["rl","lr"]);break;case"line":var vals=v.split(","),vals0=vals[0];settings.integer(k,vals0),settings.percent(k,vals0)&&settings.set("snapToLines",!1),settings.alt(k,vals0,["auto"]),2===vals.length&&settings.alt("lineAlign",vals[1],["start",center,"end"]);break;case"position":vals=v.split(","),settings.percent(k,vals[0]),2===vals.length&&settings.alt("positionAlign",vals[1],["start",center,"end","line-left","line-right","auto"]);break;case"size":settings.percent(k,v);break;case"align":settings.alt(k,v,["start",center,"end","left","right"])}}),/:/,/\s/),cue.region=settings.get("region",null),cue.vertical=settings.get("vertical","");var line=settings.get("line","auto");"auto"===line&&-1===defaults.line&&(line=-1),cue.line=line,cue.lineAlign=settings.get("lineAlign","start"),cue.snapToLines=settings.get("snapToLines",!0),cue.size=settings.get("size",100),cue.align=settings.get("align",center);var position=settings.get("position","auto");"auto"===position&&50===defaults.position&&(position="start"===cue.align||"left"===cue.align?0:"end"===cue.align||"right"===cue.align?100:50),cue.position=position}(input,cue)}function fixLineBreaks(input){return input.replace(/<br(?: \/)?>/gi,"\n")}VTTParser.prototype={parse:function parse(data){var self=this;function collectNextLine(){var buffer=self.buffer,pos=0;for(buffer=fixLineBreaks(buffer);pos<buffer.length&&"\r"!==buffer[pos]&&"\n"!==buffer[pos];)++pos;var line=buffer.substr(0,pos);return"\r"===buffer[pos]&&++pos,"\n"===buffer[pos]&&++pos,self.buffer=buffer.substr(pos),line}data&&(self.buffer+=self.decoder.decode(data,{stream:!0}));try{var line;if("INITIAL"===self.state){if(!/\r\n|\n/.test(self.buffer))return this;var m=(line=collectNextLine()).match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!m||!m[0])throw new Error("Malformed WebVTT signature.");self.state="HEADER"}for(var alreadyCollectedLine=!1;self.buffer;){if(!/\r\n|\n/.test(self.buffer))return this;switch(alreadyCollectedLine?alreadyCollectedLine=!1:line=collectNextLine(),self.state){case"HEADER":/:/.test(line)?parseOptions(line,(function(k,v){}),/:/):line||(self.state="ID");continue;case"NOTE":line||(self.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(line)){self.state="NOTE";break}if(!line)continue;if(self.cue=new vttcue(0,0,""),self.state="CUE",-1===line.indexOf("--\x3e")){self.cue.id=line;continue}case"CUE":try{parseCue(line,self.cue,self.regionList)}catch(e){self.cue=null,self.state="BADCUE";continue}self.state="CUETEXT";continue;case"CUETEXT":var hasSubstring=-1!==line.indexOf("--\x3e");if(!line||hasSubstring&&(alreadyCollectedLine=!0)){self.oncue&&self.oncue(self.cue),self.cue=null,self.state="ID";continue}self.cue.text&&(self.cue.text+="\n"),self.cue.text+=line;continue;case"BADCUE":line||(self.state="ID");continue}}}catch(e){"CUETEXT"===self.state&&self.cue&&self.oncue&&self.oncue(self.cue),self.cue=null,self.state="INITIAL"===self.state?"BADWEBVTT":"BADCUE"}return this},flush:function flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new Error("Malformed WebVTT signature.")}catch(e){throw e}return this.onflush&&this.onflush(),this}};var vttparser=VTTParser;function newCue(track,startTime,endTime,captionScreen){for(var row,cue,indenting,indent,text,result=[],VTTCue=window.VTTCue||TextTrackCue,r=0;r<captionScreen.rows.length;r++)if(indenting=!0,indent=0,text="",!(row=captionScreen.rows[r]).isEmpty()){for(var c=0;c<row.chars.length;c++)row.chars[c].uchar.match(/\s/)&&indenting?indent++:(text+=row.chars[c].uchar,indenting=!1);row.cueStartTime=startTime,startTime===endTime&&(endTime+=1e-4),cue=new VTTCue(startTime,endTime,fixLineBreaks(text.trim())),indent>=16?indent--:indent++,navigator.userAgent.match(/Firefox\//)?cue.line=r+1:cue.line=r>7?r-2:r+1,cue.align="left",cue.position=Math.max(0,Math.min(100,indent/32*100)),result.push(cue),track&&track.addCue(cue)}return result}var VerboseLevel,specialCea608CharsCodes={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},getCharForByte=function getCharForByte(_byte){var charCode=_byte;return specialCea608CharsCodes.hasOwnProperty(_byte)&&(charCode=specialCea608CharsCodes[_byte]),String.fromCharCode(charCode)},rowsLowCh1={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},rowsHighCh1={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rowsLowCh2={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},rowsHighCh2={25:2,26:4,29:6,30:8,31:10,27:13,28:15},backgroundColors=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];!function(VerboseLevel){VerboseLevel[VerboseLevel.ERROR=0]="ERROR",VerboseLevel[VerboseLevel.TEXT=1]="TEXT",VerboseLevel[VerboseLevel.WARNING=2]="WARNING",VerboseLevel[VerboseLevel.INFO=2]="INFO",VerboseLevel[VerboseLevel.DEBUG=3]="DEBUG",VerboseLevel[VerboseLevel.DATA=3]="DATA"}(VerboseLevel||(VerboseLevel={}));var cea_608_parser_CaptionsLogger=function(){function CaptionsLogger(){this.time=null,this.verboseLevel=VerboseLevel.ERROR}return CaptionsLogger.prototype.log=function log(severity,msg){this.verboseLevel>=severity&&logger.logger.log(this.time+" ["+severity+"] "+msg)},CaptionsLogger}(),numArrayToHexArray=function numArrayToHexArray(numArray){for(var hexArray=[],j=0;j<numArray.length;j++)hexArray.push(numArray[j].toString(16));return hexArray},PenState=function(){function PenState(foreground,underline,italics,background,flash){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=foreground||"white",this.underline=underline||!1,this.italics=italics||!1,this.background=background||"black",this.flash=flash||!1}var _proto2=PenState.prototype;return _proto2.reset=function reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},_proto2.setStyles=function setStyles(styles){for(var attribs=["foreground","underline","italics","background","flash"],i=0;i<attribs.length;i++){var style=attribs[i];styles.hasOwnProperty(style)&&(this[style]=styles[style])}},_proto2.isDefault=function isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash},_proto2.equals=function equals(other){return this.foreground===other.foreground&&this.underline===other.underline&&this.italics===other.italics&&this.background===other.background&&this.flash===other.flash},_proto2.copy=function copy(newPenState){this.foreground=newPenState.foreground,this.underline=newPenState.underline,this.italics=newPenState.italics,this.background=newPenState.background,this.flash=newPenState.flash},_proto2.toString=function toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},PenState}(),StyledUnicodeChar=function(){function StyledUnicodeChar(uchar,foreground,underline,italics,background,flash){this.uchar=void 0,this.penState=void 0,this.uchar=uchar||" ",this.penState=new PenState(foreground,underline,italics,background,flash)}var _proto3=StyledUnicodeChar.prototype;return _proto3.reset=function reset(){this.uchar=" ",this.penState.reset()},_proto3.setChar=function setChar(uchar,newPenState){this.uchar=uchar,this.penState.copy(newPenState)},_proto3.setPenState=function setPenState(newPenState){this.penState.copy(newPenState)},_proto3.equals=function equals(other){return this.uchar===other.uchar&&this.penState.equals(other.penState)},_proto3.copy=function copy(newChar){this.uchar=newChar.uchar,this.penState.copy(newChar.penState)},_proto3.isEmpty=function isEmpty(){return" "===this.uchar&&this.penState.isDefault()},StyledUnicodeChar}(),Row=function(){function Row(logger){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var i=0;i<100;i++)this.chars.push(new StyledUnicodeChar);this.logger=logger,this.pos=0,this.currPenState=new PenState}var _proto4=Row.prototype;return _proto4.equals=function equals(other){for(var equal=!0,i=0;i<100;i++)if(!this.chars[i].equals(other.chars[i])){equal=!1;break}return equal},_proto4.copy=function copy(other){for(var i=0;i<100;i++)this.chars[i].copy(other.chars[i])},_proto4.isEmpty=function isEmpty(){for(var empty=!0,i=0;i<100;i++)if(!this.chars[i].isEmpty()){empty=!1;break}return empty},_proto4.setCursor=function setCursor(absPos){this.pos!==absPos&&(this.pos=absPos),this.pos<0?(this.logger.log(VerboseLevel.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(VerboseLevel.DEBUG,"Too large cursor position "+this.pos),this.pos=100)},_proto4.moveCursor=function moveCursor(relPos){var newPos=this.pos+relPos;if(relPos>1)for(var i=this.pos+1;i<newPos+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(newPos)},_proto4.backSpace=function backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},_proto4.insertChar=function insertChar(_byte2){_byte2>=144&&this.backSpace();var _char=getCharForByte(_byte2);this.pos>=100?this.logger.log(VerboseLevel.ERROR,"Cannot insert "+_byte2.toString(16)+" ("+_char+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(_char,this.currPenState),this.moveCursor(1))},_proto4.clearFromPos=function clearFromPos(startPos){var i;for(i=startPos;i<100;i++)this.chars[i].reset()},_proto4.clear=function clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},_proto4.clearToEndOfRow=function clearToEndOfRow(){this.clearFromPos(this.pos)},_proto4.getTextString=function getTextString(){for(var chars=[],empty=!0,i=0;i<100;i++){var _char2=this.chars[i].uchar;" "!==_char2&&(empty=!1),chars.push(_char2)}return empty?"":chars.join("")},_proto4.setPenStyles=function setPenStyles(styles){this.currPenState.setStyles(styles),this.chars[this.pos].setPenState(this.currPenState)},Row}(),CaptionScreen=function(){function CaptionScreen(logger){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var i=0;i<15;i++)this.rows.push(new Row(logger));this.logger=logger,this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var _proto5=CaptionScreen.prototype;return _proto5.reset=function reset(){for(var i=0;i<15;i++)this.rows[i].clear();this.currRow=14},_proto5.equals=function equals(other){for(var equal=!0,i=0;i<15;i++)if(!this.rows[i].equals(other.rows[i])){equal=!1;break}return equal},_proto5.copy=function copy(other){for(var i=0;i<15;i++)this.rows[i].copy(other.rows[i])},_proto5.isEmpty=function isEmpty(){for(var empty=!0,i=0;i<15;i++)if(!this.rows[i].isEmpty()){empty=!1;break}return empty},_proto5.backSpace=function backSpace(){this.rows[this.currRow].backSpace()},_proto5.clearToEndOfRow=function clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()},_proto5.insertChar=function insertChar(_char3){this.rows[this.currRow].insertChar(_char3)},_proto5.setPen=function setPen(styles){this.rows[this.currRow].setPenStyles(styles)},_proto5.moveCursor=function moveCursor(relPos){this.rows[this.currRow].moveCursor(relPos)},_proto5.setCursor=function setCursor(absPos){this.logger.log(VerboseLevel.INFO,"setCursor: "+absPos),this.rows[this.currRow].setCursor(absPos)},_proto5.setPAC=function setPAC(pacData){this.logger.log(VerboseLevel.INFO,"pacData = "+JSON.stringify(pacData));var newRow=pacData.row-1;if(this.nrRollUpRows&&newRow<this.nrRollUpRows-1&&(newRow=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==newRow){for(var i=0;i<15;i++)this.rows[i].clear();var topRowIndex=this.currRow+1-this.nrRollUpRows,lastOutputScreen=this.lastOutputScreen;if(lastOutputScreen){var prevLineTime=lastOutputScreen.rows[topRowIndex].cueStartTime,time=this.logger.time;if(prevLineTime&&null!==time&&prevLineTime<time)for(var _i=0;_i<this.nrRollUpRows;_i++)this.rows[newRow-this.nrRollUpRows+_i+1].copy(lastOutputScreen.rows[topRowIndex+_i])}}this.currRow=newRow;var row=this.rows[this.currRow];if(null!==pacData.indent){var indent=pacData.indent,prevPos=Math.max(indent-1,0);row.setCursor(pacData.indent),pacData.color=row.chars[prevPos].penState.foreground}var styles={foreground:pacData.color,underline:pacData.underline,italics:pacData.italics,background:"black",flash:!1};this.setPen(styles)},_proto5.setBkgData=function setBkgData(bkgData){this.logger.log(VerboseLevel.INFO,"bkgData = "+JSON.stringify(bkgData)),this.backSpace(),this.setPen(bkgData),this.insertChar(32)},_proto5.setRollUpRows=function setRollUpRows(nrRows){this.nrRollUpRows=nrRows},_proto5.rollUp=function rollUp(){if(null!==this.nrRollUpRows){this.logger.log(VerboseLevel.TEXT,this.getDisplayText());var topRowIndex=this.currRow+1-this.nrRollUpRows,topRow=this.rows.splice(topRowIndex,1)[0];topRow.clear(),this.rows.splice(this.currRow,0,topRow),this.logger.log(VerboseLevel.INFO,"Rolling up")}else this.logger.log(VerboseLevel.DEBUG,"roll_up but nrRollUpRows not set yet")},_proto5.getDisplayText=function getDisplayText(asOneRow){asOneRow=asOneRow||!1;for(var displayText=[],text="",rowNr=-1,i=0;i<15;i++){var rowText=this.rows[i].getTextString();rowText&&(rowNr=i+1,asOneRow?displayText.push("Row "+rowNr+": '"+rowText+"'"):displayText.push(rowText.trim()))}return displayText.length>0&&(text=asOneRow?"["+displayText.join(" | ")+"]":displayText.join("\n")),text},_proto5.getTextAndFormat=function getTextAndFormat(){return this.rows},CaptionScreen}(),Cea608Channel=function(){function Cea608Channel(channelNumber,outputFilter,logger){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=channelNumber,this.outputFilter=outputFilter,this.mode=null,this.verbose=0,this.displayedMemory=new CaptionScreen(logger),this.nonDisplayedMemory=new CaptionScreen(logger),this.lastOutputScreen=new CaptionScreen(logger),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=logger}var _proto6=Cea608Channel.prototype;return _proto6.reset=function reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},_proto6.getHandler=function getHandler(){return this.outputFilter},_proto6.setHandler=function setHandler(newHandler){this.outputFilter=newHandler},_proto6.setPAC=function setPAC(pacData){this.writeScreen.setPAC(pacData)},_proto6.setBkgData=function setBkgData(bkgData){this.writeScreen.setBkgData(bkgData)},_proto6.setMode=function setMode(newMode){newMode!==this.mode&&(this.mode=newMode,this.logger.log(VerboseLevel.INFO,"MODE="+newMode),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=newMode)},_proto6.insertChars=function insertChars(chars){for(var i=0;i<chars.length;i++)this.writeScreen.insertChar(chars[i]);var screen=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(VerboseLevel.INFO,screen+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(VerboseLevel.TEXT,"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())},_proto6.ccRCL=function ccRCL(){this.logger.log(VerboseLevel.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},_proto6.ccBS=function ccBS(){this.logger.log(VerboseLevel.INFO,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},_proto6.ccAOF=function ccAOF(){},_proto6.ccAON=function ccAON(){},_proto6.ccDER=function ccDER(){this.logger.log(VerboseLevel.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},_proto6.ccRU=function ccRU(nrRows){this.logger.log(VerboseLevel.INFO,"RU("+nrRows+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(nrRows)},_proto6.ccFON=function ccFON(){this.logger.log(VerboseLevel.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},_proto6.ccRDC=function ccRDC(){this.logger.log(VerboseLevel.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},_proto6.ccTR=function ccTR(){this.logger.log(VerboseLevel.INFO,"TR"),this.setMode("MODE_TEXT")},_proto6.ccRTD=function ccRTD(){this.logger.log(VerboseLevel.INFO,"RTD"),this.setMode("MODE_TEXT")},_proto6.ccEDM=function ccEDM(){this.logger.log(VerboseLevel.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},_proto6.ccCR=function ccCR(){this.logger.log(VerboseLevel.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},_proto6.ccENM=function ccENM(){this.logger.log(VerboseLevel.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},_proto6.ccEOC=function ccEOC(){if(this.logger.log(VerboseLevel.INFO,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var tmp=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=tmp,this.writeScreen=this.nonDisplayedMemory,this.logger.log(VerboseLevel.TEXT,"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)},_proto6.ccTO=function ccTO(nrCols){this.logger.log(VerboseLevel.INFO,"TO("+nrCols+") - Tab Offset"),this.writeScreen.moveCursor(nrCols)},_proto6.ccMIDROW=function ccMIDROW(secondByte){var styles={flash:!1};if(styles.underline=secondByte%2==1,styles.italics=secondByte>=46,styles.italics)styles.foreground="white";else{var colorIndex=Math.floor(secondByte/2)-16;styles.foreground=["white","green","blue","cyan","red","yellow","magenta"][colorIndex]}this.logger.log(VerboseLevel.INFO,"MIDROW: "+JSON.stringify(styles)),this.writeScreen.setPen(styles)},_proto6.outputDataUpdate=function outputDataUpdate(dispatch){void 0===dispatch&&(dispatch=!1);var time=this.logger.time;null!==time&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,time,this.lastOutputScreen),dispatch&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:time):this.cueStartTime=time,this.lastOutputScreen.copy(this.displayedMemory))},_proto6.cueSplitAtTime=function cueSplitAtTime(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))},Cea608Channel}();function setLastCmd(a,b,cmdHistory){cmdHistory.a=a,cmdHistory.b=b}function hasCmdRepeated(a,b,cmdHistory){return cmdHistory.a===a&&cmdHistory.b===b}var cea_608_parser=function(){function Cea608Parser(field,out1,out2){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var logger=new cea_608_parser_CaptionsLogger;this.channels=[null,new Cea608Channel(field,out1,logger),new Cea608Channel(field+1,out2,logger)],this.cmdHistory={a:null,b:null},this.logger=logger}var _proto7=Cea608Parser.prototype;return _proto7.getHandler=function getHandler(channel){return this.channels[channel].getHandler()},_proto7.setHandler=function setHandler(channel,newHandler){this.channels[channel].setHandler(newHandler)},_proto7.addData=function addData(time,byteList){var cmdFound,a,b,charsFound=!1;this.logger.time=time;for(var i=0;i<byteList.length;i+=2)if(a=127&byteList[i],b=127&byteList[i+1],0!==a||0!==b){if(this.logger.log(VerboseLevel.DATA,"["+numArrayToHexArray([byteList[i],byteList[i+1]])+"] -> ("+numArrayToHexArray([a,b])+")"),(cmdFound=this.parseCmd(a,b))||(cmdFound=this.parseMidrow(a,b)),cmdFound||(cmdFound=this.parsePAC(a,b)),cmdFound||(cmdFound=this.parseBackgroundAttributes(a,b)),!cmdFound&&(charsFound=this.parseChars(a,b))){var currChNr=this.currentChannel;if(currChNr&&currChNr>0)this.channels[currChNr].insertChars(charsFound);else this.logger.log(VerboseLevel.WARNING,"No channel found yet. TEXT-MODE?")}cmdFound||charsFound||this.logger.log(VerboseLevel.WARNING,"Couldn't parse cleaned data "+numArrayToHexArray([a,b])+" orig: "+numArrayToHexArray([byteList[i],byteList[i+1]]))}},_proto7.parseCmd=function parseCmd(a,b){var cmdHistory=this.cmdHistory;if(!((20===a||28===a||21===a||29===a)&&b>=32&&b<=47)&&!((23===a||31===a)&&b>=33&&b<=35))return!1;if(hasCmdRepeated(a,b,cmdHistory))return setLastCmd(null,null,cmdHistory),this.logger.log(VerboseLevel.DEBUG,"Repeated command ("+numArrayToHexArray([a,b])+") is dropped"),!0;var chNr=20===a||21===a||23===a?1:2,channel=this.channels[chNr];return 20===a||21===a||28===a||29===a?32===b?channel.ccRCL():33===b?channel.ccBS():34===b?channel.ccAOF():35===b?channel.ccAON():36===b?channel.ccDER():37===b?channel.ccRU(2):38===b?channel.ccRU(3):39===b?channel.ccRU(4):40===b?channel.ccFON():41===b?channel.ccRDC():42===b?channel.ccTR():43===b?channel.ccRTD():44===b?channel.ccEDM():45===b?channel.ccCR():46===b?channel.ccENM():47===b&&channel.ccEOC():channel.ccTO(b-32),setLastCmd(a,b,cmdHistory),this.currentChannel=chNr,!0},_proto7.parseMidrow=function parseMidrow(a,b){var chNr=0;if((17===a||25===a)&&b>=32&&b<=47){if((chNr=17===a?1:2)!==this.currentChannel)return this.logger.log(VerboseLevel.ERROR,"Mismatch channel in midrow parsing"),!1;var channel=this.channels[chNr];return!!channel&&(channel.ccMIDROW(b),this.logger.log(VerboseLevel.DEBUG,"MIDROW ("+numArrayToHexArray([a,b])+")"),!0)}return!1},_proto7.parsePAC=function parsePAC(a,b){var row,cmdHistory=this.cmdHistory;if(!((a>=17&&a<=23||a>=25&&a<=31)&&b>=64&&b<=127)&&!((16===a||24===a)&&b>=64&&b<=95))return!1;if(hasCmdRepeated(a,b,cmdHistory))return setLastCmd(null,null,cmdHistory),!0;var chNr=a<=23?1:2;row=b>=64&&b<=95?1===chNr?rowsLowCh1[a]:rowsLowCh2[a]:1===chNr?rowsHighCh1[a]:rowsHighCh2[a];var channel=this.channels[chNr];return!!channel&&(channel.setPAC(this.interpretPAC(row,b)),setLastCmd(a,b,cmdHistory),this.currentChannel=chNr,!0)},_proto7.interpretPAC=function interpretPAC(row,_byte3){var pacIndex=_byte3,pacData={color:null,italics:!1,indent:null,underline:!1,row:row};return pacIndex=_byte3>95?_byte3-96:_byte3-64,pacData.underline=1==(1&pacIndex),pacIndex<=13?pacData.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(pacIndex/2)]:pacIndex<=15?(pacData.italics=!0,pacData.color="white"):pacData.indent=4*Math.floor((pacIndex-16)/2),pacData},_proto7.parseChars=function parseChars(a,b){var channelNr,charCodes=null,charCode1=null;if(a>=25?(channelNr=2,charCode1=a-8):(channelNr=1,charCode1=a),charCode1>=17&&charCode1<=19){var oneCode=b;oneCode=17===charCode1?b+80:18===charCode1?b+112:b+144,this.logger.log(VerboseLevel.INFO,"Special char '"+getCharForByte(oneCode)+"' in channel "+channelNr),charCodes=[oneCode]}else a>=32&&a<=127&&(charCodes=0===b?[a]:[a,b]);if(charCodes){var hexCodes=numArrayToHexArray(charCodes);this.logger.log(VerboseLevel.DEBUG,"Char codes =  "+hexCodes.join(",")),setLastCmd(a,b,this.cmdHistory)}return charCodes},_proto7.parseBackgroundAttributes=function parseBackgroundAttributes(a,b){var index;if(!((16===a||24===a)&&b>=32&&b<=47)&&!((23===a||31===a)&&b>=45&&b<=47))return!1;var bkgData={};16===a||24===a?(index=Math.floor((b-32)/2),bkgData.background=backgroundColors[index],b%2==1&&(bkgData.background=bkgData.background+"_semi")):45===b?bkgData.background="transparent":(bkgData.foreground="black",47===b&&(bkgData.underline=!0));var chNr=a<=23?1:2;return this.channels[chNr].setBkgData(bkgData),setLastCmd(a,b,this.cmdHistory),!0},_proto7.reset=function reset(){for(var i=0;i<Object.keys(this.channels).length;i++){var channel=this.channels[i];channel&&channel.reset()}this.cmdHistory={a:null,b:null}},_proto7.cueSplitAtTime=function cueSplitAtTime(t){for(var i=0;i<this.channels.length;i++){var channel=this.channels[i];channel&&channel.cueSplitAtTime(t)}},Cea608Parser}(),OutputFilter=function(){function OutputFilter(timelineController,trackName){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=timelineController,this.trackName=trackName}var _proto=OutputFilter.prototype;return _proto.dispatchCue=function dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},_proto.newCue=function newCue(startTime,endTime,screen){(null===this.startTime||this.startTime>startTime)&&(this.startTime=startTime),this.endTime=endTime,this.screen=screen,this.timelineController.createCaptionsTrack(this.trackName)},_proto.reset=function reset(){this.cueRanges=[]},OutputFilter}(),startsWith=function startsWith(inputString,searchString,position){return inputString.substr(position||0,searchString.length)===searchString},hash=function hash(text){for(var hash=5381,i=text.length;i;)hash=33*hash^text.charCodeAt(--i);return(hash>>>0).toString()},webvtt_parser={parse:function parse(vttByteArray,syncPTS,vttCCs,cc,callBack,errorCallBack){var parsingError,vttLines=Object(id3.utf8ArrayToStr)(new Uint8Array(vttByteArray)).trim().replace(/\r\n|\n\r|\n|\r/g,"\n").split("\n"),cueTime="00:00.000",mpegTs=0,localTime=0,presentationTime=0,cues=[],inHeader=!0,timestampMap=!1,parser=new vttparser;parser.oncue=function(cue){var currCC=vttCCs[cc],cueOffset=vttCCs.ccOffset;currCC&&currCC.new&&(void 0!==localTime?cueOffset=vttCCs.ccOffset=currCC.start:function calculateOffset(vttCCs,cc,presentationTime){var currCC=vttCCs[cc],prevCC=vttCCs[currCC.prevCC];if(!prevCC||!prevCC.new&&currCC.new)return vttCCs.ccOffset=vttCCs.presentationOffset=currCC.start,void(currCC.new=!1);for(;prevCC&&prevCC.new;)vttCCs.ccOffset+=currCC.start-prevCC.start,currCC.new=!1,prevCC=vttCCs[(currCC=prevCC).prevCC];vttCCs.presentationOffset=presentationTime}(vttCCs,cc,presentationTime)),presentationTime&&(cueOffset=presentationTime-vttCCs.presentationOffset),timestampMap&&(cue.startTime+=cueOffset-localTime,cue.endTime+=cueOffset-localTime),cue.id=hash(cue.startTime.toString())+hash(cue.endTime.toString())+hash(cue.text),cue.text=decodeURIComponent(encodeURIComponent(cue.text)),cue.endTime>0&&cues.push(cue)},parser.onparsingerror=function(e){parsingError=e},parser.onflush=function(){parsingError&&errorCallBack?errorCallBack(parsingError):callBack(cues)},vttLines.forEach((function(line){if(inHeader){if(startsWith(line,"X-TIMESTAMP-MAP=")){inHeader=!1,timestampMap=!0,line.substr(16).split(",").forEach((function(timestamp){startsWith(timestamp,"LOCAL:")?cueTime=timestamp.substr(6):startsWith(timestamp,"MPEGTS:")&&(mpegTs=parseInt(timestamp.substr(7)))}));try{syncPTS+(9e4*vttCCs[cc].start||0)<0&&(syncPTS+=8589934592),mpegTs-=syncPTS,localTime=function cueString2millis(timeString){var ts=parseInt(timeString.substr(-3)),secs=parseInt(timeString.substr(-6,2)),mins=parseInt(timeString.substr(-9,2)),hours=timeString.length>9?parseInt(timeString.substr(0,timeString.indexOf(":"))):0;if(!(Object(number.isFiniteNumber)(ts)&&Object(number.isFiniteNumber)(secs)&&Object(number.isFiniteNumber)(mins)&&Object(number.isFiniteNumber)(hours)))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+timeString);return ts+=1e3*secs,ts+=6e4*mins,ts+36e5*hours}(cueTime)/1e3,presentationTime=mpegTs/9e4}catch(e){timestampMap=!1,parsingError=e}return}""===line&&(inHeader=!1)}parser.parse(line+"\n")})),parser.flush()}};function timeline_controller_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function canReuseVttTextTrack(inUseTrack,manifestTrack){return inUseTrack&&inUseTrack.label===manifestTrack.name&&!(inUseTrack.textTrack1||inUseTrack.textTrack2)}var timeline_controller=function(_EventHandler){function TimelineController(hls){var _this;if((_this=_EventHandler.call(this,hls,events.default.MEDIA_ATTACHING,events.default.MEDIA_DETACHING,events.default.FRAG_PARSING_USERDATA,events.default.FRAG_DECRYPTED,events.default.MANIFEST_LOADING,events.default.MANIFEST_LOADED,events.default.FRAG_LOADED,events.default.INIT_PTS_FOUND)||this).media=null,_this.config=void 0,_this.enabled=!0,_this.Cues=void 0,_this.textTracks=[],_this.tracks=[],_this.initPTS=[],_this.unparsedVttFrags=[],_this.captionsTracks={},_this.nonNativeCaptionsTracks={},_this.captionsProperties=void 0,_this.cea608Parser1=void 0,_this.cea608Parser2=void 0,_this.lastSn=-1,_this.prevCC=-1,_this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!1}},_this.hls=hls,_this.config=hls.config,_this.Cues=hls.config.cueHandler,_this.captionsProperties={textTrack1:{label:_this.config.captionsTextTrack1Label,languageCode:_this.config.captionsTextTrack1LanguageCode},textTrack2:{label:_this.config.captionsTextTrack2Label,languageCode:_this.config.captionsTextTrack2LanguageCode},textTrack3:{label:_this.config.captionsTextTrack3Label,languageCode:_this.config.captionsTextTrack3LanguageCode},textTrack4:{label:_this.config.captionsTextTrack4Label,languageCode:_this.config.captionsTextTrack4LanguageCode}},_this.config.enableCEA708Captions){var channel1=new OutputFilter(timeline_controller_assertThisInitialized(_this),"textTrack1"),channel2=new OutputFilter(timeline_controller_assertThisInitialized(_this),"textTrack2"),channel3=new OutputFilter(timeline_controller_assertThisInitialized(_this),"textTrack3"),channel4=new OutputFilter(timeline_controller_assertThisInitialized(_this),"textTrack4");_this.cea608Parser1=new cea_608_parser(1,channel1,channel2),_this.cea608Parser2=new cea_608_parser(3,channel3,channel4)}return _this}!function timeline_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(TimelineController,_EventHandler);var _proto=TimelineController.prototype;return _proto.addCues=function addCues(trackName,startTime,endTime,screen,cueRanges){for(var x1,x2,y1,y2,merged=!1,i=cueRanges.length;i--;){var cueRange=cueRanges[i],overlap=(x1=cueRange[0],x2=cueRange[1],y1=startTime,y2=endTime,Math.min(x2,y2)-Math.max(x1,y1));if(overlap>=0&&(cueRange[0]=Math.min(cueRange[0],startTime),cueRange[1]=Math.max(cueRange[1],endTime),merged=!0,overlap/(endTime-startTime)>.5))return}if(merged||cueRanges.push([startTime,endTime]),this.config.renderTextTracksNatively)this.Cues.newCue(this.captionsTracks[trackName],startTime,endTime,screen);else{var cues=this.Cues.newCue(null,startTime,endTime,screen);this.hls.trigger(events.default.CUES_PARSED,{type:"captions",cues:cues,track:trackName})}},_proto.onInitPtsFound=function onInitPtsFound(data){var _this2=this,frag=data.frag,id=data.id,initPTS=data.initPTS,unparsedVttFrags=this.unparsedVttFrags;"main"===id&&(this.initPTS[frag.cc]=initPTS),unparsedVttFrags.length&&(this.unparsedVttFrags=[],unparsedVttFrags.forEach((function(frag){_this2.onFragLoaded(frag)})))},_proto.getExistingTrack=function getExistingTrack(trackName){var media=this.media;if(media)for(var i=0;i<media.textTracks.length;i++){var textTrack=media.textTracks[i];if(textTrack[trackName])return textTrack}return null},_proto.createCaptionsTrack=function createCaptionsTrack(trackName){this.config.renderTextTracksNatively?this.createNativeTrack(trackName):this.createNonNativeTrack(trackName)},_proto.createNativeTrack=function createNativeTrack(trackName){if(!this.captionsTracks[trackName]){var captionsProperties=this.captionsProperties,captionsTracks=this.captionsTracks,media=this.media,_captionsProperties$t=captionsProperties[trackName],label=_captionsProperties$t.label,languageCode=_captionsProperties$t.languageCode,existingTrack=this.getExistingTrack(trackName);if(existingTrack)captionsTracks[trackName]=existingTrack,clearCurrentCues(captionsTracks[trackName]),sendAddTrackEvent(captionsTracks[trackName],media);else{var textTrack=this.createTextTrack("captions",label,languageCode);textTrack&&(textTrack[trackName]=!0,captionsTracks[trackName]=textTrack)}}},_proto.createNonNativeTrack=function createNonNativeTrack(trackName){if(!this.nonNativeCaptionsTracks[trackName]){var trackProperties=this.captionsProperties[trackName];if(trackProperties){var track={_id:trackName,label:trackProperties.label,kind:"captions",default:!!trackProperties.media&&!!trackProperties.media.default,closedCaptions:trackProperties.media};this.nonNativeCaptionsTracks[trackName]=track,this.hls.trigger(events.default.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[track]})}}},_proto.createTextTrack=function createTextTrack(kind,label,lang){var media=this.media;if(media)return media.addTextTrack(kind,label,lang)},_proto.destroy=function destroy(){_EventHandler.prototype.destroy.call(this)},_proto.onMediaAttaching=function onMediaAttaching(data){this.media=data.media,this._cleanTracks()},_proto.onMediaDetaching=function onMediaDetaching(){var captionsTracks=this.captionsTracks;Object.keys(captionsTracks).forEach((function(trackName){clearCurrentCues(captionsTracks[trackName]),delete captionsTracks[trackName]})),this.nonNativeCaptionsTracks={}},_proto.onManifestLoading=function onManifestLoading(){this.lastSn=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!1}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={}},_proto._cleanTracks=function _cleanTracks(){var media=this.media;if(media){var textTracks=media.textTracks;if(textTracks)for(var i=0;i<textTracks.length;i++)clearCurrentCues(textTracks[i])}},_proto.onManifestLoaded=function onManifestLoaded(data){var _this3=this;if(this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset()),this.config.enableWebVTT){var tracks=data.subtitles||[],sameTracks=this.tracks&&tracks&&this.tracks.length===tracks.length;if(this.tracks=data.subtitles||[],this.config.renderTextTracksNatively){var inUseTracks=this.media?this.media.textTracks:[];this.tracks.forEach((function(track,index){var textTrack;if(index<inUseTracks.length){for(var inUseTrack=null,i=0;i<inUseTracks.length;i++)if(canReuseVttTextTrack(inUseTracks[i],track)){inUseTrack=inUseTracks[i];break}inUseTrack&&(textTrack=inUseTrack)}textTrack||(textTrack=_this3.createTextTrack("subtitles",track.name,track.lang)),track.default?textTrack.mode=_this3.hls.subtitleDisplay?"showing":"hidden":textTrack.mode="disabled",_this3.textTracks.push(textTrack)}))}else if(!sameTracks&&this.tracks&&this.tracks.length){var tracksList=this.tracks.map((function(track){return{label:track.name,kind:track.type.toLowerCase(),default:track.default,subtitleTrack:track}}));this.hls.trigger(events.default.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:tracksList})}}this.config.enableCEA708Captions&&data.captions&&data.captions.forEach((function(captionsTrack){var instreamIdMatch=/(?:CC|SERVICE)([1-4])/.exec(captionsTrack.instreamId);if(instreamIdMatch){var trackName="textTrack"+instreamIdMatch[1],trackProperties=_this3.captionsProperties[trackName];trackProperties&&(trackProperties.label=captionsTrack.name,captionsTrack.lang&&(trackProperties.languageCode=captionsTrack.lang),trackProperties.media=captionsTrack)}}))},_proto.onFragLoaded=function onFragLoaded(data){var frag=data.frag,payload=data.payload,cea608Parser1=this.cea608Parser1,cea608Parser2=this.cea608Parser2,initPTS=this.initPTS,lastSn=this.lastSn,unparsedVttFrags=this.unparsedVttFrags;if("main"===frag.type){var sn=frag.sn;frag.sn!==lastSn+1&&cea608Parser1&&cea608Parser2&&(cea608Parser1.reset(),cea608Parser2.reset()),this.lastSn=sn}else if("subtitle"===frag.type)if(payload.byteLength){if(!Object(number.isFiniteNumber)(initPTS[frag.cc]))return unparsedVttFrags.push(data),void(initPTS.length&&this.hls.trigger(events.default.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:frag}));var decryptData=frag.decryptdata;null!=decryptData&&null!=decryptData.key&&"AES-128"===decryptData.method||this._parseVTTs(frag,payload)}else this.hls.trigger(events.default.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:frag})},_proto._parseVTTs=function _parseVTTs(frag,payload){var _this4=this,hls=this.hls,prevCC=this.prevCC,textTracks=this.textTracks,vttCCs=this.vttCCs;vttCCs[frag.cc]||(vttCCs[frag.cc]={start:frag.start,prevCC:prevCC,new:!0},this.prevCC=frag.cc),webvtt_parser.parse(payload,this.initPTS[frag.cc],vttCCs,frag.cc,(function(cues){if(_this4.config.renderTextTracksNatively){var currentTrack=textTracks[frag.level];if("disabled"===currentTrack.mode)return void hls.trigger(events.default.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:frag});cues.forEach((function(cue){if(!currentTrack.cues.getCueById(cue.id))try{if(currentTrack.addCue(cue),!currentTrack.cues.getCueById(cue.id))throw new Error("addCue is failed for: "+cue)}catch(err){logger.logger.debug("Failed occurred on adding cues: "+err);var textTrackCue=new window.TextTrackCue(cue.startTime,cue.endTime,cue.text);textTrackCue.id=cue.id,currentTrack.addCue(textTrackCue)}}))}else{var trackId=_this4.tracks[frag.level].default?"default":"subtitles"+frag.level;hls.trigger(events.default.CUES_PARSED,{type:"subtitles",cues:cues,track:trackId})}hls.trigger(events.default.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:frag})}),(function(e){logger.logger.log("Failed to parse VTT cue: "+e),hls.trigger(events.default.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:frag})}))},_proto.onFragDecrypted=function onFragDecrypted(data){var frag=data.frag,payload=data.payload;if("subtitle"===frag.type){if(!Object(number.isFiniteNumber)(this.initPTS[frag.cc]))return void this.unparsedVttFrags.push(data);this._parseVTTs(frag,payload)}},_proto.onFragParsingUserdata=function onFragParsingUserdata(data){var cea608Parser1=this.cea608Parser1,cea608Parser2=this.cea608Parser2;if(this.enabled&&cea608Parser1&&cea608Parser2)for(var i=0;i<data.samples.length;i++){var ccBytes=data.samples[i].bytes;if(ccBytes){var ccdatas=this.extractCea608Data(ccBytes);cea608Parser1.addData(data.samples[i].pts,ccdatas[0]),cea608Parser2.addData(data.samples[i].pts,ccdatas[1])}}},_proto.extractCea608Data=function extractCea608Data(byteArray){for(var count=31&byteArray[0],position=2,actualCCBytes=[[],[]],j=0;j<count;j++){var tmpByte=byteArray[position++],ccbyte1=127&byteArray[position++],ccbyte2=127&byteArray[position++],ccType=3&tmpByte;0===ccbyte1&&0===ccbyte2||0!=(4&tmpByte)&&(0!==ccType&&1!==ccType||(actualCCBytes[ccType].push(ccbyte1),actualCCBytes[ccType].push(ccbyte2)))}return actualCCBytes},TimelineController}(event_handler);function subtitle_track_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function filterSubtitleTracks(textTrackList){for(var tracks=[],i=0;i<textTrackList.length;i++){var track=textTrackList[i];"subtitles"===track.kind&&track.label&&tracks.push(textTrackList[i])}return tracks}var subtitle_track_controller=function(_EventHandler){function SubtitleTrackController(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.MEDIA_ATTACHED,events.default.MEDIA_DETACHING,events.default.MANIFEST_LOADED,events.default.SUBTITLE_TRACK_LOADED)||this).tracks=[],_this.trackId=-1,_this.media=null,_this.stopped=!0,_this.subtitleDisplay=!0,_this.queuedDefaultTrack=null,_this}!function subtitle_track_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(SubtitleTrackController,_EventHandler);var _proto=SubtitleTrackController.prototype;return _proto.destroy=function destroy(){event_handler.prototype.destroy.call(this)},_proto.onMediaAttached=function onMediaAttached(data){var _this2=this;this.media=data.media,this.media&&(Object(number.isFiniteNumber)(this.queuedDefaultTrack)&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=null),this.trackChangeListener=this._onTextTracksChanged.bind(this),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.subtitlePollingInterval=setInterval((function(){_this2.trackChangeListener()}),500):this.media.textTracks.addEventListener("change",this.trackChangeListener))},_proto.onMediaDetaching=function onMediaDetaching(){this.media&&(this.useTextTrackPolling?clearInterval(this.subtitlePollingInterval):this.media.textTracks.removeEventListener("change",this.trackChangeListener),Object(number.isFiniteNumber)(this.subtitleTrack)&&(this.queuedDefaultTrack=this.subtitleTrack),filterSubtitleTracks(this.media.textTracks).forEach((function(track){clearCurrentCues(track)})),this.subtitleTrack=-1,this.media=null)},_proto.onManifestLoaded=function onManifestLoaded(data){var _this3=this,tracks=data.subtitles||[];this.tracks=tracks,this.hls.trigger(events.default.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:tracks}),tracks.forEach((function(track){track.default&&(_this3.media?_this3.subtitleTrack=track.id:_this3.queuedDefaultTrack=track.id)}))},_proto.onSubtitleTrackLoaded=function onSubtitleTrackLoaded(data){var _this4=this,id=data.id,details=data.details,trackId=this.trackId,tracks=this.tracks,currentTrack=tracks[trackId];if(id>=tracks.length||id!==trackId||!currentTrack||this.stopped)this._clearReloadTimer();else if(logger.logger.log("subtitle track "+id+" loaded"),details.live){var reloadInterval=computeReloadInterval(currentTrack.details,details,data.stats.trequest);logger.logger.log("Reloading live subtitle playlist in "+reloadInterval+"ms"),this.timer=setTimeout((function(){_this4._loadCurrentTrack()}),reloadInterval)}else this._clearReloadTimer()},_proto.startLoad=function startLoad(){this.stopped=!1,this._loadCurrentTrack()},_proto.stopLoad=function stopLoad(){this.stopped=!0,this._clearReloadTimer()},_proto._clearReloadTimer=function _clearReloadTimer(){this.timer&&(clearTimeout(this.timer),this.timer=null)},_proto._loadCurrentTrack=function _loadCurrentTrack(){var trackId=this.trackId,tracks=this.tracks,hls=this.hls,currentTrack=tracks[trackId];trackId<0||!currentTrack||currentTrack.details&&!currentTrack.details.live||(logger.logger.log("Loading subtitle track "+trackId),hls.trigger(events.default.SUBTITLE_TRACK_LOADING,{url:currentTrack.url,id:trackId}))},_proto._toggleTrackModes=function _toggleTrackModes(newId){var media=this.media,subtitleDisplay=this.subtitleDisplay,trackId=this.trackId;if(media){var textTracks=filterSubtitleTracks(media.textTracks);if(-1===newId)[].slice.call(textTracks).forEach((function(track){track.mode="disabled"}));else{var oldTrack=textTracks[trackId];oldTrack&&(oldTrack.mode="disabled")}var nextTrack=textTracks[newId];nextTrack&&(nextTrack.mode=subtitleDisplay?"showing":"hidden")}},_proto._setSubtitleTrackInternal=function _setSubtitleTrackInternal(newId){var hls=this.hls,tracks=this.tracks;!Object(number.isFiniteNumber)(newId)||newId<-1||newId>=tracks.length||(this.trackId=newId,logger.logger.log("Switching to subtitle track "+newId),hls.trigger(events.default.SUBTITLE_TRACK_SWITCH,{id:newId}),this._loadCurrentTrack())},_proto._onTextTracksChanged=function _onTextTracksChanged(){if(this.media&&this.hls.config.renderTextTracksNatively){for(var trackId=-1,tracks=filterSubtitleTracks(this.media.textTracks),id=0;id<tracks.length;id++)if("hidden"===tracks[id].mode)trackId=id;else if("showing"===tracks[id].mode){trackId=id;break}this.subtitleTrack=trackId}},function subtitle_track_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&subtitle_track_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&subtitle_track_controller_defineProperties(Constructor,staticProps),Constructor}(SubtitleTrackController,[{key:"subtitleTracks",get:function get(){return this.tracks}},{key:"subtitleTrack",get:function get(){return this.trackId},set:function set(subtitleTrackId){this.trackId!==subtitleTrackId&&(this._toggleTrackModes(subtitleTrackId),this._setSubtitleTrackInternal(subtitleTrackId))}}]),SubtitleTrackController}(event_handler),decrypter=__webpack_require__("./src/crypt/decrypter.js");var KeySystems,subtitle_stream_controller_performance=window.performance,subtitle_stream_controller_SubtitleStreamController=function(_BaseStreamController){function SubtitleStreamController(hls,fragmentTracker){var _this;return(_this=_BaseStreamController.call(this,hls,events.default.MEDIA_ATTACHED,events.default.MEDIA_DETACHING,events.default.ERROR,events.default.KEY_LOADED,events.default.FRAG_LOADED,events.default.SUBTITLE_TRACKS_UPDATED,events.default.SUBTITLE_TRACK_SWITCH,events.default.SUBTITLE_TRACK_LOADED,events.default.SUBTITLE_FRAG_PROCESSED,events.default.LEVEL_UPDATED)||this).fragmentTracker=fragmentTracker,_this.config=hls.config,_this.state=State_STOPPED,_this.tracks=[],_this.tracksBuffered=[],_this.currentTrackId=-1,_this.decrypter=new decrypter.default(hls,hls.config),_this.lastAVStart=0,_this._onMediaSeeking=_this.onMediaSeeking.bind(function subtitle_stream_controller_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(_this)),_this}!function subtitle_stream_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(SubtitleStreamController,_BaseStreamController);var _proto=SubtitleStreamController.prototype;return _proto.startLoad=function startLoad(){this.stopLoad(),this.state=State_IDLE;var currentTrack=this.tracks[this.currentTrackId];currentTrack&&currentTrack.details&&(this.setInterval(500),this.tick())},_proto.onSubtitleFragProcessed=function onSubtitleFragProcessed(data){var frag=data.frag,success=data.success;if(this.fragPrevious=frag,this.state=State_IDLE,success){var buffered=this.tracksBuffered[this.currentTrackId];if(buffered){for(var timeRange,fragStart=frag.start,i=0;i<buffered.length;i++)if(fragStart>=buffered[i].start&&fragStart<=buffered[i].end){timeRange=buffered[i];break}var fragEnd=frag.start+frag.duration;timeRange?timeRange.end=fragEnd:(timeRange={start:fragStart,end:fragEnd},buffered.push(timeRange))}}},_proto.onMediaAttached=function onMediaAttached(_ref){var media=_ref.media;this.media=media,media.addEventListener("seeking",this._onMediaSeeking),this.state=State_IDLE},_proto.onMediaDetaching=function onMediaDetaching(){var _this2=this;this.media&&(this.media.removeEventListener("seeking",this._onMediaSeeking),this.fragmentTracker.removeAllFragments(),this.currentTrackId=-1,this.tracks.forEach((function(track){_this2.tracksBuffered[track.id]=[]})),this.media=null,this.state=State_STOPPED)},_proto.onError=function onError(data){var frag=data.frag;frag&&"subtitle"===frag.type&&(this.fragCurrent&&this.fragCurrent.loader&&this.fragCurrent.loader.abort(),this.state=State_IDLE)},_proto.onSubtitleTracksUpdated=function onSubtitleTracksUpdated(data){var _this3=this;logger.logger.log("subtitle tracks updated"),this.tracksBuffered=[],this.tracks=data.subtitleTracks,this.tracks.forEach((function(track){_this3.tracksBuffered[track.id]=[]}))},_proto.onSubtitleTrackSwitch=function onSubtitleTrackSwitch(data){if(this.currentTrackId=data.id,this.tracks&&this.tracks.length&&-1!==this.currentTrackId){var currentTrack=this.tracks[this.currentTrackId];currentTrack&&currentTrack.details&&this.setInterval(500)}else this.clearInterval()},_proto.onSubtitleTrackLoaded=function onSubtitleTrackLoaded(data){var id=data.id,details=data.details,currentTrackId=this.currentTrackId,tracks=this.tracks,currentTrack=tracks[currentTrackId];id>=tracks.length||id!==currentTrackId||!currentTrack||(details.live&&function mergeSubtitlePlaylists(oldPlaylist,newPlaylist,referenceStart){void 0===referenceStart&&(referenceStart=0);var lastIndex=-1;mapFragmentIntersection(oldPlaylist,newPlaylist,(function(oldFrag,newFrag,index){newFrag.start=oldFrag.start,lastIndex=index}));var frags=newPlaylist.fragments;if(lastIndex<0)frags.forEach((function(frag){frag.start+=referenceStart}));else for(var i=lastIndex+1;i<frags.length;i++)frags[i].start=frags[i-1].start+frags[i-1].duration}(currentTrack.details,details,this.lastAVStart),currentTrack.details=details,this.setInterval(500))},_proto.onKeyLoaded=function onKeyLoaded(){this.state===State_KEY_LOADING&&(this.state=State_IDLE)},_proto.onFragLoaded=function onFragLoaded(data){var fragCurrent=this.fragCurrent,decryptData=data.frag.decryptdata,fragLoaded=data.frag,hls=this.hls;if(this.state===State_FRAG_LOADING&&fragCurrent&&"subtitle"===data.frag.type&&fragCurrent.sn===data.frag.sn&&data.payload.byteLength>0&&decryptData&&decryptData.key&&"AES-128"===decryptData.method){var startTime=subtitle_stream_controller_performance.now();this.decrypter.decrypt(data.payload,decryptData.key.buffer,decryptData.iv.buffer,(function(decryptedData){var endTime=subtitle_stream_controller_performance.now();hls.trigger(events.default.FRAG_DECRYPTED,{frag:fragLoaded,payload:decryptedData,stats:{tstart:startTime,tdecrypt:endTime}})}))}},_proto.onLevelUpdated=function onLevelUpdated(_ref2){var frags=_ref2.details.fragments;this.lastAVStart=frags.length?frags[0].start:0},_proto.doTick=function doTick(){if(this.media)switch(this.state){case State_IDLE:var config=this.config,currentTrackId=this.currentTrackId,fragmentTracker=this.fragmentTracker,media=this.media,tracks=this.tracks;if(!tracks||!tracks[currentTrackId]||!tracks[currentTrackId].details)break;var foundFrag,maxBufferHole=config.maxBufferHole,maxFragLookUpTolerance=config.maxFragLookUpTolerance,maxConfigBuffer=Math.min(config.maxBufferLength,config.maxMaxBufferLength),bufferedInfo=BufferHelper.bufferedInfo(this._getBuffered(),media.currentTime,maxBufferHole),bufferEnd=bufferedInfo.end,bufferLen=bufferedInfo.len,trackDetails=tracks[currentTrackId].details,fragments=trackDetails.fragments,fragLen=fragments.length,end=fragments[fragLen-1].start+fragments[fragLen-1].duration;if(bufferLen>maxConfigBuffer)return;var fragPrevious=this.fragPrevious;bufferEnd<end?(fragPrevious&&trackDetails.hasProgramDateTime&&(foundFrag=findFragmentByPDT(fragments,fragPrevious.endProgramDateTime,maxFragLookUpTolerance)),foundFrag||(foundFrag=findFragmentByPTS(fragPrevious,fragments,bufferEnd,maxFragLookUpTolerance))):foundFrag=fragments[fragLen-1],foundFrag&&foundFrag.encrypted?(logger.logger.log("Loading key for "+foundFrag.sn),this.state=State_KEY_LOADING,this.hls.trigger(events.default.KEY_LOADING,{frag:foundFrag})):foundFrag&&fragmentTracker.getState(foundFrag)===FragmentState_NOT_LOADED&&(this.fragCurrent=foundFrag,this.state=State_FRAG_LOADING,this.hls.trigger(events.default.FRAG_LOADING,{frag:foundFrag}))}else this.state=State_IDLE},_proto.stopLoad=function stopLoad(){this.lastAVStart=0,this.fragPrevious=null,_BaseStreamController.prototype.stopLoad.call(this)},_proto._getBuffered=function _getBuffered(){return this.tracksBuffered[this.currentTrackId]||[]},_proto.onMediaSeeking=function onMediaSeeking(){if(this.fragCurrent){var currentTime=this.media?this.media.currentTime:0,tolerance=this.config.maxFragLookUpTolerance,fragStartOffset=this.fragCurrent.start-tolerance,fragEndOffset=this.fragCurrent.start+this.fragCurrent.duration+tolerance;(currentTime<fragStartOffset||currentTime>fragEndOffset)&&(this.fragCurrent.loader&&this.fragCurrent.loader.abort(),this.fragmentTracker.removeFragment(this.fragCurrent),this.fragCurrent=null,this.fragPrevious=null,this.state=State_IDLE,this.tick())}},SubtitleStreamController}(base_stream_controller_BaseStreamController);!function(KeySystems){KeySystems.WIDEVINE="com.widevine.alpha",KeySystems.PLAYREADY="com.microsoft.playready"}(KeySystems||(KeySystems={}));var requestMediaKeySystemAccess="undefined"!=typeof window&&window.navigator&&window.navigator.requestMediaKeySystemAccess?window.navigator.requestMediaKeySystemAccess.bind(window.navigator):null;function eme_controller_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var eme_controller=function(_EventHandler){function EMEController(hls){var _this;return(_this=_EventHandler.call(this,hls,events.default.MEDIA_ATTACHED,events.default.MEDIA_DETACHED,events.default.MANIFEST_PARSED)||this)._widevineLicenseUrl=void 0,_this._licenseXhrSetup=void 0,_this._emeEnabled=void 0,_this._requestMediaKeySystemAccess=void 0,_this._drmSystemOptions=void 0,_this._config=void 0,_this._mediaKeysList=[],_this._media=null,_this._hasSetMediaKeys=!1,_this._requestLicenseFailureCount=0,_this.mediaKeysPromise=null,_this._onMediaEncrypted=function(e){if(logger.logger.log('Media is encrypted using "'+e.initDataType+'" init data type'),!_this.mediaKeysPromise)return logger.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been requested"),void _this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});var finallySetKeyAndStartSession=function finallySetKeyAndStartSession(mediaKeys){_this._media&&(_this._attemptSetMediaKeys(mediaKeys),_this._generateRequestWithPreferredKeySession(e.initDataType,e.initData))};_this.mediaKeysPromise.then(finallySetKeyAndStartSession).catch(finallySetKeyAndStartSession)},_this._config=hls.config,_this._widevineLicenseUrl=_this._config.widevineLicenseUrl,_this._licenseXhrSetup=_this._config.licenseXhrSetup,_this._emeEnabled=_this._config.emeEnabled,_this._requestMediaKeySystemAccess=_this._config.requestMediaKeySystemAccessFunc,_this._drmSystemOptions=hls.config.drmSystemOptions,_this}!function eme_controller_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(EMEController,_EventHandler);var _proto=EMEController.prototype;return _proto.getLicenseServerUrl=function getLicenseServerUrl(keySystem){switch(keySystem){case KeySystems.WIDEVINE:if(!this._widevineLicenseUrl)break;return this._widevineLicenseUrl}throw new Error('no license server URL configured for key-system "'+keySystem+'"')},_proto._attemptKeySystemAccess=function _attemptKeySystemAccess(keySystem,audioCodecs,videoCodecs){var _this2=this,mediaKeySystemConfigs=function getSupportedMediaKeySystemConfigurations(keySystem,audioCodecs,videoCodecs,drmSystemOptions){switch(keySystem){case KeySystems.WIDEVINE:return function createWidevineMediaKeySystemConfigurations(audioCodecs,videoCodecs,drmSystemOptions){var baseConfig={audioCapabilities:[],videoCapabilities:[]};return audioCodecs.forEach((function(codec){baseConfig.audioCapabilities.push({contentType:'audio/mp4; codecs="'+codec+'"',robustness:drmSystemOptions.audioRobustness||""})})),videoCodecs.forEach((function(codec){baseConfig.videoCapabilities.push({contentType:'video/mp4; codecs="'+codec+'"',robustness:drmSystemOptions.videoRobustness||""})})),[baseConfig]}(audioCodecs,videoCodecs,drmSystemOptions);default:throw new Error("Unknown key-system: "+keySystem)}}(keySystem,audioCodecs,videoCodecs,this._drmSystemOptions);logger.logger.log("Requesting encrypted media key-system access");var keySystemAccessPromise=this.requestMediaKeySystemAccess(keySystem,mediaKeySystemConfigs);this.mediaKeysPromise=keySystemAccessPromise.then((function(mediaKeySystemAccess){return _this2._onMediaKeySystemAccessObtained(keySystem,mediaKeySystemAccess)})),keySystemAccessPromise.catch((function(err){logger.logger.error('Failed to obtain key-system "'+keySystem+'" access:',err)}))},_proto._onMediaKeySystemAccessObtained=function _onMediaKeySystemAccessObtained(keySystem,mediaKeySystemAccess){var _this3=this;logger.logger.log('Access for key-system "'+keySystem+'" obtained');var mediaKeysListItem={mediaKeysSessionInitialized:!1,mediaKeySystemAccess:mediaKeySystemAccess,mediaKeySystemDomain:keySystem};this._mediaKeysList.push(mediaKeysListItem);var mediaKeysPromise=Promise.resolve().then((function(){return mediaKeySystemAccess.createMediaKeys()})).then((function(mediaKeys){return mediaKeysListItem.mediaKeys=mediaKeys,logger.logger.log('Media-keys created for key-system "'+keySystem+'"'),_this3._onMediaKeysCreated(),mediaKeys}));return mediaKeysPromise.catch((function(err){logger.logger.error("Failed to create media-keys:",err)})),mediaKeysPromise},_proto._onMediaKeysCreated=function _onMediaKeysCreated(){var _this4=this;this._mediaKeysList.forEach((function(mediaKeysListItem){mediaKeysListItem.mediaKeysSession||(mediaKeysListItem.mediaKeysSession=mediaKeysListItem.mediaKeys.createSession(),_this4._onNewMediaKeySession(mediaKeysListItem.mediaKeysSession))}))},_proto._onNewMediaKeySession=function _onNewMediaKeySession(keySession){var _this5=this;logger.logger.log("New key-system session "+keySession.sessionId),keySession.addEventListener("message",(function(event){_this5._onKeySessionMessage(keySession,event.message)}),!1)},_proto._onKeySessionMessage=function _onKeySessionMessage(keySession,message){logger.logger.log("Got EME message event, creating license request"),this._requestLicense(message,(function(data){logger.logger.log("Received license data (length: "+(data?data.byteLength:data)+"), updating key-session"),keySession.update(data)}))},_proto._attemptSetMediaKeys=function _attemptSetMediaKeys(mediaKeys){if(!this._media)throw new Error("Attempted to set mediaKeys without first attaching a media element");if(!this._hasSetMediaKeys){var keysListItem=this._mediaKeysList[0];if(!keysListItem||!keysListItem.mediaKeys)return logger.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been obtained yet"),void this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});logger.logger.log("Setting keys for encrypted media"),this._media.setMediaKeys(keysListItem.mediaKeys),this._hasSetMediaKeys=!0}},_proto._generateRequestWithPreferredKeySession=function _generateRequestWithPreferredKeySession(initDataType,initData){var _this6=this,keysListItem=this._mediaKeysList[0];if(!keysListItem)return logger.logger.error("Fatal: Media is encrypted but not any key-system access has been obtained yet"),void this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});if(keysListItem.mediaKeysSessionInitialized)logger.logger.warn("Key-Session already initialized but requested again");else{var keySession=keysListItem.mediaKeysSession;if(!keySession)return logger.logger.error("Fatal: Media is encrypted but no key-session existing"),void this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!0});if(!initData)return logger.logger.warn("Fatal: initData required for generating a key session is null"),void this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_NO_INIT_DATA,fatal:!0});logger.logger.log('Generating key-session request for "'+initDataType+'" init data type'),keysListItem.mediaKeysSessionInitialized=!0,keySession.generateRequest(initDataType,initData).then((function(){logger.logger.debug("Key-session generation succeeded")})).catch((function(err){logger.logger.error("Error generating key-session request:",err),_this6.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!1})}))}},_proto._createLicenseXhr=function _createLicenseXhr(url,keyMessage,callback){var xhr=new XMLHttpRequest,licenseXhrSetup=this._licenseXhrSetup;try{if(licenseXhrSetup)try{licenseXhrSetup(xhr,url)}catch(e){xhr.open("POST",url,!0),licenseXhrSetup(xhr,url)}xhr.readyState||xhr.open("POST",url,!0)}catch(e){throw new Error("issue setting up KeySystem license XHR "+e)}return xhr.responseType="arraybuffer",xhr.onreadystatechange=this._onLicenseRequestReadyStageChange.bind(this,xhr,url,keyMessage,callback),xhr},_proto._onLicenseRequestReadyStageChange=function _onLicenseRequestReadyStageChange(xhr,url,keyMessage,callback){switch(xhr.readyState){case 4:if(200===xhr.status)this._requestLicenseFailureCount=0,logger.logger.log("License request succeeded"),"arraybuffer"!==xhr.responseType&&logger.logger.warn("xhr response type was not set to the expected arraybuffer for license request"),callback(xhr.response);else{if(logger.logger.error("License Request XHR failed ("+url+"). Status: "+xhr.status+" ("+xhr.statusText+")"),this._requestLicenseFailureCount++,this._requestLicenseFailureCount>3)return void this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0});var attemptsLeft=3-this._requestLicenseFailureCount+1;logger.logger.warn("Retrying license request, "+attemptsLeft+" attempts left"),this._requestLicense(keyMessage,callback)}}},_proto._generateLicenseRequestChallenge=function _generateLicenseRequestChallenge(keysListItem,keyMessage){switch(keysListItem.mediaKeySystemDomain){case KeySystems.WIDEVINE:return keyMessage}throw new Error("unsupported key-system: "+keysListItem.mediaKeySystemDomain)},_proto._requestLicense=function _requestLicense(keyMessage,callback){logger.logger.log("Requesting content license for key-system");var keysListItem=this._mediaKeysList[0];if(!keysListItem)return logger.logger.error("Fatal error: Media is encrypted but no key-system access has been obtained yet"),void this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});try{var _url=this.getLicenseServerUrl(keysListItem.mediaKeySystemDomain),_xhr=this._createLicenseXhr(_url,keyMessage,callback);logger.logger.log("Sending license request to URL: "+_url);var challenge=this._generateLicenseRequestChallenge(keysListItem,keyMessage);_xhr.send(challenge)}catch(e){logger.logger.error("Failure requesting DRM license: "+e),this.hls.trigger(events.default.ERROR,{type:errors.ErrorTypes.KEY_SYSTEM_ERROR,details:errors.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0})}},_proto.onMediaAttached=function onMediaAttached(data){if(this._emeEnabled){var media=data.media;this._media=media,media.addEventListener("encrypted",this._onMediaEncrypted)}},_proto.onMediaDetached=function onMediaDetached(){var media=this._media,mediaKeysList=this._mediaKeysList;media&&(media.removeEventListener("encrypted",this._onMediaEncrypted),this._media=null,this._mediaKeysList=[],Promise.all(mediaKeysList.map((function(mediaKeysListItem){if(mediaKeysListItem.mediaKeysSession)return mediaKeysListItem.mediaKeysSession.close().catch((function(){}))}))).then((function(){return media.setMediaKeys(null)})).catch((function(){})))},_proto.onManifestParsed=function onManifestParsed(data){if(this._emeEnabled){var audioCodecs=data.levels.map((function(level){return level.audioCodec})),videoCodecs=data.levels.map((function(level){return level.videoCodec}));this._attemptKeySystemAccess(KeySystems.WIDEVINE,audioCodecs,videoCodecs)}},function eme_controller_createClass(Constructor,protoProps,staticProps){return protoProps&&eme_controller_defineProperties(Constructor.prototype,protoProps),staticProps&&eme_controller_defineProperties(Constructor,staticProps),Constructor}(EMEController,[{key:"requestMediaKeySystemAccess",get:function get(){if(!this._requestMediaKeySystemAccess)throw new Error("No requestMediaKeySystemAccess function configured");return this._requestMediaKeySystemAccess}}]),EMEController}(event_handler);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var hlsDefaultConfig=_objectSpread(_objectSpread({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,initialLiveManifestSize:1,maxBufferLength:30,maxBufferSize:6e7,maxBufferHole:.5,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,liveDurationInfinity:!1,liveBackBufferLength:1/0,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:xhr_loader,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,abrController:abr_controller,bufferController:buffer_controller,capLevelController:cap_level_controller,fpsController:fps_controller,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:requestMediaKeySystemAccess,testBandwidth:!0},function timelineConfig(){return{cueHandler:cues_namespaceObject,enableCEA708Captions:!0,enableWebVTT:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}()),{},{subtitleStreamController:subtitle_stream_controller_SubtitleStreamController,subtitleTrackController:subtitle_track_controller,timelineController:timeline_controller,audioStreamController:audio_stream_controller,audioTrackController:audio_track_controller,emeController:eme_controller});function hls_ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function hls_objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?hls_ownKeys(Object(source),!0).forEach((function(key){hls_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):hls_ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}function hls_defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function hls_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function hls_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function hls_createClass(Constructor,protoProps,staticProps){return protoProps&&hls_defineProperties(Constructor.prototype,protoProps),staticProps&&hls_defineProperties(Constructor,staticProps),Constructor}var hls_Hls=function(_Observer){function Hls(userConfig){var _this;void 0===userConfig&&(userConfig={}),(_this=_Observer.call(this)||this).config=void 0,_this._autoLevelCapping=void 0,_this.abrController=void 0,_this.capLevelController=void 0,_this.levelController=void 0,_this.streamController=void 0,_this.networkControllers=void 0,_this.audioTrackController=void 0,_this.subtitleTrackController=void 0,_this.emeController=void 0,_this.coreComponents=void 0,_this.media=null,_this.url=null;var defaultConfig=Hls.DefaultConfig;if((userConfig.liveSyncDurationCount||userConfig.liveMaxLatencyDurationCount)&&(userConfig.liveSyncDuration||userConfig.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");_this.config=hls_objectSpread(hls_objectSpread({},defaultConfig),userConfig);var config=hls_assertThisInitialized(_this).config;if(void 0!==config.liveMaxLatencyDurationCount&&config.liveMaxLatencyDurationCount<=config.liveSyncDurationCount)throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be gt "liveSyncDurationCount"');if(void 0!==config.liveMaxLatencyDuration&&(void 0===config.liveSyncDuration||config.liveMaxLatencyDuration<=config.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be gt "liveSyncDuration"');Object(logger.enableLogs)(config.debug),_this._autoLevelCapping=-1;var abrController=_this.abrController=new config.abrController(hls_assertThisInitialized(_this)),bufferController=new config.bufferController(hls_assertThisInitialized(_this)),capLevelController=_this.capLevelController=new config.capLevelController(hls_assertThisInitialized(_this)),fpsController=new config.fpsController(hls_assertThisInitialized(_this)),playListLoader=new playlist_loader(hls_assertThisInitialized(_this)),fragmentLoader=new fragment_loader(hls_assertThisInitialized(_this)),keyLoader=new key_loader(hls_assertThisInitialized(_this)),id3TrackController=new id3_track_controller(hls_assertThisInitialized(_this)),levelController=_this.levelController=new level_controller_LevelController(hls_assertThisInitialized(_this)),fragmentTracker=new fragment_tracker_FragmentTracker(hls_assertThisInitialized(_this)),networkControllers=[levelController,_this.streamController=new stream_controller(hls_assertThisInitialized(_this),fragmentTracker)],Controller=config.audioStreamController;Controller&&networkControllers.push(new Controller(hls_assertThisInitialized(_this),fragmentTracker)),_this.networkControllers=networkControllers;var coreComponents=[playListLoader,fragmentLoader,keyLoader,abrController,bufferController,capLevelController,fpsController,id3TrackController,fragmentTracker];if(Controller=config.audioTrackController){var audioTrackController=new Controller(hls_assertThisInitialized(_this));_this.audioTrackController=audioTrackController,coreComponents.push(audioTrackController)}if(Controller=config.subtitleTrackController){var subtitleTrackController=new Controller(hls_assertThisInitialized(_this));_this.subtitleTrackController=subtitleTrackController,networkControllers.push(subtitleTrackController)}if(Controller=config.emeController){var emeController=new Controller(hls_assertThisInitialized(_this));_this.emeController=emeController,coreComponents.push(emeController)}return(Controller=config.subtitleStreamController)&&networkControllers.push(new Controller(hls_assertThisInitialized(_this),fragmentTracker)),(Controller=config.timelineController)&&coreComponents.push(new Controller(hls_assertThisInitialized(_this))),_this.coreComponents=coreComponents,_this}!function hls_inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}(Hls,_Observer),Hls.isSupported=function isSupported(){return function is_supported_isSupported(){var mediaSource=getMediaSource();if(!mediaSource)return!1;var sourceBuffer=self.SourceBuffer||self.WebKitSourceBuffer,isTypeSupported=mediaSource&&"function"==typeof mediaSource.isTypeSupported&&mediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),sourceBufferValidAPI=!sourceBuffer||sourceBuffer.prototype&&"function"==typeof sourceBuffer.prototype.appendBuffer&&"function"==typeof sourceBuffer.prototype.remove;return!!isTypeSupported&&!!sourceBufferValidAPI}()},hls_createClass(Hls,null,[{key:"version",get:function get(){return"0.14.17"}},{key:"Events",get:function get(){return events.default}},{key:"ErrorTypes",get:function get(){return errors.ErrorTypes}},{key:"ErrorDetails",get:function get(){return errors.ErrorDetails}},{key:"DefaultConfig",get:function get(){return Hls.defaultConfig?Hls.defaultConfig:hlsDefaultConfig},set:function set(defaultConfig){Hls.defaultConfig=defaultConfig}}]);var _proto=Hls.prototype;return _proto.destroy=function destroy(){logger.logger.log("destroy"),this.trigger(events.default.DESTROYING),this.detachMedia(),this.coreComponents.concat(this.networkControllers).forEach((function(component){component.destroy()})),this.url=null,this.removeAllListeners(),this._autoLevelCapping=-1},_proto.attachMedia=function attachMedia(media){logger.logger.log("attachMedia"),this.media=media,this.trigger(events.default.MEDIA_ATTACHING,{media:media})},_proto.detachMedia=function detachMedia(){logger.logger.log("detachMedia"),this.trigger(events.default.MEDIA_DETACHING),this.media=null},_proto.loadSource=function loadSource(url){url=url_toolkit.buildAbsoluteURL(window.location.href,url,{alwaysNormalize:!0}),logger.logger.log("loadSource:"+url),this.url=url,this.trigger(events.default.MANIFEST_LOADING,{url:url})},_proto.startLoad=function startLoad(startPosition){void 0===startPosition&&(startPosition=-1),logger.logger.log("startLoad("+startPosition+")"),this.networkControllers.forEach((function(controller){controller.startLoad(startPosition)}))},_proto.stopLoad=function stopLoad(){logger.logger.log("stopLoad"),this.networkControllers.forEach((function(controller){controller.stopLoad()}))},_proto.swapAudioCodec=function swapAudioCodec(){logger.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},_proto.recoverMediaError=function recoverMediaError(){logger.logger.log("recoverMediaError");var media=this.media;this.detachMedia(),media&&this.attachMedia(media)},_proto.removeLevel=function removeLevel(levelIndex,urlId){void 0===urlId&&(urlId=0),this.levelController.removeLevel(levelIndex,urlId)},hls_createClass(Hls,[{key:"levels",get:function get(){return this.levelController.levels}},{key:"currentLevel",get:function get(){return this.streamController.currentLevel},set:function set(newLevel){logger.logger.log("set currentLevel:"+newLevel),this.loadLevel=newLevel,this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function get(){return this.streamController.nextLevel},set:function set(newLevel){logger.logger.log("set nextLevel:"+newLevel),this.levelController.manualLevel=newLevel,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function get(){return this.levelController.level},set:function set(newLevel){logger.logger.log("set loadLevel:"+newLevel),this.levelController.manualLevel=newLevel}},{key:"nextLoadLevel",get:function get(){return this.levelController.nextLoadLevel},set:function set(level){this.levelController.nextLoadLevel=level}},{key:"firstLevel",get:function get(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function set(newLevel){logger.logger.log("set firstLevel:"+newLevel),this.levelController.firstLevel=newLevel}},{key:"startLevel",get:function get(){return this.levelController.startLevel},set:function set(newLevel){logger.logger.log("set startLevel:"+newLevel),-1!==newLevel&&(newLevel=Math.max(newLevel,this.minAutoLevel)),this.levelController.startLevel=newLevel}},{key:"capLevelToPlayerSize",set:function set(shouldStartCapping){var newCapLevelToPlayerSize=!!shouldStartCapping;newCapLevelToPlayerSize!==this.config.capLevelToPlayerSize&&(newCapLevelToPlayerSize?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=newCapLevelToPlayerSize)}},{key:"autoLevelCapping",get:function get(){return this._autoLevelCapping},set:function set(newLevel){logger.logger.log("set autoLevelCapping:"+newLevel),this._autoLevelCapping=newLevel}},{key:"bandwidthEstimate",get:function get(){var bwEstimator=this.abrController._bwEstimator;return bwEstimator?bwEstimator.getEstimate():NaN}},{key:"autoLevelEnabled",get:function get(){return-1===this.levelController.manualLevel}},{key:"manualLevel",get:function get(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function get(){for(var levels=this.levels,minAutoBitrate=this.config.minAutoBitrate,len=levels?levels.length:0,i=0;i<len;i++){if((levels[i].realBitrate?Math.max(levels[i].realBitrate,levels[i].bitrate):levels[i].bitrate)>minAutoBitrate)return i}return 0}},{key:"maxAutoLevel",get:function get(){var levels=this.levels,autoLevelCapping=this.autoLevelCapping;return-1===autoLevelCapping&&levels&&levels.length?levels.length-1:autoLevelCapping}},{key:"nextAutoLevel",get:function get(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function set(nextLevel){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,nextLevel)}},{key:"audioTracks",get:function get(){var audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTracks:[]}},{key:"audioTrack",get:function get(){var audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTrack:-1},set:function set(audioTrackId){var audioTrackController=this.audioTrackController;audioTrackController&&(audioTrackController.audioTrack=audioTrackId)}},{key:"liveSyncPosition",get:function get(){return this.streamController.liveSyncPosition}},{key:"subtitleTracks",get:function get(){var subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTracks:[]}},{key:"subtitleTrack",get:function get(){var subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTrack:-1},set:function set(subtitleTrackId){var subtitleTrackController=this.subtitleTrackController;subtitleTrackController&&(subtitleTrackController.subtitleTrack=subtitleTrackId)}},{key:"subtitleDisplay",get:function get(){var subtitleTrackController=this.subtitleTrackController;return!!subtitleTrackController&&subtitleTrackController.subtitleDisplay},set:function set(value){var subtitleTrackController=this.subtitleTrackController;subtitleTrackController&&(subtitleTrackController.subtitleDisplay=value)}}]),Hls}(Observer);hls_Hls.defaultConfig=void 0},"./src/polyfills/number.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"isFiniteNumber",(function(){return isFiniteNumber})),__webpack_require__.d(__webpack_exports__,"MAX_SAFE_INTEGER",(function(){return MAX_SAFE_INTEGER}));var isFiniteNumber=Number.isFinite||function(value){return"number"==typeof value&&isFinite(value)},MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/utils/get-self-scope.js":function(module,__webpack_exports__,__webpack_require__){"use strict";function getSelfScope(){return"undefined"==typeof window?self:window}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"getSelfScope",(function(){return getSelfScope}))},"./src/utils/logger.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"enableLogs",(function(){return enableLogs})),__webpack_require__.d(__webpack_exports__,"logger",(function(){return logger}));var _get_self_scope__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/utils/get-self-scope.js");function noop(){}var fakeLogger={trace:noop,debug:noop,log:noop,warn:noop,info:noop,error:noop},exportedLogger=fakeLogger;function formatMsg(type,msg){return msg="["+type+"] > "+msg}var global=Object(_get_self_scope__WEBPACK_IMPORTED_MODULE_0__.getSelfScope)();function consolePrintFn(type){var func=global.console[type];return func?function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];args[0]&&(args[0]=formatMsg(type,args[0])),func.apply(global.console,args)}:noop}var enableLogs=function enableLogs(debugConfig){if(global.console&&!0===debugConfig||"object"==typeof debugConfig){!function exportLoggerFunctions(debugConfig){for(var _len2=arguments.length,functions=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)functions[_key2-1]=arguments[_key2];functions.forEach((function(type){exportedLogger[type]=debugConfig[type]?debugConfig[type].bind(debugConfig):consolePrintFn(type)}))}(debugConfig,"debug","log","info","warn","error");try{exportedLogger.log()}catch(e){exportedLogger=fakeLogger}}else exportedLogger=fakeLogger},logger=exportedLogger}}).default}))}}]);
//# sourceMappingURL=vendors~proGallery_HlsPlayer.e7caa125.iframe.bundle.js.map